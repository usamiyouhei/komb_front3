<template>
  <div v-if="selectType === CALENDAR_TYPE.DISPLAY">
    <div>
      <h3>表示のみ</h3>
    </div>
    <div class="Content">
      <div class="CalendarContent">
        <div class="ButtonArea">
          <ButtonSimple
            class="mr-3"
            :backcolor="useColor(THEME_COLOR.primary)"
            text="前年"
            small
            @click="changeYear(-1)"
          />
          <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="前月" small @click="changeMonth(-1)" />
          <div class="Display">
            <p v-if="!isDisplay">{{ month }}</p>
          </div>
          <ButtonSimple
            class="mr-3"
            :backcolor="useColor(THEME_COLOR.primary)"
            text="次月"
            small
            @click="changeMonth(1)"
          />
          <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="次年" small @click="changeYear(1)" />
          <!-- <ButtonSimple class="mr-2" :backcolor="useColor(THEME_COLOR.error)" text="リセット" small @click="resetDate" /> -->
        </div>
        <div class="Calendar" :class="{ smallCalendar: small }">
          <div class="Weekly">
            <div v-for="i in 7" :key="i" class="DayOfWeek">
              {{ dayOfWeek(i - 1) }}
            </div>
          </div>
          <div v-for="(week, wkIndex) in calendars" :key="wkIndex" class="Weekly">
            <div
              v-for="(day, dayIndex) in week"
              :key="dayIndex"
              class="Daily"
              :class="{ OutSide: currentMonth !== day.month, smallDaily: small }"
            >
              <div
                class="Day"
                :class="{
                  Today: displayToday ? today === formatDate(`${day.month}-${day.date}`) : '',
                  smallDay: small,
                }"
              >
                <p>{{ day.date }}</p>
              </div>
              <div v-if="!small">
                <div v-for="(dayEvent, eventIndex) in day.dayEvents" :key="eventIndex">
                  <div class="Event" :style="`background-color: ${useColor(dayEvent.color)}`">
                    <p>{{ dayEvent.value }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div v-if="selectType === CALENDAR_TYPE.DAY_INPUT" class="InputContainer">
    <div>
      <p>inputから1日だけ選択</p>
      <p>モーダル開閉：{{ openSwitch }}</p>
      <p>選択した日付：{{ selectDate }}</p>
    </div>
    <div class="Content">
      <div class="InputContent">
        <div class="Input">
          <FormInput class="mr-3" :width="200" :edit="true" placeholder="日にちを選択" @click="onOpen(true)" />
        </div>
        <ClientOnly>
          <teleport to="#float-area">
            <PartsSystemMenu :switcher="openSwitch" :fixedMenuRect="fixedRect" :selectType="'calender'">
              <ButtonIcon
                class="Delete"
                icon="mdi-close"
                :backcolor="THEME_COLOR.surface"
                light
                @click="onOpen(false)"
              />
              <div class="InputCalendar">
                <div class="InputHeader" :class="{ smallHeader: small }">
                  <div class="ButtonArea">
                    <ButtonSimple
                      class="mr-3"
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="前年"
                      small
                      @click="changeYear(-1)"
                    />
                    <ButtonSimple
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="前月"
                      small
                      @click="changeMonth(-1)"
                    />
                    <div class="Display">
                      <p v-if="!isDisplay">{{ month }}</p>
                    </div>
                    <ButtonSimple
                      class="mr-3"
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="次月"
                      small
                      @click="changeMonth(1)"
                    />
                    <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="次年" small @click="changeYear(1)" />
                    <!-- <ButtonSimple class="mr-2" :backcolor="useColor(THEME_COLOR.error)" text="リセット" small @click="resetDate" /> -->
                  </div>
                </div>
                <div class="Calendar" :class="{ smallCalendar: small }">
                  <div class="Weekly">
                    <div class="DayOfWeek" v-for="i in 7" :key="i">{{ dayOfWeek(i - 1) }}</div>
                  </div>
                  <div class="Weekly" v-for="(week, wIndex) in calendars" :key="wIndex">
                    <div
                      class="Daily"
                      :class="{
                        OutSide: currentMonth !== day.month,
                        SelectDate: selectDate === formatDate(`${day.month}-${day.date}`),
                        smallDaily: small,
                      }"
                      :style="{ '--backColor': useColor(primaryColor) }"
                      v-for="(day, dIndex) in week"
                      :key="dIndex"
                      @click="selectDay(formatDate(`${day.month}-${day.date}`))"
                    >
                      <div
                        class="Day"
                        :class="{
                          Today: displayToday && !changeColor ? today === formatDate(`${day.month}-${day.date}`) : '',
                          smallDay: small,
                        }"
                      >
                        <p>{{ day.date }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </PartsSystemMenu>
          </teleport>
        </ClientOnly>
      </div>
    </div>
  </div>

  <div v-if="selectType === CALENDAR_TYPE.DAY_CALENDAR">
    <div>
      <!-- <h3>カレンダーから1日だけ選択</h3> -->
      <!-- <h5>選択した日付：{{ selectDate }}</h5> -->
    </div>
    <div class="Content">
      <div class="CalendarContent">
        <div class="ButtonArea">
          <ButtonSimple
            class="mr-3"
            :backcolor="useColor(THEME_COLOR.primary)"
            text="前年"
            small
            @click="changeYear(-1)"
          />
          <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="前月" small @click="changeMonth(-1)" />
          <div class="Display">
            <p v-if="!isDisplay">{{ month }}</p>
          </div>
          <ButtonSimple
            class="mr-3"
            :backcolor="useColor(THEME_COLOR.primary)"
            text="次月"
            small
            @click="changeMonth(1)"
          />
          <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="次年" small @click="changeYear(1)" />
          <!-- <ButtonSimple class="mr-2" :backcolor="useColor(THEME_COLOR.error)" text="リセット" small @click="resetDate" /> -->
        </div>
        <div class="Calendar" :class="{ smallCalendar: small }">
          <div class="Weekly">
            <div class="DayOfWeek" v-for="i in 7" :key="i">
              {{ dayOfWeek(i - 1) }}
            </div>
          </div>
          <div class="Weekly" v-for="(week, i) in calendars" :key="i">
            <div
              v-for="(day, w) in week"
              :key="w"
              class="Daily"
              :class="{
                OutSide: currentMonth !== day.month,
                smallDaily: small,
                SelectDate: selectDate === formatDate(`${day.month}-${day.date}`),
              }"
              :style="{ '--backColor': useColor(primaryColor) }"
              @click="selectDay(formatDate(`${day.month}-${day.date}`))"
            >
              <div
                class="Day"
                :class="{
                  smallDay: small,
                  Today: displayToday && !changeColor ? today === formatDate(`${day.month}-${day.date}`) : '',
                }"
              >
                <p>{{ day.date }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div v-if="selectType === CALENDAR_TYPE.PERIOD_INPUT" class="InputContainer">
    <div>
      <p>inputから期間を選択</p>
      <p>モーダル開閉：{{ openSwitch }}</p>
      <p>選択した日付：{{ startDay }} ~ {{ endDay }}</p>
    </div>
    <div class="Content">
      <div class="InputContent">
        <div class="Input">
          <FormInput class="mr-3" :width="200" :edit="true" placeholder="日にちを選択" @click="onOpen(true)" />
        </div>
        <ClientOnly>
          <teleport to="#float-area">
            <PartsSystemMenu :switcher="openSwitch" :fixedMenuRect="fixedRect" :selectType="'calender'">
              <ButtonIcon
                class="Delete"
                icon="mdi-close"
                :backcolor="THEME_COLOR.surface"
                light
                @click="onOpen(false)"
              />
              <div class="InputCalendar">
                <div class="InputHeader" :class="{ smallHeader: small }">
                  <div class="ButtonArea">
                    <ButtonSimple
                      class="mr-3"
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="前年"
                      small
                      @click="changeYear(-1)"
                    />
                    <ButtonSimple
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="前月"
                      small
                      @click="changeMonth(-1)"
                    />
                    <div class="Display">
                      <p v-if="!isDisplay">{{ month }}</p>
                    </div>
                    <ButtonSimple
                      class="mr-3"
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="次月"
                      small
                      @click="changeMonth(1)"
                    />
                    <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="次年" small @click="changeYear(1)" />
                    <!-- <ButtonSimple class="mr-2" :backcolor="useColor(THEME_COLOR.error)" text="リセット" small @click="resetDate" /> -->
                  </div>
                </div>
                <div class="Calendar" :class="{ smallCalendar: small }">
                  <div class="Weekly">
                    <div class="DayOfWeek" v-for="i in 7" :key="i">
                      {{ dayOfWeek(i - 1) }}
                    </div>
                  </div>
                  <div class="Weekly" v-for="(week, i) in calendars" :key="i">
                    <div
                      class="Daily"
                      :class="{
                        OutSide: currentMonth !== day.month,
                        SelectedPeriod: isSelectPeriod
                          ? isDateInSelectedPeriods(formatDate(`${day.month}-${day.date}`))
                          : false,
                        smallDaily: small,
                      }"
                      :style="{ '--backColor': useColor(primaryColor) }"
                      v-for="(day, w) in week"
                      :key="w"
                      @click="selectPeriod(formatDate(`${day.month}-${day.date}`))"
                    >
                      <div
                        class="Day"
                        :class="{
                          Today: displayToday && !changeColor ? today === formatDate(`${day.month}-${day.date}`) : '',
                          smallDay: small,
                        }"
                      >
                        <p>{{ day.date }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </PartsSystemMenu>
          </teleport>
        </ClientOnly>
      </div>
    </div>
  </div>

  <div v-if="selectType === CALENDAR_TYPE.PERIOD_CALENDAR">
    <div>
      <p>カレンダーから期間を選択</p>
      <p>選択した日付：{{ startDay }} ~ {{ endDay }}</p>
    </div>
    <div class="Content">
      <div class="CalendarContent">
        <div class="Header">
          <div class="ButtonArea">
            <ButtonSimple
              class="mr-3"
              :backcolor="useColor(THEME_COLOR.primary)"
              text="前年"
              small
              @click="changeYear(-1)"
            />
            <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="前月" small @click="changeMonth(-1)" />
            <div class="Display">
              <p v-if="!isDisplay">{{ month }}</p>
            </div>
            <ButtonSimple
              class="mr-3"
              :backcolor="useColor(THEME_COLOR.primary)"
              text="次月"
              small
              @click="changeMonth(1)"
            />
            <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="次年" small @click="changeYear(1)" />
            <!-- <ButtonSimple class="mr-2" :backcolor="useColor(THEME_COLOR.error)" text="リセット" small @click="resetDate" /> -->
          </div>
        </div>
        <div class="Calendar" :class="{ smallCalendar: small }">
          <div class="Weekly">
            <div class="DayOfWeek" v-for="i in 7" :key="i">
              {{ dayOfWeek(i - 1) }}
            </div>
          </div>
          <div class="Weekly" v-for="(week, i) in calendars" :key="i">
            <div
              class="Daily"
              :class="{
                OutSide: currentMonth !== day.month,
                SelectedPeriod: isSelectPeriod
                  ? isDateInSelectedPeriods(formatDate(`${day.month}-${day.date}`))
                  : false,
                smallDaily: small,
              }"
              :style="{ '--backColor': useColor(primaryColor) }"
              v-for="(day, w) in week"
              :key="w"
              @click="selectPeriod(formatDate(`${day.month}-${day.date}`))"
            >
              <div
                class="Day"
                :class="{
                  Today: displayToday && !changeColor ? today === formatDate(`${day.month}-${day.date}`) : '',
                  smallDay: small,
                }"
              >
                <p>{{ day.date }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div v-if="selectType === CALENDAR_TYPE.MULTI_DAYS_INPUT" class="InputContainer">
    <div>
      <p>inputから複数の日付を選択</p>
      <p>モーダル開閉：{{ openSwitch }}</p>
      <p>{{ openSwitch }}</p>
      <p>選択した日付：{{ selectDays }}</p>
    </div>
    <div class="Content">
      <div class="InputContent">
        <div class="Input">
          <FormInput class="mr-3" :width="200" placeholder="日にちを選択" :edit="true" @click="onOpen(true)" />
        </div>
        <ClientOnly>
          <teleport to="#float-area">
            <PartsSystemMenu :switcher="openSwitch" :fixedMenuRect="fixedRect" :selectType="'calender'">
              <ButtonIcon
                class="Delete"
                icon="mdi-close"
                :backcolor="THEME_COLOR.surface"
                light
                @click="onOpen(false)"
              />
              <div class="InputCalendar">
                <div class="InputHeader" :class="{ smallHeader: small }">
                  <div class="ButtonArea">
                    <ButtonSimple
                      class="mr-3"
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="前年"
                      small
                      @click="changeYear(-1)"
                    />
                    <ButtonSimple
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="前月"
                      small
                      @click="changeMonth(-1)"
                    />
                    <div class="Display">
                      <p v-if="!isDisplay">{{ month }}</p>
                    </div>
                    <ButtonSimple
                      class="mr-3"
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="次月"
                      small
                      @click="changeMonth(1)"
                    />
                    <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="次年" small @click="changeYear(1)" />
                    <!-- <ButtonSimple class="mr-2" :backcolor="useColor(THEME_COLOR.error)" text="リセット" small @click="resetDate" /> -->
                  </div>
                </div>
                <div class="Calendar" :class="{ smallCalendar: small }">
                  <div class="Weekly">
                    <div class="DayOfWeek" v-for="i in 7" :key="i">
                      {{ dayOfWeek(i - 1) }}
                    </div>
                  </div>
                  <div class="Weekly" v-for="(week, i) in calendars" :key="i">
                    <div
                      class="Daily"
                      :class="{
                        OutSide: currentMonth !== day.month,
                        SelectDate: isSelectDay(formatDate(`${day.month}-${day.date}`)),
                        smallDaily: small,
                      }"
                      :style="{ '--backColor': useColor(primaryColor) }"
                      v-for="(day, w) in week"
                      :key="w"
                      @click="selectMultipleDays(formatDate(`${day.month}-${day.date}`))"
                    >
                      <div
                        class="Day"
                        :class="{
                          Today: displayToday && !changeColor ? today === formatDate(`${day.month}-${day.date}`) : '',
                          smallDay: small,
                        }"
                      >
                        <p>{{ day.date }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </PartsSystemMenu>
          </teleport>
        </ClientOnly>
      </div>
    </div>
  </div>

  <div v-if="selectType === CALENDAR_TYPE.MULTI_DAYS_CALENDAR">
    <div>
      <p>カレンダーから複数の日付を選択</p>
      <p>選択した日付：{{ selectDays }}</p>
    </div>
    <div class="Content">
      <div class="CalendarContent">
        <div class="Header">
          <div class="ButtonArea">
            <ButtonSimple
              class="mr-3"
              :backcolor="useColor(THEME_COLOR.primary)"
              text="前年"
              small
              @click="changeYear(-1)"
            />
            <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="前月" small @click="changeMonth(-1)" />
            <div class="Display">
              <p v-if="!isDisplay">{{ month }}</p>
            </div>
            <ButtonSimple
              class="mr-3"
              :backcolor="useColor(THEME_COLOR.primary)"
              text="次月"
              small
              @click="changeMonth(1)"
            />
            <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="次年" small @click="changeYear(1)" />
            <!-- <ButtonSimple class="mr-2" :backcolor="useColor(THEME_COLOR.error)" text="リセット" small @click="resetDate" /> -->
          </div>
        </div>
        <div class="Calendar" :class="{ smallCalendar: small }">
          <div class="Weekly">
            <div class="DayOfWeek" v-for="i in 7" :key="i">
              {{ dayOfWeek(i - 1) }}
            </div>
          </div>
          <div class="Weekly" v-for="(week, i) in calendars" :key="i">
            <div
              class="Daily"
              :class="{
                OutSide: currentMonth !== day.month,
                SelectDate: isSelectDay(formatDate(`${day.month}-${day.date}`)),
                smallDaily: small,
              }"
              :style="{ '--backColor': useColor(primaryColor) }"
              v-for="(day, w) in week"
              :key="w"
              @click="selectMultipleDays(formatDate(`${day.month}-${day.date}`))"
            >
              <div
                class="Day"
                :class="{
                  Today: displayToday && !changeColor ? today === formatDate(`${day.month}-${day.date}`) : '',
                  smallDay: small,
                }"
              >
                <p>{{ day.date }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div v-if="selectType === CALENDAR_TYPE.PERMITTED_INPUT" class="InputContainer">
    <div>
      <p>許可された日をinputから選択</p>
      <p>{{ openSwitch }}</p>
      <p>許可された日付：{{ permittedDate }}</p>
      <p>選択した日付：{{ selectDays }}</p>
    </div>
    <div class="Content">
      <div class="InputContent">
        <div class="Input">
          <FormInput class="mr-3" :width="200" placeholder="日にちを選択" :edit="true" @click="onOpen(true)" />
        </div>
        <ClientOnly>
          <teleport to="#float-area">
            <PartsSystemMenu :switcher="openSwitch" :fixedMenuRect="fixedRect" :selectType="'calender'">
              <ButtonIcon
                class="Delete"
                icon="mdi-close"
                :backcolor="THEME_COLOR.surface"
                light
                @click="onOpen(false)"
              />
              <div class="InputCalendar">
                <div class="InputHeader" :class="{ smallHeader: small }">
                  <div class="ButtonArea">
                    <ButtonSimple
                      class="mr-3"
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="前年"
                      small
                      @click="changeYear(-1)"
                    />
                    <ButtonSimple
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="前月"
                      small
                      @click="changeMonth(-1)"
                    />
                    <div class="Display">
                      <p v-if="!isDisplay">{{ month }}</p>
                    </div>
                    <ButtonSimple
                      class="mr-3"
                      :backcolor="useColor(THEME_COLOR.primary)"
                      text="次月"
                      small
                      @click="changeMonth(1)"
                    />
                    <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="次年" small @click="changeYear(1)" />
                    <!-- <ButtonSimple class="mr-2" :backcolor="useColor(THEME_COLOR.error)" text="リセット" small @click="resetDate" /> -->
                  </div>
                </div>
                <div class="Calendar" :class="{ smallCalendar: small }">
                  <div class="Weekly">
                    <div class="DayOfWeek" v-for="i in 7" :key="i">
                      {{ dayOfWeek(i - 1) }}
                    </div>
                  </div>
                  <div class="Weekly" v-for="(week, i) in calendars" :key="i">
                    <div
                      class="Daily"
                      :class="{
                        SelectDate: isSelectDay(formatDate(`${day.month}-${day.date}`)),
                        NotParmittedDate: !checkPermittedDate(formatDate(`${day.month}-${day.date}`)),
                        smallDaily: small,
                      }"
                      :style="{ '--backColor': useColor(primaryColor) }"
                      v-for="(day, w) in week"
                      :key="w"
                      @click="
                        checkPermittedDate(formatDate(`${day.month}-${day.date}`))
                          ? selectMultipleDays(formatDate(`${day.month}-${day.date}`))
                          : false
                      "
                    >
                      <div
                        class="Day"
                        :class="{
                          Today: displayToday && !changeColor ? today === formatDate(`${day.month}-${day.date}`) : '',
                          smallDay: small,
                        }"
                      >
                        <p>{{ day.date }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </PartsSystemMenu>
          </teleport>
        </ClientOnly>
      </div>
    </div>
  </div>

  <div v-if="selectType === CALENDAR_TYPE.PERMITTED_CALENDAR">
    <div>
      <p>許可された日をカレンダーから選択</p>
      <p>許可された日付：{{ permittedDate }}</p>
      <p>選択した日付：{{ selectDays }}</p>
    </div>
    <div class="Content">
      <div class="CalendarContent">
        <div class="Header">
          <div class="ButtonArea">
            <ButtonSimple
              class="mr-3"
              :backcolor="useColor(THEME_COLOR.primary)"
              text="前年"
              small
              @click="changeYear(-1)"
            />
            <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="前月" small @click="changeMonth(-1)" />
            <div class="Display">
              <p v-if="!isDisplay">{{ month }}</p>
            </div>
            <ButtonSimple
              class="mr-3"
              :backcolor="useColor(THEME_COLOR.primary)"
              text="次月"
              small
              @click="changeMonth(1)"
            />
            <ButtonSimple :backcolor="useColor(THEME_COLOR.primary)" text="次年" small @click="changeYear(1)" />
            <!-- <ButtonSimple class="mr-2" :backcolor="useColor(THEME_COLOR.error)" text="リセット" small @click="resetDate" /> -->
          </div>
        </div>
        <div class="Calendar" :class="{ smallCalendar: small }">
          <div class="Weekly">
            <div class="DayOfWeek" v-for="i in 7" :key="i">
              {{ dayOfWeek(i - 1) }}
            </div>
          </div>
          <div class="Weekly" v-for="(week, i) in calendars" :key="i">
            <div
              class="Daily"
              :class="{
                SelectDate: isSelectDay(formatDate(`${day.month}-${day.date}`)),
                NotParmittedDate: !checkPermittedDate(formatDate(`${day.month}-${day.date}`)),
                smallDaily: small,
              }"
              :style="{ '--backColor': useColor(primaryColor) }"
              v-for="(day, w) in week"
              :key="w"
              @click="
                checkPermittedDate(formatDate(`${day.month}-${day.date}`))
                  ? selectMultipleDays(formatDate(`${day.month}-${day.date}`))
                  : false
              "
            >
              <div
                class="Day"
                :class="{
                  Today: displayToday && !changeColor ? today === formatDate(`${day.month}-${day.date}`) : '',
                  smallDay: small,
                }"
              >
                <p>{{ day.date }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
/**===================================================================================================================
   ===================================================================================================================**/
import dayjs from 'dayjs'
import { THEME_COLOR } from '../../composables/constants'
import {
  defaultBase,
  FORM_MODE,
  type baseProps,
  DATE_FORMAT,
  type EventItem,
  type DateItem,
  CALENDAR_TYPE,
  type FixedSize,
} from '../../components/common'
import { useColor } from '../../composables/colors'
import { ref, watch, onMounted, type Ref, computed } from 'vue'
import type { ModalSwitch } from '../../types'

//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  selectType: string
  events?: any
  fixedSize?: FixedSize
  permittedDate?: string[]
  displayToday?: boolean
  isDisplay?: boolean
  clickReset?: boolean
  small?: boolean
  date?: string
  periodStart?: number
  periodEnd?: number
}

const props = withDefaults(defineProps<Props>(), {
  events: [],
  date: dayjs().format('YYYY-MM-DD'),
  clickReset: true,
})
//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
// 一番新しく選択した日
const currentDate = ref(dayjs(props.date))
// 今日の日時
const todayTime = ref(dayjs())
// １日だけ選択した日
const selectDate = ref(props.date)
// 選択した期間
const selectPeriods = ref<string[]>([])
// 選択した期間の始まりの日
const startDay = ref()
// 選択した期間の終わりの日
const endDay = ref()
// 選択した期間に色を付けるフラグ
const isSelectPeriod = ref(false)
// 複数選択した日
const selectDays = ref<string[]>([])
// 選択を許可された日
const permittedDate = ref<string[] | undefined>(props.permittedDate)
// 許可された期間
const periodYearStart = ref(props.periodStart)
const periodYearEnd = ref(props.periodEnd)
// 選択時のカラー
const primaryColor = THEME_COLOR.primary
// カレンダーの開閉
const openSwitch: Ref<ModalSwitch> = ref({ opened: false })
// イベント情報
const events = ref<EventItem[]>(props.events)
const resetDoubleClick = ref(props.clickReset)
const fixedRect = ref({
  justify: props.fixedSize?.justify || 'flex-end',
  align: props.fixedSize?.align || 'flex-start',
  offsetX: computed(() => {
    if (props.small) {
      return '-250px'
    }
    return props.fixedSize?.offsetX || '-300px'
  }),
  offsetY: computed(() => {
    if (props.small) {
      return '280px'
    }
    return props.fixedSize?.offsetY || '200px'
  }),
  width: computed(() => {
    if (props.small) {
      return '260px'
    }
    return props.fixedSize?.width || '380px'
  }),
  height: computed(() => {
    if (props.small) {
      return '340px'
    }
    return props.fixedSize?.height || '450px'
  }),
})
//------------------------------------------------------------------------------------------------------------
// emits
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:date', date: string): void
  (e: 'update:month', month: any): void
  (e: 'update:year', year: any): void
}>()
//------------------------------------------------------------------------------------------------------------
// computed
//------------------------------------------------------------------------------------------------------------
// カレンダーの配列を取得
const calendars = computed(() => getCalendar())
// カレンダーに表示する日付を取得
const today = computed(() => formatDate(todayTime.value))
const month = computed(() => formatDate(currentDate.value, DATE_FORMAT.yymm_jp))
// 月の背景色を判別
const currentMonth = computed(() => formatDate(currentDate.value, DATE_FORMAT.yymm))

// 今日の日付が選択されたとき色を変える
const changeColor = ref(onColor(props.date))
//------------------------------------------------------------------------------------------------------------
// watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.events,
  (value) => {
    events.value = value
  },
  { deep: true }
)

watch(
  () => props.permittedDate,
  (value) => {
    permittedDate.value = value
  },
  { deep: true }
)

watch(
  () => props.date,
  (value) => {
    selectDate.value = value
    // console.log(selectDate.value)
    if (!value) return
    currentDate.value = dayjs(value)
    if (selectDate.value === today.value) {
      changeColor.value = true
    }
  }
)

watch(selectDate, (newDate) => {
  if (newDate === today.value) {
    changeColor.value = true
  } else {
    changeColor.value = false
  }
  emits('update:date', newDate)
})
//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onMounted(() => {
  getCalendar()
})
//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function onColor(value: string) {
  if (value === today.value) {
    return true
  } else {
    return false
  }
}

// フォーマットを整える
function formatDate(date: string | dayjs.Dayjs, format: string = DATE_FORMAT.default) {
  let formattedDate = ''
  if (format === DATE_FORMAT.default) {
    formattedDate = dayjs(date).format('YYYY-MM-DD')
  } else if (format === DATE_FORMAT.yymm) {
    formattedDate = dayjs(date).format('YYYY-MM')
  } else if (format === DATE_FORMAT.yymmdd_jp) {
    formattedDate = dayjs(date).format('YYYY[年]MM[月]DD[日]')
  } else if (format === DATE_FORMAT.yymm_jp) {
    formattedDate = dayjs(date).format('YYYY[年]MM[月]')
  }
  return formattedDate
}

// 曜日を判別
function dayOfWeek(dayIndex: number): string {
  const week = ['日', '月', '火', '水', '木', '金', '土']
  return week[dayIndex]
}

// カレンダーの最初の日を取得
function getStartDate(): dayjs.Dayjs {
  const date = dayjs(currentDate.value).startOf('month')
  // 月の初めの日から土曜日までの差を算出し、日曜日の日を取得
  return date.subtract(date.day(), 'days')
}

// カレンダーの最後の日を取得
function getEndDate(): dayjs.Dayjs {
  const date = dayjs(currentDate.value).endOf('month')
  // 月の初めの日から土曜日までの差を算出し、土曜日を取得
  return date.add(6 - date.day(), 'days')
}

// カレンダーの縦軸を計算
function getWeekCount() {
  return Math.ceil(getEndDate().diff(getStartDate(), 'days') / 7)
}

// カレンダーの情報を取得
function getCalendar() {
  const calendars: DateItem[][] = []
  let calendarDate = getStartDate()

  // 7日分の日にちデータをループで取得してweekRow>calendarsにプッシュ。
  // それをカレンダーの縦軸数繰り返す処理
  for (let week = 0; week < getWeekCount(); week++) {
    const weekRow = []
    for (let day = 0; day < 7; day++) {
      weekRow.push({
        date: calendarDate.get('date'),
        month: formatDate(calendarDate, DATE_FORMAT.yymm),
        dayEvents: getDayEvents(calendarDate),
      })
      calendarDate = calendarDate.add(1, 'days')
    }
    calendars.push(weekRow)
  }
  return calendars
}

// カレンダーの月を変更
function changeMonth(num: number) {
  currentDate.value = dayjs(currentDate.value).add(num, 'month')
  selectDate.value = currentDate.value.format('YYYY-MM-DD')
  emits('update:month', currentDate.value.month())
}

function changeYear(num: number) {
  currentDate.value = dayjs(currentDate.value).add(num, 'year')
  selectDate.value = currentDate.value.format('YYYY-MM-DD')
  emits('update:year', currentDate.value.year())
}

// イベント情報を配列から取得
function getDayEvents(date: dayjs.Dayjs) {
  return events.value.filter((event: EventItem) => {
    const eventStart = dayjs(event.start)
    const eventEnd = dayjs(event.end)
    return (date.isSame(eventStart) || date.isAfter(eventStart)) && (date.isSame(eventEnd) || date.isBefore(eventEnd))
  })
}

// モーダルの開閉
function onOpen(open: boolean) {
  openSwitch.value.opened = open
}

// 選択した日を配列に代入
function selectDay(date: string) {
  if (props.small && date === today.value) {
    changeColor.value = true
  } else {
    changeColor.value = false
  }
  if (resetDoubleClick.value) {
    if (selectDate.value === date) {
      selectDate.value = ''
      return
    }
  }
  // console.log(date)
  const parts = date.split('-')
  if (periodYearStart.value) {
    if (parseInt(parts[0]) < periodYearStart.value) {
      parts[0] = periodYearStart.value.toString()
    }
    // console.log(parts[0])
  } else if (periodYearEnd.value) {
    if (parseInt(parts[0]) > periodYearEnd.value) {
      parts[0] = periodYearEnd.value.toString()
    } else {
      parts[0] = '1970'
    }
  }
  if (parseInt(parts[1]) < 1) {
    parts[1] = '01'
  }
  if (parseInt(parts[2]) < 1) {
    parts[2] = '01'
  }
  selectDate.value = formatDate(`${parts[0]}-${parts[1]}-${parts[2]}`)
}

// 期間の選択
function selectPeriod(date: string) {
  // 期間の最初と最後だけ取得したのでそれ以上は空に戻す
  if (!isSelectPeriod.value || selectPeriods.value.length >= 2) {
    selectPeriods.value = []
    isSelectPeriod.value = true
  }

  if (props.small && date === today.value) {
    changeColor.value = true
  } else {
    changeColor.value = false
  }

  selectPeriods.value.push(formatDate(date))

  if (selectPeriods.value.length === 2) {
    changeColor.value = true
    isDateInSelectedPeriods(formatDate(date))
  }
}

// 選択された期間を判別してカレンダーに色を付与
function isDateInSelectedPeriods(date: string): boolean {
  if (selectPeriods.value.length !== 2) {
    return selectPeriods.value.includes(formatDate(date))
  }

  const start = dayjs(selectPeriods.value[0])
  const end = dayjs(selectPeriods.value[1])
  const current = dayjs(formatDate(date))

  if (start.isBefore(end) || start.isSame(end)) {
    startDay.value = formatDate(start)
    endDay.value = formatDate(end)
    return (current.isAfter(start) || current.isSame(start)) && (current.isBefore(end) || current.isSame(end))
  } else {
    startDay.value = formatDate(end)
    endDay.value = formatDate(start)
    return (current.isAfter(end) && current.isBefore(start)) || current.isSame(end) || current.isSame(start)
  }
}

// 選択された複数の日を配列に格納する
function selectMultipleDays(date: string) {
  if (selectDays.value.includes(date)) {
    if (props.small && date === today.value) {
      changeColor.value = !changeColor.value
    }
    const index = selectDays.value.indexOf(date)
    selectDays.value.splice(index, 1)
    return
  }

  if (props.small && date === today.value) {
    changeColor.value = true
  }
  selectDays.value.push(formatDate(date))
}

// 選択された日が配列内にあるかをチェック
function isSelectDay(date: string): boolean {
  return selectDays.value.includes(formatDate(date))
}

// 選択された期間が配列内にあるかをチェック
function checkPermittedDate(date: string) {
  if (permittedDate.value) {
    return permittedDate.value.includes(formatDate(date))
  }
}

// すべての値をリセット
function resetDate() {
  startDay.value = ''
  endDay.value = ''
  selectDate.value = dayjs('1970-01-01').format('YYYY-MM-DD')
  selectDays.value = []
  isSelectPeriod.value = false
}
</script>

<style scoped>
@charset "UTF-8";
/* 共通設定 */
.Content {
  width: 250px;
  height: 300px;
  margin-top: 5px;
}

.InputContent,
.CalendarContent,
.Calendar {
  margin: 0 auto;
}

.Display {
  height: 25px;
  line-height: 25px;
  font-size: 10px;
  text-align: center;
  width: 65px;
}

.ButtonArea {
  height: 25px;
  line-height: 25px;
  display: flex;
  justify-content: space-between;
}

.Calendar,
.smallCalendar {
  border-top: 1px solid #e0e0e0;
  font-size: 12px;
  margin-top: 10px;
}

.Weekly {
  display: flex;
  border-left: 1px solid #e0e0e0;
}

.DayOfWeek,
.Daily {
  flex: 1;
  border-right: 1px solid #e0e0e0;
}

.DayOfWeek {
  background-color: #e7e7e7;
  text-align: center;
}

.Daily {
  position: relative;
  min-height: 60px;
  border-bottom: 1px solid #e0e0e0;
}

/* Inputカレンダーの設定 */
.InputContainer {
  height: 120px;
}

.Input {
  display: flex;
  justify-content: center;
}

.InputHeader {
  line-height: 60px;
}

.InputCalendar {
  position: absolute;
  top: 30px;
  left: 5px;
}

.Delete {
  position: absolute;
  top: 0;
  right: 0;
  font-size: 20px;
  cursor: pointer;
}

/* 変動するクラス設定 */
.OutSide {
  background-color: #f8f8f8;
  color: #ccc;
}

.SelectDate,
.SelectedPeriod {
  background-color: var(--backColor);
  color: #fff;
}

.Today::after {
  position: absolute;
  content: "";
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: 2px solid #44bdf9;
}

.NotParmittedDate {
  background-color: gray;
}

.smallCalendar {
  width: 250px;
  margin-top: 5px;
}

.smallDaily {
  min-height: 33px;
}

.smallDay {
  text-align: center;
  line-height: 39px;
}

.smallHeader {
  line-height: 30px;
}

.smallMonth {
  font-size: 15px;
  margin-top: 20px;
}
</style>
