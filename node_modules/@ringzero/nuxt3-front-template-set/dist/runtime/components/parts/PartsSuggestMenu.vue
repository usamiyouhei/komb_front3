<template>
  <div class="SelectMenu" :style="{ width: width + 'px' }">
    <div class="InputArea" ref="InputArea" @mousedown="onShowSelect">
      <slot>
        <div v-if="inputType === SELECT_INPUT_TYPE.INPUT" class="ArrowContainer">
          <FormInput
            class="IconRight"
            :value="input"
            :edit="disabled ? false : true"
            :mode="FORM_MODE.SIMPLE"
            :width="width"
            :placeholder="placeholder"
            :disabled="disabled"
            :error="error"
            :is-parts="true"
            @update:value="onInputChange($event)"
            @update:focus="onInputChange($event)"
            @update:blur="onCheck($event)"
          />
          <ButtonArrow
            v-if="!disabled"
            class="FloatArrow"
            :color="useColor(THEME_COLOR.color)"
            :backcolor="useColor(THEME_COLOR.primary)"
            :after-icon="'mdi-chevron-down'"
            :actived="isShowSelect"
            icon
            light
            :disabled="disabled"
            :width="26"
          />
        </div>
      </slot>
    </div>
    <div v-if="initialize">
      <div v-show="isShowSelect">
        <div
          ref="FloatCard"
          class="FloatCard"
          :class="{
            Top: layout === POSITION.TOP,
          }"
          :style="{
            /*
              left: rect ? rect.left + 2 + 'px' : 0,

              */
            top: rect
              ? layout === POSITION.TOP
                ? height
                  ? 0 - height - 2 + 'px'
                  : 0 - 36 * (inputItems ? inputItems.length : 0) - 22 + 'px'
                : 0 + rect.height + 2 + 'px'
              : 0,
            width: fit && rect ? rect.width - 4 + 'px' : undefined,
            minWidth: minfit && rect ? rect.width - 4 + 'px' : undefined,
            maxWidth: fit && rect ? rect.width - 4 + 'px' : undefined,
            height: height ? height + 'px' : undefined,
            padding: selectType === SELECT_LIST_TYPE.DEFAULT ? '10px 0' : '10px',
            zIndex: 10000,
          }"
        >
          <template v-if="inputItems && inputItems.length > 0">
            <ButtonListSet :items="suggestItems" :value="input" :color="backcolor" @update:value="onChange($event)" />
          </template>
          <template v-else>
            <div class="notSelectData">選択項目がありません</div>
          </template>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
/**
 * Selectメニューのラッパー
 **/
import { POSITION, THEME_COLOR } from '../../composables/constants'
import {
  FORM_MODE,
  SELECT_INPUT_TYPE,
  SELECT_LIST_TYPE,
  LISTBUTTON_TYPE,
  type ListButtonProps,
} from '../../components/common'
import { ref, watch, type Ref, onBeforeUnmount, onMounted } from 'vue'
import { useColor, useGetThemeColor } from '../../composables/colors'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  items?: any[]
  value: string | undefined
  text?: string
  placeholder?: string
  inputType?: SELECT_INPUT_TYPE
  selectType?: SELECT_LIST_TYPE
  color?: string
  backcolor?: string
  placeholderColor?: string
  width?: number
  height?: number
  layout?: POSITION
  fit?: boolean
  minfit?: boolean
  disabled?: boolean
  error?: string
  noNewLink?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  inputType: SELECT_INPUT_TYPE.TEXT,
  selectType: SELECT_LIST_TYPE.DEFAULT,
  color: '#fff',
  height: 0,
  backcolor: THEME_COLOR.primary,
  placeholder: '入力してください',
  placeholderColor: '#999',
})

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const isShowSelect = ref(false)
const input = ref(props.value)
const InputArea: Ref<HTMLDivElement | null> = ref(null)
const FloatCard: Ref<HTMLDivElement | null> = ref(null)
const rect: Ref<DOMRect | null> = ref(null)
const initialize = ref(false)
const inputItems = ref(props.items)
const suggestItems: Ref<ListButtonProps[]> = ref([])

//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onMounted(() => {
  window.addEventListener('resize', onGetPosition)
  initialize.value = true
  setSuggestMenu('')
})

onBeforeUnmount(() => {
  window.removeEventListener('resize', onGetPosition)
  checkListener(false)
})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.value,
  (value) => {
    input.value = value
  }
)

watch(
  () => props.items,
  (value) => {
    inputItems.value = value
  },
  {
    immediate: true,
    deep: true,
  }
)

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', item: any): void
  (e: 'update:suggestCreate', status: string): void
}>()

function onInputChange(value: any) {
  isShowSelect.value = true
  setSuggestMenu(value)
  if (value) {
    input.value = value
    // emits('update:value', value)
  }
}

function onCheck(value: any) {
  input.value = value
  emits('update:value', value)
}

function setSuggestMenu(value: string) {
  if (inputItems.value) {
    suggestItems.value = inputItems.value.filter((item) => item.text.includes(value))
  }
  if (props.noNewLink) {
    if (suggestItems.value.length === 0 || value === '') {
      suggestItems.value = [{ value: 'manyItems', type: LISTBUTTON_TYPE.DISABLED, text: '入力してください' }]
    } else if (suggestItems.value.length > 100) {
      suggestItems.value = [{ value: 'manyItems', text: '候補が多すぎます', type: LISTBUTTON_TYPE.DISABLED }]
    }
  } else {
    if (suggestItems.value.length === 0 || value === '') {
      suggestItems.value = [
        { value: 'manyItems', type: LISTBUTTON_TYPE.DISABLED, text: '入力してください' },
        {
          value: 'setupItem',
          text: '新規追加',
          type: LISTBUTTON_TYPE.LINK,
        },
      ]
    } else if (suggestItems.value.length > 100) {
      suggestItems.value = [
        { value: 'manyItems', text: '候補が多すぎます', type: LISTBUTTON_TYPE.DISABLED },
        { value: 'setupItem', text: '新規追加', type: LISTBUTTON_TYPE.LINK },
      ]
    } else {
      suggestItems.value.push({
        value: 'setupItem',
        text: '新規追加',
        type: LISTBUTTON_TYPE.LINK,
      })
    }
  }
}

function onChange(value: any) {
  if (value === 'manyItems') {
    // 何もしない
  } else if (value === 'setupItem') {
    emits('update:suggestCreate', 'new')
    setTimeout(() => {
      isShowSelect.value = false
    }, 32)
  } else {
    const str = getItemText(value)
    input.value = str
    checkListener(false)
    emits('update:value', str)
    setTimeout(() => {
      isShowSelect.value = false
    }, 32)
  }
}

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------

async function onShowSelect() {
  if (props.disabled) return
  isShowSelect.value = !isShowSelect.value
  checkListener(isShowSelect.value)
  onGetPosition()
  //スクロール位置を調整する
  // console.log('スクロール位置を調整する')
  await FloatCard.value
  if (FloatCard.value) {
    const cardRect = FloatCard.value.getBoundingClientRect()
    const innerH = FloatCard.value.scrollHeight
    const index = inputItems.value?.findIndex((item) => item.value === input.value)
    if (index && index > 0) {
      FloatCard.value.scrollTop = index * 30
      //ここではsmall設定は無いので、30pxで統一
      // console.log('ある？', cardRect, innerH, index, props.items, input.value)
    }
  }
}

function onGetPosition() {
  if (InputArea.value) {
    rect.value = InputArea.value.getBoundingClientRect()
  }
}

function getItemText(value: any, placeholder: boolean = true) {
  if (inputItems.value) {
    const item = inputItems.value.find((item) => item.value === value)
    return item ? item.text : placeholder ? props.placeholder : ''
  }
  return placeholder ? props.placeholder : ''
}

function checkListener(isShow: boolean) {
  if (isShow) {
    setTimeout(() => {
      document.addEventListener('mousedown', onClickOutside)
    }, 16)
  } else {
    document.removeEventListener('mousedown', onClickOutside)
  }
}

function onClickOutside(event: MouseEvent) {
  if (FloatCard.value) {
    if (!FloatCard.value.contains(event.target as Node)) {
      // 領域外でのクリックを感知した場合の処理
      isShowSelect.value = false
      checkListener(false)
    }
  }
}
</script>
<style scoped>
.SelectMenu {
  position: relative;
  width: 100%;
}

.ArrowContainer {
  position: relative;
  width: 100%;
}

.FloatArrow {
  position: absolute !important;
  top: 5px;
  right: 4px;
}

.FloatCard {
  position: absolute;
  background-color: rgb(var(--r-color-form));
  pointer-events: auto;
  border-radius: 0px 0px 4px 4px;
  border: 1px solid rgb(var(--r-color-line));
  padding: 10px;
  box-shadow: 1px 1px 2px 0 rgba(25, 25, 25, 0.2) !important;
  overflow-y: auto;
  overflow-x: hidden;
}
.FloatCard.Top {
  border-radius: 4px 4px 0 0;
}

.Text {
  cursor: pointer;
}

.v-enter-active {
  transition: opacity 0.2s ease;
}

.v-leave-active {
  transition: opacity 0.2s ease;
}

.v-enter-from,
.v-leave-to {
  opacity: 0;
}

.IconRight ::v-deep(.Input) {
  padding-right: 30px !important;
}

.notSelectData {
  font-size: 14px;
  padding: 0 10px;
  color: rgba(var(--r-color-disabled));
}

.StretchIcon {
  position: relative;
  border-radius: 4px;
  border: 1px solid rgb(var(--r-color-line));
  width: 100%;
  height: 36px;
}
.StretchIcon .Text {
  position: absolute;
  top: 8px;
  left: 6px;
  width: calc(100% - 50px);
  font-size: 14px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.StretchIcon .Button {
  position: absolute;
  top: 4px;
  right: 1px;
}
</style>
