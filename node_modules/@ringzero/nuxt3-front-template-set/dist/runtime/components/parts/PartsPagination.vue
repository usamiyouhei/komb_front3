<template>
  <div class="Pagination" ref="Pagination">
    <v-pagination
      class="Inner"
      ref="PaginationInner"
      :model-value="pageNum"
      :length="pageMaxNum ? pageMaxNum : nowLength"
      :color="useColor(THEME_COLOR.primary)"
      :total-visible="viewLength"
      density="comfortable"
      @update:model-value="onChange"
    >
      <template #item="{ isActive, key, page: pageNumber, props: record }">
        <PartsPageButton :isActive="isActive" :itemKey="key" :page="pageNumber" :record="record" :length="nowLength" />
      </template>
    </v-pagination>
  </div>
</template>

<script setup lang="ts">
/**===================================================================================================================
   :style="{ left: left + 'px', transition: 'left 0.3s ease' }"
   * ページネーション
   * 親の幅に合わせて、表示数が変わるページネーション
   ===================================================================================================================**/
import { THEME_COLOR } from '../../composables/constants'
import { ref, watch, type Ref, onMounted, onBeforeUnmount, onBeforeMount } from 'vue'
import { useDelay } from '../../composables/utility'
import { useColor } from '../../composables/colors'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  page?: number
  length?: number
  pageMax?: number
}

const props = withDefaults(defineProps<Props>(), {
  page: 1,
  length: 0,
  pageMax: 0,
})

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const pageNum = ref(props.page)
const Pagination: Ref<HTMLDivElement | null> = ref(null)
const PaginationInner: Ref<any | null> = ref(null)

const rect: Ref<DOMRect | null> = ref(null)
const viewLength = ref(3)
const left = ref(0)
const nowLength = ref(props.length)
const pageMaxNum = ref(props.pageMax)

//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onBeforeMount(() => {
  //記憶した位置、サイズでの復帰を可能にする
})

onMounted(() => {
  window.addEventListener('resize', onGetPosition, { passive: true })
  onGetPosition()
})

onBeforeUnmount(() => {
  window.removeEventListener('resize', onGetPosition)
})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.page,
  (value) => {
    pageNum.value = value
  }
)

watch(
  () => props.length,
  (value) => {
    nowLength.value = value
    onGetPosition()
  }
)

watch(
  () => props.pageMax,
  (value) => {
    pageMaxNum.value = value
    onGetPosition()
  }
)

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------

const emits = defineEmits<{ (e: 'update:value', item: number): void }>()

function onChange(value: number) {
  pageNum.value = value
  emits('update:value', value)
}

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
const delay = useDelay()
async function onGetPosition() {
  if (Pagination.value && PaginationInner.value?.$el) {
    rect.value = Pagination.value.getBoundingClientRect()
    const cellSize = 44
    if (rect.value.width < cellSize * 7) {
      viewLength.value = 1
    } else {
      const count = Math.floor((rect.value.width - cellSize * 3) / cellSize)
      viewLength.value = count
    }
    await delay.wait(60)
    const inner: DOMRect = PaginationInner.value?.$el.getBoundingClientRect()
    if (inner) {
      left.value = (Math.floor(rect.value.width) - inner.width) / 2
    }
  }
}
</script>

<style scoped>
.Pagination {
  position: relative;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.3s ease;
}
.Pagination .Inner {
  position: relative;
  /*
    ::v-deep(.v-btn::after) {
      // background-color: rgb(var(--r-color-primary)) !important;
    }

    ::v-deep(.v-btn__content) {
      // color: rgb(var(--r-color-color)) !important;
    }
    */
}
.Pagination .Inner ::v-deep(.v-pagination__prev),
.Pagination .Inner ::v-deep(.v-pagination__item),
.Pagination .Inner ::v-deep(.v-pagination__next) {
  margin: 0 2px !important;
}
.Pagination .Inner ::v-deep(.v-pagination__item--is-active) .v-btn__overlay {
  background-color: rgb(var(--r-color-primary)) !important;
  opacity: 1 !important;
}
.Pagination .Inner ::v-deep(.v-pagination__item--is-active) .v-btn__content {
  color: rgb(var(--r-color-reverse)) !important;
  z-index: 1;
}
</style>
