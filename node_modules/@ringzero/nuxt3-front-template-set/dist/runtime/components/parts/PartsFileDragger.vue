<template>
  <div v-if="type === FILE_UPLOAD_TYPE.SINGLE" class="Wrapper">
    <!-- File Name && Delete Icon Container-->
    <div v-if="isShowInputBar" class="FileContent">
      <!-- Label -->
      <label
        v-if="isEdit"
        for="FileNameInput"
        class="FileNameText"
        :style="{ backgroundColor: useGetThemeColor(THEME_COLOR.primary) }"
      >
        ファイル
      </label>
      <label
        v-else
        for="FileNameInput"
        class="FileNameText"
        :style="{ backgroundColor: useGetThemeColor(THEME_COLOR.disabled) }"
      >
        ファイル
      </label>

      <!-- Name && ICON -->
      <div class="ContentInput">
        <input type="text" class="FileNameInput" :value="input" />
        <button class="DeleteBtn" @click="onDeleteImage">
          <v-icon :icon="'mdi-close'" class="DeleteIcon" :style="{ color: useGetThemeColor(THEME_COLOR.primary) }" />
        </button>
      </div>
    </div>

    <!-- File Upload Preview Container -->
    <div class="FileUpload">
      <div
        class="FileUploadInner"
        @dragenter="onDragEnter"
        @dragleave="onDragLeave"
        @dragover="onDragOver"
        @drop="onDrop"
        :isDragging="isDragging"
      >
        <!-- ファイル選択 Button -->
        <label
          v-if="isEdit"
          class="FileUploadBtn"
          :style="{ color: color, backgroundColor: useGetThemeColor(THEME_COLOR.primary) }"
          ><input
            v-if="isEdit"
            type="file"
            class="File"
            :accept="acceptTypes?.join(',')"
            @change="onContentImageChange"
            :disabled="!isEdit"
          />
          ファイル選択
        </label>

        <!-- input Fileの見た目 DIYするため CSSにDisplay:none設定  -->
        <p v-if="isEdit">
          ドラッグ&ドロップ<br />
          またはクリックでファイルを選択
        </p>

        <!-- Preview 内容表示区域 (URL以外) -->
        <div v-if="contentFile || isDragging" class="PreviewContentWrapper">
          <!-- <img class="ImgFile" :src="contentImageUrl" alt="Thumbnail" /> -->
          <div class="PreviewContent" v-if="contentFile && isImageFile(contentFile) && contentImageUrl">
            <img class="ImgFile" :src="contentImageUrl" alt="Thumbnail" />
          </div>
          <div class="PreviewContent" v-else-if="contentFile && isVideoFile(contentFile)">
            <video class="VideoFile" :src="contentVideoUrl" controls></video>
          </div>
          <div
            class="PreviewContent"
            v-else-if="contentFile && isAudioFile(contentFile)"
            style="background-color: lightgray"
          >
            <audio class="AudioFile" :src="contentAudioUrl" controls></audio>
          </div>
          <div class="PreviewContent" v-else>
            <div v-if="contentFile" class="OtherTypeFile">
              <v-icon
                v-if="getFileIcon(contentFile.type)"
                :icon="getFileIcon(contentFile.type)"
                class="OtherTypeFileIcon"
                :style="{ color: useGetThemeColor(THEME_COLOR.color) }"
              />
            </div>
          </div>
        </div>

        <!-- Preview 内容表示区域 (URLのみ) -->
        <div v-if="url" class="UrlContentWrapper">
          <img v-if="resourceType === 'image'" :src="url" alt="ImgUrl" class="ImageUrl" />
          <video v-else-if="resourceType === 'video'" :src="url" alt="VideoUrl" controls class="VideoUrl"></video>
        </div>
      </div>
    </div>
  </div>

  <div v-if="FILE_UPLOAD_TYPE.MULTI">
    <div
      v-if="!contentFile && !contentImageUrl"
      class="UploadArea"
      @dragenter="onDragEnter"
      @dragleave="onDragLeave"
      @dragover="onDragOver"
      @drop="onDrop"
    >
      <label class="FileButton" :style="{ color: color, backgroundColor: useGetThemeColor(THEME_COLOR.primary) }">
        <input
          class="HiddenInput"
          type="file"
          :accept="acceptTypes?.join(',')"
          :disabled="!isEdit"
          @change="onContentImageChange"
        />
        ファイル選択
      </label>
    </div>
    <div v-else>
      <div class="PreviewMultiContent">
        <div class="MultiDeleteButton" v-if="isEdit">
          <v-icon :icon="ICONS.CLOSE" :size="30" :color="'white'" @click="onDeleteImage" />
        </div>
        <img v-if="!isError" class="MultiImgFile" :src="contentImageUrl" alt="Thumbnail" />
        <v-icon v-else :icon="'mdi-alert-circle-outline'" :size="50" />
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, watch, onMounted } from 'vue'
import { THEME_COLOR, ICONS } from '../../composables/constants'
import { useGetThemeColor } from '../../composables/colors'
import { FILE_UPLOAD_TYPE, FILE_TYPE } from '../../components/common'

//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  color?: string
  extensions?: string[]
  isEdit?: boolean
  fileIcon?: string
  url?: string
  isShowInputBar?: boolean // Upload FileのFile名を表示するInputBarの表示をControl Show? or Hide?
  data?: any
  type?: FILE_UPLOAD_TYPE
}

const props = withDefaults(defineProps<Props>(), {
  color: '#fff',
  isEdit: true,
  isShowInputBar: true,
  fileIcon: 'mdi-text-box-check-outline',
  type: FILE_UPLOAD_TYPE.SINGLE,
})

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const input = ref('') // Upload時 選択したFileのFileNameを保存する変数
const isDragging = ref(false) //Drag状態を判断する変数
const contentImageUrl = ref<string>('') //Userが選択したImageFileのURLを保存する ,画像プレビュー表示時に使用
const contentVideoUrl = ref<string>('') //Userが選択したVideoFileのURLを保存する ,画像プレビュー表示時に使用
const contentAudioUrl = ref<string>('') //Userが選択したAudioFileのURLを保存する ,画像プレビュー表示時に使用
const contentFile = ref<File>() // Upload Fileを保存する変数 Userが選択した File Objectを保存するために使用される
const acceptTypes = ref(props.extensions) // 拡張子のType --> accept属性に渡す
const resourceType = ref<string>() //  URLのType --> ImageかVideoかを判断して、その値を保存

const isError = ref(false)

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
// 拡張子チェックのヘルパー関数
function isFileTypeAllowed(file: File): boolean {
  if (acceptTypes.value) {
    const fileType = file.type
    return acceptTypes.value.some((type) => fileType.includes(type))
  } else {
    return true
  }
}

function getFileIcon(fileType: string) {
  if (!fileType) {
    return null
  }

  if (fileType === FILE_TYPE.TEXT_TXT) {
    return props.fileIcon
  } else if (fileType === FILE_TYPE.TEXT_CSV) {
    return props.fileIcon
  } else if (fileType === FILE_TYPE.MAC_ZIP || fileType === FILE_TYPE.WIN_ZIP) {
    return props.fileIcon
  } else if (fileType === FILE_TYPE.APP_JSON) {
    return props.fileIcon
  } else if (fileType === FILE_TYPE.APP_PDF) {
    return props.fileIcon
  } else {
    return null
  }
}

//Image Fileかを判断
function isImageFile(file: File) {
  return file !== null && file.type.startsWith('image/')
}

//Video Fileかを判断
function isVideoFile(file: File) {
  return file !== null && file.type.startsWith('video/')
}
//Audio Fileかを判断
function isAudioFile(file: File) {
  return file !== null && file.type.startsWith('audio/')
}

/* DragEvent */
function onDragEnter(e: DragEvent) {
  e.preventDefault()
  e.stopPropagation()
  isDragging.value = true
}

function onDragLeave(e: DragEvent) {
  e.preventDefault()
  e.stopPropagation()
  isDragging.value = false
}

function onDragOver(e: DragEvent) {
  e.preventDefault()
  e.stopPropagation()
  if (e.dataTransfer?.files) {
    isDragging.value = true
  }
}

function onDrop(e: DragEvent) {
  isError.value = false
  if (e.dataTransfer) {
    e.preventDefault()
    e.stopPropagation()

    const file = e.dataTransfer.files[0]

    if (!isFileTypeAllowed(file)) {
      isError.value = true
      emits('update:error', '拡張子が正しくありません')
      return
    }

    contentFile.value = file
    // ImageFileを読み取って表示
    readImage(e.dataTransfer.files[0])
    //VideoFileを読み取って表示
    readVideo(e.dataTransfer.files[0])
    // AudioFileを読み取って表示
    readAudio(e.dataTransfer.files[0])
    // Upload File Nameを更新する
    fileInputNameChange(e)
    emits('update:error', '')
  }
}

// UploadしたFile名を取得
function fileInputNameChange(event: Event) {
  const inputTarget = event.target as HTMLInputElement
  if (inputTarget.files && inputTarget.files.length) {
    input.value = inputTarget.files[0].name
  }
}

// EditValueによってファイル選択のButtonClickできないように
function controlEditable(event: Event) {
  if (!props.isEdit) {
    event.preventDefault()
    event.stopPropagation()
  }
}

// Image Fileの表示関数
function readImage(image: File) {
  const reader = new FileReader()
  reader.onload = function (e) {
    if (e.target?.result) {
      contentImageUrl.value = String(e.target.result)
    }
  }

  reader.onerror = function (error) {
    console.error('Error reading file:', error)
  }

  reader.readAsDataURL(image)
  input.value = image.name
}

// Video Fileの表示関数
function readVideo(video: File) {
  contentVideoUrl.value = URL.createObjectURL(video)
}

// Audio Fileの表示関数
function readAudio(audio: File) {
  contentAudioUrl.value = URL.createObjectURL(audio)
}

// Upload Fileを画面に表示する関数
function onContentImageChange(e: Event) {
  isError.value = false
  const target = e.target as HTMLInputElement

  if (target.files && target.files.length) {
    const file = target.files[0]
    contentFile.value = file

    if (!isFileTypeAllowed(file)) {
      isError.value = true
      emits('update:error', '拡張子が正しくありません')
      return
    }

    if (isImageFile(file)) {
      readImage(file) // Imageタイプの場合はImageを表示する
    } else if (isVideoFile(file)) {
      readVideo(file) // Videoタイプの場合はVideoを表示する
    } else if (isAudioFile(file)) {
      readAudio(file) // Audioタイプの場合はAudioを表示する
    } else {
      // Image ,Audio , Video Typeではない場合は、File Iconで表示
      contentImageUrl.value = '' // 既存のImageFileをDelete
      input.value = file.name // Update File Name
    }
    emitFileInputNameChange(target.files[0])
    emits('update:error', '')
  }

  fileInputNameChange(e)
}

// Upload FileのDelete機能
function onDeleteImage() {
  contentImageUrl.value = ''
  contentVideoUrl.value = ''
  contentAudioUrl.value = ''
  input.value = ''

  emitDeleteFile(contentFile.value)
}

//  親Componentから渡されたUrl属性によって ーー＞ Fileの ContentTypeを判断
async function fetchResourceType(url: string) {
  try {
    const response = await fetch(url)
    const contentType = response.headers.get('content-type')
    if (contentType && contentType.startsWith('image/')) {
      resourceType.value = 'image'
    } else if (contentType && contentType.startsWith('video/')) {
      resourceType.value = 'video'
    } else {
      resourceType.value = 'unknown'
    }
  } catch (error) {
    console.error('Error fetching resource type:', error)
    resourceType.value = 'error'
  }
}
//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
// コンポーネントのロード時に関数を呼び出してResourceTypeを取得。
onMounted(() => {
  if (props.url) {
    fetchResourceType(props.url)
  }
})
//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
// watch(
//   () => props.extensions,
//   (value) => {
//     console.log('New extensions value:', value)
//   },
//   { deep: true }
// )

watch(
  () => props.data,
  (value) => {
    if (value.file) {
      readImage(value.file)
    } else if (value.path) {
      contentImageUrl.value = value.path
    }
  },
  {
    deep: true,
    immediate: true,
  }
)

// watch(
//   () => contentImageUrl,
//   (newValue) => {
//     console.log(newValue.value)
//   },
//   {
//     deep: true,
//   }
// )
//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', value: any): void
  (e: 'update:delete', value: any): void
  (e: 'update:error', error: string): void
}>()

const emitFileInputNameChange = (file: File) => {
  emits('update:value', file)
}

const emitDeleteFile = (value: any) => {
  emits('update:delete', value)
}

const emitErrorFile = (value: any) => {
  emits('update:error', value)
}
</script>

<style scoped>
.Wrapper {
  display: flex;
  width: 700px;
  height: 500px;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
}
.Wrapper .FileContent {
  position: relative;
  display: flex;
  width: 100%;
  height: 13%;
  justify-content: space-between;
  align-items: center;
  border: 2px solid #d3d3d3;
}
.Wrapper .FileContent .FileNameText {
  display: flex;
  width: 40%;
  height: 100%;
  justify-content: center;
  align-items: center;
  color: #fff;
}
.Wrapper .FileContent .ContentInput {
  display: flex;
  width: 60%;
  height: 100%;
  justify-content: space-between;
  align-items: center;
  font-size: 16px;
  background-color: #fff;
}
.Wrapper .FileContent .ContentInput .FileNameInput {
  display: inherit;
  width: 90%;
  height: 100%;
  justify-content: center;
  align-items: center;
  text-indent: 0.5em;
  border: none;
}
.Wrapper .FileContent .ContentInput .FileNameInput:focus {
  outline: none;
}
.Wrapper .FileContent .ContentInput .DeleteBtn {
  position: absolute;
  display: flex;
  width: 10%;
  height: 100%;
  right: 0px;
  top: 0px;
  font-size: 20px;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  z-index: 9;
}
.Wrapper .FileUpload {
  position: relative;
  width: 100%;
  height: 85%;
  justify-content: center;
  align-items: center;
  background-color: lightgray;
}
.Wrapper .FileUpload .FileUploadInner {
  position: relative;
  display: flex;
  flex-direction: column;
  width: 100%;
  height: 100%;
  justify-content: center;
  align-items: center;
  padding: 14px 0;
  font-size: 10px;
}
.Wrapper .FileUpload .FileUploadInner .FileUploadBtn {
  display: inline-block;
  padding: 15px 25px;
  margin-bottom: 10px;
  background: rgba(var(--r-color-primary));
  color: #fff;
  cursor: pointer;
}
.Wrapper .FileUpload .FileUploadInner:hover, .Wrapper .FileUpload .FileUploadInner:focus {
  filter: brightness(1.1);
}
.Wrapper .FileUpload .FileUploadInner .File {
  position: absolute;
  opacity: 0;
  width: 10px;
}
.Wrapper .FileUpload .FileUploadInner p {
  font-weight: bold;
  text-align: center;
}
.Wrapper .FileUpload .FileUploadInner #FileInput {
  display: none;
}
.Wrapper .FileUpload .FileUploadInner .PreviewContent {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
}
.Wrapper .FileUpload .FileUploadInner .PreviewContent .ImgFile {
  position: relative;
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.Wrapper .FileUpload .FileUploadInner .PreviewContent .VideoFile {
  position: relative;
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.Wrapper .FileUpload .FileUploadInner .PreviewContent .AudioFile {
  position: relative;
  width: 90%;
  height: 20%;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}
.Wrapper .FileUpload .FileUploadInner .PreviewContent .OtherTypeFile {
  position: relative;
  width: 100%;
  height: 100%;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}
.Wrapper .FileUpload .FileUploadInner .PreviewContent .OtherTypeFile .OtherTypeFileIcon {
  position: relative;
  width: 100%;
  height: 100%;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  font-size: 45px;
  background-color: lightgray;
}
.Wrapper .FileUpload .FileUploadInner .UrlContentWrapper {
  position: absolute;
  left: 0;
  bottom: 0;
  width: 100%;
  height: 100%;
  background-color: yellow;
}
.Wrapper .FileUpload .FileUploadInner .UrlContentWrapper .ImageUrl {
  position: relative;
  width: 100%;
  height: 100%;
  object-fit: cover;
  background-color: pink;
}
.Wrapper .FileUpload .FileUploadInner .UrlContentWrapper .VideoUrl {
  position: relative;
  width: 100%;
  height: 100%;
  object-fit: cover;
  background-color: aquamarine;
}

.UploadArea {
  position: relative;
  width: 200px;
  height: 200px;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: lightgray;
}

.HiddenInput {
  display: none;
}

.FileButton {
  display: inline-block;
  padding: 8px 12px;
  background: rgba(var(--r-color-primary));
  color: #fff;
  border-radius: 6px;
  font-size: 14px;
  width: 110px;
  text-align: center;
  cursor: pointer;
}

.PreviewMultiContent {
  position: relative;
  width: 200px;
  height: 200px;
  background-color: lightgray;
  display: flex;
  align-items: center;
  justify-content: center;
}

.MultiImgFile {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.MultiDeleteButton {
  position: absolute;
  top: 0;
  right: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 36px;
  width: 36px;
}

.DeleteButton {
  display: flex;
  align-items: center;
  justify-content: center;
}

.MultiDeleteButton:hover {
  background-color: rgba(var(--r-color-error), 0.8);
}
</style>
