<template>
  <div
    class="ToolTip"
    :class="{
      top: position === POSITION.TOP,
      bottom: position === POSITION.BOTTOM,
      left: position === POSITION.LEFT,
      right: position === POSITION.RIGHT,
    }"
  >
    <div class="Content" ref="Content">
      <slot />
    </div>
    <template v-if="!initialize">
      <!-- 初期化前のダミー表示（サイズ取得の為）-->
      <div class="Tip dummy">
        <div class="Balloon" ref="Balloon">
          <div class="Arrow">
            <div
              class="ArrowInner"
              :style="{
                left: arrowOffsetX ? arrowOffsetX + 'px' : undefined,
                top: arrowOffsetY ? arrowOffsetY + 'px' : undefined,
              }"
            />
          </div>
          <slot name="tip">{{ text }}</slot>
        </div>
      </div>
    </template>

    <div v-if="initialize">
      <teleport to="#float-area">
        <Transition>
          <div v-if="isShowSelect" class="Tip" :style="{ left: pos.left, top: pos.top }">
            <div
              class="Balloon"
              :style="{
                left: pos.offsetX,
                top: pos.offsetY,
                backgroundColor: backcolor ? useColor(backcolor) : undefined,
                color: color ? useColor(color) : undefined,
              }"
            >
              <div
                class="Arrow"
                :class="{
                  top: position === POSITION.TOP,
                  bottom: position === POSITION.BOTTOM,
                  left: position === POSITION.LEFT,
                  right: position === POSITION.RIGHT,
                  backgroundColor: backcolor ? useColor(backcolor) : undefined,
                }"
              >
                <div
                  class="ArrowInner"
                  :style="{
                    left: arrowOffsetX ? arrowOffsetX + 'px' : undefined,
                    top: arrowOffsetY ? arrowOffsetY + 'px' : undefined,
                    backgroundColor: backcolor ? useColor(backcolor) : undefined,
                  }"
                />
              </div>

              <slot name="tip">{{ text }}</slot>
            </div>
          </div>
        </Transition>
      </teleport>
    </div>
  </div>
</template>

<script setup lang="ts">
//今回printWidthは120にしてるので、この===の長さを目安にコードを整える
/**===================================================================================================================
   * モーダルウィンドウ
   * タイトルバーをドラックで移動できる
  ===================================================================================================================**/
import { ref, onMounted, onBeforeUnmount, type Ref, onBeforeMount } from 'vue'
import { POSITION } from '../../composables/constants'
import { useColor } from '../../composables/colors'
//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const Content: Ref<HTMLDivElement | null> = ref(null)
const Balloon: Ref<HTMLDivElement | null> = ref(null)
const BalloonBox: Ref<DOMRect | null> = ref(null)
const initialize = ref(false)
const isShowSelect = ref(false)
const timer: Ref<NodeJS.Timeout | null> = ref(null)
const pos: Ref<{ left: string; top: string; offsetX: string; offsetY: string }> = ref({
  left: '0',
  top: '0',
  offsetX: '0',
  offsetY: '0',
})
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  text: string
  position?: string
  offsetX?: number
  offsetY?: number
  arrowOffsetX?: number
  arrowOffsetY?: number
  deley?: number
  backcolor?: string
  color?: string
}

const props = withDefaults(defineProps<Props>(), {
  text: 'ツールチップ',
  offsetX: 0,
  offsetY: 0,
  position: POSITION.TOP,
  deley: 500,
  //他のObject形式の型だと現状ではTSエラーになってしまう。どちらにしても保存したデータからの復帰があるので、onBeforeMountで行う
})

//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onBeforeMount(() => {
  //記憶した位置、サイズでの復帰を可能にする
})

onMounted(() => {
  //window.addEventListener('resize', onGetPosition)
  if (Content.value) {
    Content.value.addEventListener('mouseenter', onMouseOver)
    Content.value.addEventListener('mouseleave', onMouseOut)
    Content.value.addEventListener('wheel', onMouseOut)
  }
})

onBeforeUnmount(() => {
  if (Content.value) {
    Content.value.removeEventListener('mouseenter', onMouseOver)
    Content.value.removeEventListener('mouseleave', onMouseOut)
    Content.value.removeEventListener('wheel', onMouseOut)
  }
  if (timer.value) {
    clearTimeout(timer.value)
    timer.value = null
  }
  //window.removeEventListener('resize', onGetPosition)
})

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------

function onMouseOver(e: MouseEvent) {
  if (Balloon.value && !initialize.value) {
    BalloonBox.value = Balloon.value.getBoundingClientRect()
    console.log('初期化のサイズ', BalloonBox.value)

    initialize.value = true
  }
  if (Content.value && BalloonBox.value) {
    if (timer.value) {
      clearTimeout(timer.value)
      timer.value = null
    }
    const content = Content.value.getBoundingClientRect()
    if (props.position === POSITION.TOP) {
      pos.value.left = content.left + content.width / 2 + props.offsetX + 'px'
      pos.value.top = content.top - 10 - BalloonBox.value.height - props.offsetY + 'px'
      pos.value.offsetX = BalloonBox.value.width / -2 + 'px'
      pos.value.offsetY = '0px'
    } else if (props.position === POSITION.BOTTOM) {
      pos.value.left = content.left + content.width / 2 + props.offsetX + 'px'
      pos.value.top = content.top + content.height + 10 + props.offsetY + 'px'
      pos.value.offsetX = BalloonBox.value.width / -2 + 'px'
      pos.value.offsetY = '0px'
    } else if (props.position === POSITION.LEFT) {
      pos.value.left = content.left - BalloonBox.value.width + props.offsetX - 8 + 'px'
      pos.value.top = content.top + content.height / 2 + props.offsetY + 'px'
      pos.value.offsetX = '0px'
      pos.value.offsetY = BalloonBox.value.height / -2 + 'px'
    } else if (props.position === POSITION.RIGHT) {
      pos.value.left = content.left + content.width + props.offsetX + 8 + 'px'
      pos.value.top = content.top + content.height / 2 + props.offsetY + 'px'
      pos.value.offsetX = '0px'
      pos.value.offsetY = BalloonBox.value.height / -2 + 'px'
    }
    timer.value = setTimeout(() => {
      isShowSelect.value = true
    }, props.deley)
  }
}

function onMouseOut(e: MouseEvent) {
  if (timer.value) {
    clearTimeout(timer.value)
    timer.value = null
  }
  isShowSelect.value = false
}

//------------------------------------------------------------------------------------------------------------
// エミット
// default（v-model）の場合、modelValue
// が色々やるので、別名にする
// :value="hoge" @update.value=(onHoge($event)) みたいにする
//------------------------------------------------------------------------------------------------------------
</script>

<style scoped>
.ToolTip {
  position: relative;
}

.Tip {
  position: absolute;
  pointer-events: none;
}
.Tip .Balloon {
  position: absolute;
  font-size: 12px;
  background-color: #666;
  border-radius: 4px;
  color: #fff;
  padding: 4px 10px;
  white-space: pre;
}
.Tip .Balloon .Arrow {
  position: absolute;
  height: 17.3205080757px;
  width: 20px;
}
.Tip .Balloon .Arrow.top {
  transform: rotate(180deg);
  bottom: -10px;
  left: calc(50% - 10px);
}
.Tip .Balloon .Arrow.bottom {
  top: -10px;
  left: calc(50% - 10px);
}
.Tip .Balloon .Arrow.left {
  transform: rotate(90deg);
  top: calc(50% - 8px);
  right: -10px;
}
.Tip .Balloon .Arrow.right {
  transform: rotate(-90deg);
  top: calc(50% - 8px);
  left: -10px;
}
.Tip .Balloon .Arrow .ArrowInner {
  position: absolute;
  top: 0px;
  left: 0px;
  background: #666;
  height: 17.3205080757px;
  width: 20px;
  clip-path: polygon(50% 0, 100% 100%, 0 100%);
}
.Tip.dummy {
  top: -1000px;
  left: -1000px;
}

.v-enter-active {
  transition: opacity 0.3s ease;
}

.v-leave-active {
  transition: opacity 0.3s ease;
}

.v-enter-from,
.v-leave-to {
  opacity: 0;
}
</style>
