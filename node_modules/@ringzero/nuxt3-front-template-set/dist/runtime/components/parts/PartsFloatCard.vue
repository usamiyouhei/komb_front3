<template>
  <div v-if="initialize">
    <teleport to="#float-area">
      <Transition>
        <div v-if="isShowSelect">
          <div
            ref="FloatCard"
            class="FloatCard"
            :class="{
              Top: layout === POSITION.TOP,
            }"
            :style="{
              left: rect ? rect.left + 2 + 'px' : 0,
              top: rect
                ? layout === POSITION.TOP
                  ? rect.top - height - 2 + 'px'
                  : rect.top + rect.height + 2 + 'px'
                : 0,
              width: '350px',
              maxWidth: '350px',
              height: height + 'px',
              padding: '10px 0',
            }"
          >
            <slot />
          </div>
        </div>
      </Transition>
    </teleport>
  </div>
</template>

<script setup lang="ts">
/**===================================================================================================================
   *
   ===================================================================================================================**/
import { POSITION, THEME_COLOR } from '../../composables/constants'
import { ref, watch, type Ref, onMounted, onBeforeUnmount } from 'vue'
import type { ModalSwitch } from '../../types'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  inputArea: HTMLDivElement | null
  switcher: ModalSwitch
}
const props = withDefaults(defineProps<Props>(), {})

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const isShowSelect = ref(props.switcher.opened)
const rect: Ref<DOMRect | null> = ref(null)
const initialize = ref(false)
const height = 400
const FloatCard: Ref<HTMLDivElement | null> = ref(null)
const layout: Ref<POSITION> = ref(POSITION.BOTTOM)
// const layout: Ref<POSITION> = ref(flordCardPotion(rect.value))
//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onMounted(() => {
  window.addEventListener('resize', onGetPosition)
  initialize.value = true
})

onBeforeUnmount(() => {
  window.removeEventListener('resize', onGetPosition)
  checkListener(false)
})
//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.switcher,
  (value) => {
    isShowSelect.value = value.opened
    onShowSelect()
  },
  {
    deep: true,
  }
)

watch(
  () => rect.value,
  (value) => {
    flordCardPosition(value)
  },
  {
    deep: true,
  }
)
//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function flordCardPosition(inputRect: any) {
  if (inputRect) {
    let bottomPosition = window.innerHeight + window.scrollY
    if (bottomPosition > inputRect.bottom + height) {
      layout.value = POSITION.BOTTOM
    } else {
      layout.value = POSITION.TOP
    }
  }
}

function onShowSelect() {
  checkListener(isShowSelect.value)
  onGetPosition()
}

function onGetPosition() {
  if (props.inputArea) {
    // console.log(props.inputArea)
    rect.value = props.inputArea.getBoundingClientRect()
  }
  // console.log(rect.value)
}

function checkListener(isShow: boolean) {
  if (isShow) {
    setTimeout(() => {
      document.addEventListener('click', onClickOutside)
    }, 16)
  } else {
    document.removeEventListener('click', onClickOutside)
  }
}

function onClickOutside(event: MouseEvent) {
  if (FloatCard.value) {
    if (!FloatCard.value.contains(event.target as Node)) {
      // 領域外でのクリックを感知した場合の処理
      isShowSelect.value = false
      props.switcher.opened = false
      checkListener(false)
    }
  }
}
</script>

<style scoped>
.FloatCard {
  position: absolute;
  background-color: rgb(var(--r-color-form));
  pointer-events: auto;
  border-radius: 0px 0px 4px 4px;
  border: 1px solid rgb(var(--r-color-line));
  padding: 10px;
  box-shadow: 1px 1px 2px 0 rgba(25, 25, 25, 0.2) !important;
  overflow-y: auto;
  z-index: 10;
}
.FloatCard.Top {
  border-radius: 4px 4px 0 0;
}
</style>
