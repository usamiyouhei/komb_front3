<template>
  <div class="SelectMenu" :style="{ width: width + 'px' }">
    <div class="InputArea" ref="InputArea" @click="onShowSelect">
      <slot>
        <div v-if="inputType === SELECT_INPUT_TYPE.INPUT" class="ArrowContainer">
          <FormInput
            class="IconRight"
            :value="getItemText(input, false)"
            :edit="!disabled"
            :mode="FORM_MODE.SIMPLE"
            :width="width"
            :placeholder="placeholder"
            @update:value="onInputChange($event)"
          />
          <ButtonArrow
            class="FloatArrow"
            :color="useColor(THEME_COLOR.color)"
            :backcolor="disabled ? 'transparent' : useColor(THEME_COLOR.primary)"
            :after-icon="'mdi-chevron-down'"
            :actived="isShowSelect"
            :disabled="disabled"
            icon
            light
            :width="26"
          />
        </div>
        <ButtonArrow
          v-else-if="inputType === SELECT_INPUT_TYPE.FRAME"
          :text="getItemText(input)"
          :color="useColor(THEME_COLOR.color)"
          :backcolor="useColor(THEME_COLOR.form)"
          :after-icon="'mdi-chevron-down'"
          :width="width"
          :actived="isShowSelect"
          :align="'space-between'"
          border
        />
        <ButtonArrow
          v-else-if="inputType === SELECT_INPUT_TYPE.BUTTON"
          :text="text"
          :color="'#ffffff'"
          :backcolor="backcolor"
          :after-icon="'mdi-chevron-down'"
          :actived="isShowSelect"
        />
        <NuxtLink v-else-if="inputType === SELECT_INPUT_TYPE.LINK" to="#">{{
          text ? text : getItemText(input)
        }}</NuxtLink>
        <div v-else class="Text">{{ text ? text : getItemText(input) }}</div>
      </slot>
    </div>
    <div v-if="initialize">
      <teleport to="#float-area">
        <Transition>
          <div v-if="isShowSelect">
            <div
              ref="FloatCard"
              class="FloatCard"
              :class="{
                Top: layout === POSITION.TOP,
              }"
              :style="{
                left: rect ? rect.left + 2 + 'px' : 0,
                top: rect
                  ? layout === POSITION.TOP
                    ? height
                      ? rect.top - height - 2 + 'px'
                      : rect.top - 36 * (items ? items.length : 0) - 22 + 'px'
                    : rect.top + rect.height + 2 + 'px'
                  : 0,
                width: fit && rect ? rect.width - 4 + 'px' : undefined,
                maxWidth: fit && rect ? rect.width - 4 + 'px' : undefined,
                height: height ? height + 'px' : undefined,
                padding: selectType === SELECT_LIST_TYPE.DEFAULT ? '10px 0' : '10px',
              }"
            >
              <ButtonCheckSet :items="items || []" :value="input" :color="backcolor" @update:value="onChange($event)" />
            </div>
          </div>
        </Transition>
      </teleport>
    </div>
  </div>
</template>

<script setup lang="ts">
/**
 * Selectメニューのラッパー
 **/
import { POSITION, THEME_COLOR } from '../../composables/constants'
import { FORM_MODE } from '../../components/common'
import { type CheckBoxSetProps, SELECT_INPUT_TYPE, SELECT_LIST_TYPE } from '../../components/common'
import { ref, watch, type Ref, onBeforeUnmount, onMounted } from 'vue'
import { useColor } from '../../composables/colors'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  items?: CheckBoxSetProps[]
  value: string | number | undefined
  text?: string
  placeholder?: string
  inputType?: SELECT_INPUT_TYPE
  selectType?: SELECT_LIST_TYPE
  color?: string
  backcolor?: string
  width?: number
  height?: number
  layout?: POSITION
  fit?: boolean
  disabled?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  inputType: SELECT_INPUT_TYPE.TEXT,
  selectType: SELECT_LIST_TYPE.DEFAULT,
  color: '#fff',
  height: 0,
  backcolor: THEME_COLOR.primary,
  placeholder: '選択してください',
})

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const isShowSelect = ref(false)
const input = ref(props.value)
const InputArea: Ref<HTMLDivElement | null> = ref(null)
const FloatCard: Ref<HTMLDivElement | null> = ref(null)
const rect: Ref<DOMRect | null> = ref(null)
const initialize = ref(false)

//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onMounted(() => {
  window.addEventListener('resize', onGetPosition)
  initialize.value = true
})

onBeforeUnmount(() => {
  window.removeEventListener('resize', onGetPosition)
  checkListener(false)
})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.value,
  (value) => {
    input.value = value
    if (props.items) {
      props.items.forEach((item) => {
        item.checked = false
      })
    }
    const values = String(value).split(',')
    values.forEach((value) => {
      if (props.items) {
        const item = props.items.find((item) => item.value === value)
        if (item) {
          item.checked = true
        }
      }
    })
  }
)

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', item: any): void
  (e: 'update:text', item: any): void
}>()

function onInputChange(value: any) {
  onChange(value)
}

function onChange(value: CheckBoxSetProps[]) {
  const text: string[] = []
  const res: string[] = []
  value.forEach((item) => {
    if (item.checked) {
      text.push(item.text)
      res.push(item.value)
    }
  })

  input.value = res.join(',')
  emits('update:value', input.value)
  emits('update:text', input.value)
  /*
    checkListener(false)
    setTimeout(() => {
      isShowSelect.value = false
    }, 300)
    */
}

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------

function onShowSelect() {
  if (props.disabled) return
  isShowSelect.value = !isShowSelect.value
  checkListener(isShowSelect.value)
  onGetPosition()
}

function onGetPosition() {
  if (InputArea.value) {
    rect.value = InputArea.value.getBoundingClientRect()
  }
}

function getItemText(value: any, placeholder: boolean = true) {
  if (props.items && value) {
    const array = value.split(',')
    const result: string[] = []
    for (let i = 0; i < array.length; i++) {
      const item = props.items.find((item) => item.value === array[i])
      if (item) {
        result.push(item.text)
      }
    }

    return result.length ? result.join(',') : placeholder ? props.placeholder : value
  }
  return placeholder ? props.placeholder : value
}

function checkListener(isShow: boolean) {
  if (isShow) {
    setTimeout(() => {
      document.addEventListener('click', onClickOutside)
    }, 16)
  } else {
    document.removeEventListener('click', onClickOutside)
  }
}

function onClickOutside(event: MouseEvent) {
  if (FloatCard.value) {
    if (!FloatCard.value.contains(event.target as Node)) {
      // 領域外でのクリックを感知した場合の処理
      isShowSelect.value = false
      checkListener(false)
    }
  }
}
</script>
<style scoped>
.SelectMenu {
  position: relative;
  width: 100%;
}

.ArrowContainer {
  position: relative;
  width: 100%;
}

.FloatArrow {
  position: absolute !important;
  top: 5px;
  right: 4px;
}

.FloatCard {
  position: absolute;
  background-color: #fff;
  pointer-events: auto;
  border-radius: 0px 0px 4px 4px;
  border: 1px solid rgb(var(--v-theme-disabled));
  padding: 10px;
  box-shadow: 1px 1px 2px 0 rgba(25, 25, 25, 0.2) !important;
  overflow-y: auto;
}
.FloatCard.Top {
  border-radius: 4px 4px 0 0;
}

.Text {
  cursor: pointer;
}

.v-enter-active {
  transition: opacity 0.3s ease;
}

.v-leave-active {
  transition: opacity 0.3s ease;
}

.v-enter-from,
.v-leave-to {
  opacity: 0;
}

.IconRight ::v-deep(.Input) {
  padding-right: 30px !important;
}
</style>
