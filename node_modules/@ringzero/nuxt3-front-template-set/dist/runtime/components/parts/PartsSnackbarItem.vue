<template>
  <div
    class="Item"
    :class="{ show: animations === 0, animaFade: animations === 1, animaClose: animations === 2 }"
    :style="{ height: `${height}px` }"
  >
    <div class="Inner" ref="Inner">
      <div class="Icon">
        <v-icon
          :icon="SNACKBAR_ICOM[value.icon ? value.icon : 'default'].icon"
          :color="SNACKBAR_ICOM[value.icon ? value.icon : 'default'].color"
          :size="24"
        />
      </div>
      <div class="Message">
        <div v-if="value.title" class="Title">
          {{ value.title }}
        </div>
        <div class="Text">
          <p v-for="text in createMessage(value.text)">{{ text ? text : `\&nbsp;` }}</p>
        </div>
      </div>

      <div class="Action">
        <PartsProgress class="" :type="PROGRESS_TYPE.CIRCLE" :value="elapsedTime" :color="'#999'" :size="30" :width="2">
          <ButtonIcon class="Close" :icon="ICONS.CLOSE" :size="24" color="white" @click="onDelete(0)" />
        </PartsProgress>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
/**===================================================================================================================
   * スナックバー
   ===================================================================================================================**/
import { type snackbarProp } from '../../components/common'
import { ref, onMounted, type Ref, onBeforeUnmount } from 'vue'
import { useDelay } from '../../composables/utility'
import { useSnackbarList } from '../../composables/snackbars'
import { SNACKBAR_ICOM, PROGRESS_TYPE, ICONS } from '../../composables/constants'

//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  value: snackbarProp
}

const props = withDefaults(defineProps<Props>(), {})

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const snackbar = useSnackbarList()
// オーバーロードエラーにつき、NodeJS.TimerからNodeJS.Timeoutに変更
const timeId: Ref<NodeJS.Timeout | null> = ref(null)
const Inner: Ref<HTMLDivElement | null> = ref(null)
const startTime = ref(0)
const elapsedTime = ref(0)
const limitTime = ref(10000)
const animations = ref(0)
const height = ref(0)

//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onMounted(() => {
  //タイマー開始
  const rect = Inner.value?.getBoundingClientRect()
  height.value = rect ? rect.height + 6 : 36
  startTime.value = performance.now()
  if (props.value.time) limitTime.value = props.value.time
  timeId.value = setInterval(checkTime, 16)
})
onBeforeUnmount(() => {
  if (timeId.value) {
    clearTime()
  }
})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
/*
  watch(
    () => props.value,
    (value) => {
      input.value = value
    }
  )
  */

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
/*
  const emits = defineEmits<{ (e: 'update:value', item: any): void }>()
  const input = ref(props.value)
  
  function onChange(value: any) {
    input.value = value
    emits('update:value', value)
  }
  */

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function createMessage(text: string) {
  return text.split('\n')
}

function clearTime() {
  if (timeId.value) {
    clearTimeout(timeId.value)
  }
}

function checkTime() {
  //setIntervalやsetTimeoutの経過タイムは信用出来ないので、
  const time = performance.now() - startTime.value
  elapsedTime.value = Math.round((time / limitTime.value) * 100)
  if (elapsedTime.value > 100) {
    clearTime()
    onDelete(360)
  }
}

const delay = useDelay()

async function onDelete(deley: number) {
  await delay.wait(deley)
  animations.value = 1
  await delay.wait(360)
  animations.value = 2
  height.value = 0
  await delay.wait(360)
  snackbar.deleteItem(props.value)
}
</script>

<style scoped>
.Item {
  position: relative;
  width: 400px;
  overflow-y: hidden;
  transform-origin: left top;
}
.Item .Inner {
  position: relative;
  width: 100%;
  display: flex;
  justify-content: flex-start;
  align-items: flex-start;
  padding: 10px 10px 10px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 8px;
  margin-bottom: 6px;
}
.Item .Inner .Icon {
  position: relative;
  width: 36px;
  min-width: 36px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  font-size: 12px;
}
.Item .Inner .Message {
  position: relative;
  padding-right: 36px;
}
.Item .Inner .Message .Title {
  position: relative;
  width: 100%;
  font-size: 14px;
  margin-top: 2px;
  font-weight: bold;
}
.Item .Inner .Message .Text {
  position: relative;
  width: 100%;
  font-size: 12px;
  margin-top: 3px;
}
.Item .Inner .Action {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 36px;
  min-width: 36px;
  height: 36px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
}
.Item .Inner .Action .Close {
  position: relative;
  padding-top: 1px;
}

.show {
  opacity: 1;
}

.animaFade {
  opacity: 0;
  transition: transform 0.3s ease, opacity 0.3s ease;
  transform: translateX(400px);
}

.animaClose {
  opacity: 0;
  transition: height 0.3s ease;
  transform: translateX(200px);
}
</style>
