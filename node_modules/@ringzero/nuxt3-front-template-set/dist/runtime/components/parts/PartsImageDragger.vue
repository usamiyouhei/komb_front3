<template>
  <div class="Container" :class="{ SmallContainer: small }" name="ImageDragger">
    <div v-if="selectType === DROP_TYPE.DROP_AREA || selectType === DROP_TYPE.FORM">
      <div
        v-if="edit"
        class="UploadArea"
        :class="{ Enter: isEnter, SmallUploadArea: small }"
        @dragenter="dragEnter"
        @dragleave="dragLeave"
        @dragover.prevent="dragOver"
        @drop.prevent="dropFile"
      >
        <div v-if="selectUpload" class="UploadAreaInner">
          <label class="FileUploadBtn">
            <input
              class="File"
              type="file"
              name="file"
              @click="resetInput($event)"
              @change="uploadFile($event)"
            />ファイルを選択
          </label>
          <p>ドラッグ&ドロップ<br />またはクリックでファイルを選択</p>
        </div>
        <div v-else class="UploadAreaInner" :class="{ SmallUploadAreaInner: small }">
          <div v-if="imgUrl" class="ImgContainer" :style="{ height: imgHeight + 'px' }">
            <img class="Img" :class="{ SmallImg: small }" :src="imgUrl" draggable="false" @load="onImgLoad" />
          </div>
          <div
            v-else-if="videoUrl"
            ref="videoContainer"
            class="VideoContainer"
            :style="{ height: videoHeight ? videoHeight + 'px' : '' }"
          >
            <video
              v-show="videoHeight"
              class="Video"
              :class="{ SmallVideo: small }"
              :src="videoUrl"
              controls
              @loadedmetadata="onVideoLoad"
            ></video>
          </div>
          <div v-else-if="audioUrl" class="AudioContainer">
            <audio class="Audio" :class="{ SmallAudio: small }" :src="audioUrl" controls></audio>
          </div>
          <div v-else-if="textContent" class="TextContainer">
            <v-icon v-if="isTextFileUpload" class="Icon" size="45px" icon="mdi-text-box-check-outline" />
          </div>
          <div v-else-if="zipContent" class="ZipContainer">
            <v-icon v-if="isZipFileUpload" class="Icon" size="45px" icon="mdi-folder-zip-outline" />
          </div>
          <div v-else class="InputContainer">
            <label class="FileUploadBtn" :class="{ SmallFileUploadBtn: small }">
              <input
                class="File"
                :class="{ SmallFile: small }"
                type="file"
                name="file"
                :accept="permittedExtensions.join(',')"
                @click="resetInput($event)"
                @change="uploadFile($event)"
              />ファイルを選択
            </label>
            <p>ドラッグ&ドロップ<br />またはクリックでファイルを選択</p>
          </div>
        </div>
      </div>

      <div v-else class="DisplayArea" :class="{ SmallDisplayArea: small }">
        <div class="DisplayAreaInner" :class="{ SmallDisplayAreaInner: small }">
          <div v-if="imgUrl" class="ImgContainer" :style="{ height: imgHeight + 'px' }">
            <img class="Img" :class="{ SmallImg: small }" :src="imgUrl" draggable="false" @load="onImgLoad" />
          </div>
          <div
            v-else-if="videoUrl"
            ref="videoContainer"
            class="VideoContainer"
            :style="{ height: videoHeight ? videoHeight + 'px' : '' }"
          >
            <video
              v-show="videoHeight"
              class="Video"
              :class="{ SmallVideo: small }"
              :src="videoUrl"
              controls
              @loadedmetadata="onVideoLoad"
            ></video>
          </div>
          <div v-else-if="audioUrl" class="AudioContainer">
            <audio class="Audio" :class="{ SmallAudio: small }" :src="audioUrl" controls></audio>
          </div>
          <div v-else-if="textContent" class="TextContainer">
            <v-icon v-if="isTextFileUpload" class="Icon" size="45px" icon="mdi-text-box-check-outline" />
          </div>
          <div v-else-if="zipContent" class="ZipContainer">
            <v-icon v-if="isZipFileUpload" class="Icon" size="45px" icon="mdi-folder-zip-outline" />
          </div>
        </div>
      </div>
    </div>

    <!-- ドロップしたファイルをアイコンで並べて表示する際に使用（拡張子変更可能） -->
    <div v-else class="UploadContainer">
      <div v-if="selectUpload">
        <div v-if="selectType === DROP_TYPE.DIAPLAY_FILES" class="Sample">
          <h6>{{ title }}</h6>
          <ul class="UploadFiles">
            <li v-for="(file, index) in files" :key="index" class="UploadFile">
              <div class="FilesContainer">
                <ButtonIcon
                  class="Delete"
                  icon="mdi-close"
                  :backcolor="THEME_COLOR.primary"
                  light
                  @click="deleteFile(files[0].file)"
                />
                <div><v-icon class="Icon" size="45px" icon="mdi-file-check-outline" /></div>
                <div>
                  <p>ファイル名:{{ file.file.name }}</p>
                  <p>サイズ:{{ file.file.size }}</p>
                  <p v-show="file.height">画像縦:{{ file.height }}</p>
                  <p v-show="file.width">画像縦:{{ file.width }}</p>
                </div>
              </div>
              <div>
                <ButtonSimple
                  v-for="(item, i) in changeType(file)"
                  :key="i"
                  class="ma-2"
                  :text="`拡張子${i}`"
                  @click="changeExtension(file, index, item.text, item.value)"
                />
              </div>
              <div v-if="imgUrl">
                <ButtonSimple class="ma-2" text="画像表示" @click="imgPreview(file.file)" />
              </div>
            </li>
          </ul>
          <div v-if="imgUrl" class="ImgContainer">
            <img class="Img" :src="imgUrl" draggable="false" />
          </div>
        </div>
      </div>

      <!-- アップロードしたファイルをアイコンで表示する際に使用（拡張子の変更可能） -->
      <div v-else>
        <div v-if="selectType === DROP_TYPE.DISPLAY_FILE" class="Sample">
          <h6>{{ props.title }}</h6>
          <div v-if="files[0]" class="FileContainer">
            <ButtonIcon
              class="Delete"
              icon="mdi-close"
              :backcolor="THEME_COLOR.primary"
              light
              @click="deleteFile(files[0].file)"
            />
            <div><v-icon id="icon" size="45px" icon="mdi-file-check-outline" /></div>
            <div>
              <p>ファイル名:{{ files[0].file.name }}</p>
              <p>サイズ:{{ files[0].file.size }}</p>
              <p v-show="files[0].height">画像縦:{{ files[0].height }}</p>
              <p v-show="files[0].width">画像横:{{ files[0].width }}</p>
            </div>
            <div>
              <ButtonSimple
                v-for="(item, i) in changeType(files[0])"
                :key="i"
                class="ma-2"
                :text="`拡張子${i}`"
                @click="changeExtension(files[0], i, item.text, item.value)"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, watch, type Ref, onMounted } from 'vue'
import { FILE_TYPE, DROP_TYPE, FILE_EXTENSION } from '../../components/common'
import { THEME_COLOR } from '../../composables/constants'

//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  // 単一か複数かファイルの数を制限
  selectUpload?: boolean
  // フォームの種類を選択（pages/imagedragger）に記載
  selectType: DROP_TYPE
  // 複数のファイルを配列で格納している
  textFiles?: any
  audioFiles?: any
  movieFiles?: any
  imgFiles?: any
  zipFiles?: any
  csvFiles?: any
  xlsFiles?: any
  jsonFiles?: any
  // 単一のファイルを格納している
  files?: any
  imgUrl?: string
  title?: string
  small?: boolean
  reset?: boolean
  // 許容する拡張子を指定
  extensions?: string[]
  edit?: boolean
  data?: any
  // アップロードされているファイル名を格納している
  dataList?: string[]
}

const props = withDefaults(defineProps<Props>(), {
  extensions: () => [
    FILE_TYPE.AUDIO_MP3,
    FILE_TYPE.IMG_GIF,
    FILE_TYPE.IMG_JPEG,
    FILE_TYPE.IMG_JPG,
    FILE_TYPE.IMG_PNG,
    FILE_TYPE.MOVIE_MP4,
    FILE_TYPE.TEXT_TXT,
    FILE_TYPE.TEXT_CSV,
    FILE_TYPE.TEXT_XLS,
    FILE_TYPE.TEXT_XLSX,
    FILE_TYPE.MAC_ZIP,
    FILE_TYPE.WIN_ZIP,
    FILE_TYPE.APP_JSON,
  ],
})

type FileTypeMap = {
  [key: string]:
    | typeof imgFiles
    | typeof textFiles
    | typeof audioFiles
    | typeof movieFiles
    | typeof zipFiles
    | typeof csvFiles
    | typeof xlsFiles
    | typeof jsonFiles
}

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const isEnter: Ref<boolean> = ref(false)
//--------- todo:まとめる-------------
const imgUrl: Ref<string | undefined> = ref(props.imgUrl)
const imgHeight = ref(0)

const videoUrl: Ref<string | undefined> = ref()
const videoHeight = ref(0)
const videoWidth = ref(0)
const videoContainer = ref()

const audioUrl = ref()

const textContent = ref()
const isTextFileUpload = ref(false)
const zipContent = ref()
const isZipFileUpload = ref(false)
const permittedExtensions: Ref<string[]> = ref(props.extensions)
const uploadType = ref(props.selectType)

const textFiles: any = ref(props.textFiles)
const imgFiles: any = ref(props.imgFiles)
const audioFiles: any = ref(props.audioFiles)
const movieFiles: any = ref(props.movieFiles)
const zipFiles: any = ref(props.zipFiles)
const csvFiles: any = ref(props.csvFiles)
const xlsFiles: any = ref(props.xlsFiles)
const jsonFiles: any = ref(props.jsonFiles)
//---------------------------------
const selectUpload: Ref<boolean> = ref(props.selectUpload)
const files: any = ref(props.files)
const formData = ref(props.data)
const imageNameList = ref(props.dataList)

const extension = {
  text: [
    { text: FILE_EXTENSION.TEXT_TXT, value: FILE_TYPE.TEXT_TXT },
    { text: FILE_EXTENSION.TEXT_CSV, value: FILE_TYPE.TEXT_CSV },
    { text: FILE_EXTENSION.TEXT_XLS, value: FILE_TYPE.TEXT_XLS },
    { text: FILE_EXTENSION.TEXT_XLSX, value: FILE_TYPE.TEXT_XLSX },
  ],
  audio: [{ text: FILE_EXTENSION.AUDIO_MP3, value: FILE_TYPE.AUDIO_MP3 }],
  movie: [{ text: FILE_EXTENSION.MOVIE_MP4, value: FILE_TYPE.MOVIE_MP4 }],
  image: [
    { text: FILE_EXTENSION.IMG_PNG, value: FILE_TYPE.IMG_PNG },
    { text: FILE_EXTENSION.IMG_JPG, value: FILE_TYPE.IMG_JPG },
    { text: FILE_EXTENSION.IMG_JPEG, value: FILE_TYPE.IMG_JPEG },
    { text: FILE_EXTENSION.IMG_GIF, value: FILE_TYPE.IMG_GIF },
  ],
  zip: [
    { text: FILE_EXTENSION.ZIP, value: FILE_TYPE.MAC_ZIP },
    { text: FILE_EXTENSION.ZIP, value: FILE_TYPE.WIN_ZIP },
  ],
  json: [{ text: FILE_EXTENSION.APP_JSON, value: FILE_TYPE.APP_JSON }],
}

const fileMap: FileTypeMap = {
  image: imgFiles,
  text: textFiles,
  audio: audioFiles,
  video: movieFiles,
  zip: zipFiles,
  csv: csvFiles,
  xls: xlsFiles,
  json: jsonFiles,
}
//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
//----------- TODO: 整理する------------
watch(
  () => props.textFiles,
  (value) => {
    textFiles.value = value
  },
  { deep: true }
)

watch(
  () => props.imgFiles,
  (value) => {
    imgFiles.value = value
  },
  { deep: true }
)

watch(
  () => props.audioFiles,
  (value) => {
    audioFiles.value = value
  },
  { deep: true }
)

watch(
  () => props.movieFiles,
  (value) => {
    movieFiles.value = value
  },
  { deep: true }
)

watch(
  () => props.zipFiles,
  (value) => {
    zipFiles.value = value
  },
  { deep: true }
)

watch(
  () => props.csvFiles,
  (value) => {
    csvFiles.value = value
  },
  { deep: true }
)

watch(
  () => props.xlsFiles,
  (value) => {
    xlsFiles.value = value
  },
  { deep: true }
)

watch(
  () => props.jsonFiles,
  (value) => {
    jsonFiles.value = value
  },
  { deep: true }
)
//-----------------------------------

watch(
  () => props.selectUpload,
  (value) => {
    selectUpload.value = value
    imgUrl.value = ''
  }
)

watch(
  () => props.imgUrl,
  (value) => {
    imgUrl.value = value
  }
)

watch(
  () => props.files,
  (value) => {
    files.value = value
  },
  {
    deep: true,
  }
)

watch(
  () => props.dataList,
  (value) => {
    imageNameList.value = value
  },
  {
    deep: true,
  }
)

watch(
  () => props.reset,
  (value) => {
    // console.log('リセット', value)
    resetFiles()
  }
)

// 編集ボタンがクリックされた際に、imgURLを作成して画像を表示
watch(
  () => props.edit,
  (value) => {
    if (formData.value) {
      if (
        formData.value.type === FILE_TYPE.IMG_GIF ||
        formData.value.type === FILE_TYPE.IMG_JPEG ||
        formData.value.type === FILE_TYPE.IMG_JPG ||
        formData.value.type === FILE_TYPE.IMG_PNG
      ) {
        createImgFile(formData.value, imgFiles)
      } else if (formData.value.type === FILE_TYPE.MAC_ZIP || formData.value.type === FILE_TYPE.WIN_ZIP) {
        zipContent.value = formData.value
        isZipFileUpload.value = true
      } else if (formData.value.type === FILE_TYPE.MOVIE_MP4) {
        createVideoUrl(formData.value)
      } else if (formData.value.type === FILE_TYPE.APP_JSON) {
        textContent.value = 'JsonFile'
        isTextFileUpload.value = true
      } else if (formData.value.type === FILE_TYPE.TEXT_CSV) {
        textContent.value = 'csvFile'
        isTextFileUpload.value = true
      } else if (formData.value.type === FILE_TYPE.TEXT_XLS || formData.value.type === FILE_TYPE.TEXT_XLSX) {
        textContent.value = 'xlsxFile'
        isTextFileUpload.value = true
      }
    } else {
      resetFiles()
    }
  }
)

watch(
  () => props.data,
  (value) => {
    formData.value = value
    if (formData.value) {
      if (
        formData.value.type === FILE_TYPE.IMG_GIF ||
        formData.value.type === FILE_TYPE.IMG_JPEG ||
        formData.value.type === FILE_TYPE.IMG_JPG ||
        formData.value.type === FILE_TYPE.IMG_PNG
      ) {
        createImgFile(formData.value, imgFiles)
      } else if (formData.value.type === FILE_TYPE.MAC_ZIP || formData.value.type === FILE_TYPE.WIN_ZIP) {
        zipContent.value = formData.value
        isZipFileUpload.value = true
      } else if (formData.value.type === FILE_TYPE.MOVIE_MP4) {
        createVideoUrl(formData.value)
      } else if (formData.value.type === FILE_TYPE.APP_JSON) {
        textContent.value = 'jsonFile'
        isTextFileUpload.value = true
      } else if (formData.value.type === FILE_TYPE.TEXT_CSV) {
        textContent.value = 'csvFile'
        isTextFileUpload.value = true
      } else if (formData.value.type === FILE_TYPE.TEXT_XLS || formData.value.type === FILE_TYPE.TEXT_XLSX) {
        textContent.value = 'xlsxFile'
        isTextFileUpload.value = true
      } else {
        // URLで画像が来た時の処理
        imgUrl.value = formData.value
      }
    } else {
      resetFiles()
    }
  },
  {
    deep: true,
  }
)
//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onMounted(() => {
  resetFiles()
})

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', file: any): void
  (e: 'update:dropValue', item: any): void
  (e: 'update:inputValue', item: any): void
  (e: 'update:deleteValue', item: any): void
  (e: 'update:changeType', item: any, num: number): void
}>()

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
// ドロップエリアにドラッグ下化の判定
function dragEnter() {
  isEnter.value = true
}

// ドロップエリアからドラッグが離れたかの判定
function dragLeave(event: any) {
  if (event.currentTarget.contains(event.relatedTarget)) {
    return
  }
  isEnter.value = false
}

// ドロップエリア上でずっとイベントが発生する
function dragOver() {
  // console.log('drag over')
}

// imgの高さを動的に取得
function onImgLoad(event: any) {
  imgHeight.value = event.target.offsetHeight
}

// videoのアスペクト比を取得するために、縦、横を取得
function onVideoLoad(event: any) {
  videoHeight.value = event.target.videoHeight
  videoWidth.value = event.target.videoWidth
  adjustVideoHeight()
}

// videoのアスペクト比を計算
function adjustVideoHeight() {
  const containerWidth = videoContainer.value.offsetWidth
  const aspectRatio = videoWidth.value / videoHeight.value
  videoHeight.value = containerWidth / aspectRatio
}

// ドロップしたファイルを配列に追加して管理
function dropFile(event: any) {
  const uploadItems = event.dataTransfer.items
  if (uploadItems && uploadItems.length > 0) {
    const file = uploadItems[0].getAsFile()
    const fileType = uploadItems[0].getAsFile().type

    if (selectUpload.value) {
      checkFile(file, fileType)
      emits('update:dropValue', uploadItems)
    } else if (!selectUpload.value && uploadType.value === DROP_TYPE.FORM) {
      const duplicationName = imageNameList.value?.some((item) => item === file.name)
      if (permittedExtensions.value.length > 0) {
        for (let i = 0; i < permittedExtensions.value.length; i++) {
          const extension = permittedExtensions.value[i]
          // ファイルサイズを制限
          // if (fileType === extension && file.size < 5242880) {
          if (fileType === extension && !duplicationName) {
            resetFiles()
            if (
              extension === FILE_TYPE.IMG_GIF ||
              extension === FILE_TYPE.IMG_JPEG ||
              extension === FILE_TYPE.IMG_JPG ||
              extension === FILE_TYPE.IMG_PNG
            ) {
              createImgFile(file, files)
            } else if (extension === FILE_TYPE.MOVIE_MP4) {
              createVideoUrl(file)
            } else if (extension === FILE_TYPE.AUDIO_MP3) {
              createAudioUrl(file)
            } else if (extension === FILE_TYPE.TEXT_TXT) {
              readTextFile(file)
              isTextFileUpload.value = true
            } else if (extension === FILE_TYPE.TEXT_CSV) {
              readTextFile(file)
              isTextFileUpload.value = true
            } else if (extension === FILE_TYPE.TEXT_XLS || extension === FILE_TYPE.TEXT_XLSX) {
              readTextFile(file)
              isTextFileUpload.value = true
            } else if (extension === FILE_TYPE.APP_JSON) {
              readJsonFile(file)
              isTextFileUpload.value = true
            } else if (extension === FILE_TYPE.MAC_ZIP || extension === FILE_TYPE.WIN_ZIP) {
              zipContent.value = file
              isZipFileUpload.value = true
            }
            emits('update:value', file)
            break
          } else if (i === permittedExtensions.value.length - 1) {
            // 許可されている拡張子でない場合、ファイルだけを送信してバリデーションの処理の関係から上位コンポーネントで弾くようにする
            resetFiles()
            emits('update:value', file)
          }
        }
      }
    } else {
      emits('update:dropValue', uploadItems)
    }
  }
  isEnter.value = false
}

// 一度削除して同じファイルをアップロードするとファイルが表示されない。
// そのため、ファイルを削除したあとに、ファイルの読み込みを行うための関数
function resetInput(event: any) {
  event.target.value = ''
}

// inputから追加したファイルを配列に追加
function uploadFile(event: any) {
  const uploadItems = event.target.files
  if (uploadItems && uploadItems.length > 0) {
    const file = uploadItems[0]
    const fileType = uploadItems[0].type

    if (selectUpload.value) {
      checkFile(file, fileType)
      emits('update:inputValue', uploadItems)
    } else if (!selectUpload.value && uploadType.value === DROP_TYPE.FORM) {
      const duplicationName = imageNameList.value?.some((item) => item === file.name)
      if (permittedExtensions.value.length > 0) {
        for (let i = 0; i < permittedExtensions.value.length; i++) {
          const extension = permittedExtensions.value[i]
          // ファイルサイズを制限
          // if (fileType === extension && file.size < 5242880) {
          if (fileType === extension && !duplicationName) {
            resetFiles()
            if (
              extension === FILE_TYPE.IMG_GIF ||
              extension === FILE_TYPE.IMG_JPEG ||
              extension === FILE_TYPE.IMG_JPG ||
              extension === FILE_TYPE.IMG_PNG
            ) {
              createImgFile(file, files)
            } else if (extension === FILE_TYPE.MOVIE_MP4) {
              createVideoUrl(file)
            } else if (extension === FILE_TYPE.AUDIO_MP3) {
              createAudioUrl(file)
            } else if (extension === FILE_TYPE.TEXT_TXT) {
              readTextFile(file)
              isTextFileUpload.value = true
            } else if (extension === FILE_TYPE.TEXT_CSV) {
              readTextFile(file)
              isTextFileUpload.value = true
            } else if (extension === FILE_TYPE.TEXT_XLS || extension === FILE_TYPE.TEXT_XLSX) {
              readTextFile(file)
              isTextFileUpload.value = true
            } else if (extension === FILE_TYPE.APP_JSON) {
              readJsonFile(file)
              isTextFileUpload.value = true
            } else if (extension === FILE_TYPE.MAC_ZIP || extension === FILE_TYPE.WIN_ZIP) {
              zipContent.value = file
              isZipFileUpload.value = true
            }
            emits('update:value', file)
            break
          } else if (i === permittedExtensions.value.length - 1) {
            // 許可されている拡張子でない場合、ファイルだけを送信してバリデーションの処理の関係から上位コンポーネントで弾くようにする
            resetFiles()
            emits('update:value', file)
          }
        }
      }
    } else {
      emits('update:inputValue', uploadItems)
    }
  }
  isEnter.value = false
}

// 追加されたファイルの種類を判別して格納する
function checkFile(file: any, fileType: any) {
  if (fileType.indexOf('image') >= 0) {
    createImgFile(file, imgFiles)
  } else if (fileType.indexOf('text') >= 0) {
    textFiles.value.push({ file: file })
  } else if (fileType.indexOf('audio') >= 0) {
    audioFiles.value.push({ file: file })
  } else if (fileType.indexOf('video') >= 0) {
    movieFiles.value.push({ file: file })
  } else if (fileType.indexOf('zip') >= 0) {
    zipFiles.value.push({ file: file })
  } else if (fileType.indexOf('json') >= 0) {
    jsonFiles.value.push({ file: file })
  } else if (fileType.indexOf('csv') >= 0) {
    csvFiles.value.push({ file: file })
  } else if (fileType.indexOf(FILE_TYPE.TEXT_XLS) >= 0 || fileType.indexOf(FILE_TYPE.TEXT_XLSX) >= 0) {
    xlsFiles.value.push({ file: file })
  }
}

// 画像ファイルに画像の情報（url, height, width）を格納する
function createImgFile(file: any, pushFile: any) {
  const fileURL = URL.createObjectURL(file)
  imgUrl.value = fileURL
  const img = new Image()
  img.onload = () => {
    pushFile.value.push({ file: file, height: img.height, width: img.width })
    URL.revokeObjectURL(fileURL)
  }
  img.src = fileURL
}

// mp4ファイルのurlを作成する
function createVideoUrl(file: any) {
  const fileURL = URL.createObjectURL(file)
  videoUrl.value = fileURL
  return videoUrl.value
}

// mp3ファイルのurlを作成する
function createAudioUrl(file: any) {
  const fileURL = URL.createObjectURL(file)
  audioUrl.value = fileURL
}

// textファイルを読み込む
function readTextFile(file: any) {
  const reader = new FileReader()
  reader.onload = (event) => {
    if (event.target) textContent.value = event.target.result
  }
  reader.readAsText(file)
}

// jsonファイルを読み込む
function readJsonFile(file: any) {
  const reader = new FileReader()
  reader.onload = function (event) {
    const content = event.target?.result
    if (event.target) textContent.value = event.target.result
    if (typeof content === 'string') {
      const obj = JSON.parse(content)
      const json = JSON.stringify(obj)
      return json
    }
  }
  reader.readAsText(file)
}

// ファイルを削除
function deleteFile(item: any) {
  if (selectUpload.value) {
    const fileTypeKey = getFileTypeKey(item.type)
    if (fileTypeKey) {
      fileMap[fileTypeKey].value = fileMap[fileTypeKey].value.filter((file: any) => file.file !== item)
    }
  } else {
    resetFiles()
  }
  emits('update:deleteValue', item)
  imgUrl.value = ''
  videoUrl.value = ''
}

// ファイルのキーを取得する処理
function getFileTypeKey(type: string): string | null {
  for (const key of [
    'image',
    'text',
    'audio',
    'video',
    'zip',
    'json',
    'csv',
    FILE_TYPE.TEXT_XLS,
    FILE_TYPE.TEXT_XLSX,
  ]) {
    if (type.includes(key)) {
      return key
    }
  }
  return null
}

// 画像のURLを生成して、プレビューに表示させる
function imgPreview(item: any) {
  imgUrl.value = URL.createObjectURL(item)
}

// 拡張子を変更
function changeExtension(file: any, i: number, ex: string, type: string) {
  const fileName = file.file.name.match(/(.+?)\.\w+$/)
  const newBlob = new Blob([file.file], { type: type })
  const createFile = new File([newBlob], `${fileName[1]}.${ex}`, { type: newBlob.type })
  if (!selectUpload.value) {
    const newFile = { file: createFile, height: file.height, width: file.width }
    emits('update:changeType', newFile, i)
  } else {
    emits('update:changeType', createFile, i)
  }
}

// 拡張子を判別する処理
function changeType(files: any) {
  const fileType = files.file.type
  if (fileType.indexOf('image') >= 0) {
    return extension.image
  } else if (fileType.indexOf('text') >= 0) {
    return extension.text
  } else if (fileType.indexOf('audio') >= 0) {
    return extension.audio
  } else if (fileType.indexOf('video') >= 0) {
    return extension.movie
  } else if (fileType.indexOf('zip') >= 0) {
    return extension.zip
  } else if (fileType.indexOf('json') >= 0) {
    return extension.json
  } else if (fileType.indexOf('csv') >= 0) {
    return extension.text
  } else if (fileType.indexOf(FILE_TYPE.TEXT_XLS) >= 0) {
    return extension.text
  } else if (fileType.indexOf(FILE_TYPE.TEXT_XLSX) >= 0) {
    return extension.text
  }
}

// すべてのファイルの中身をリセットする処理
function resetFiles() {
  textFiles.value = []
  csvFiles.value = []
  xlsFiles.value = []
  imgFiles.value = []
  audioFiles.value = []
  movieFiles.value = []
  zipFiles.value = []
  jsonFiles.value = []
  files.value = []
  imgUrl.value = ''
  videoUrl.value = ''
  audioUrl.value = ''
  textContent.value = ''
  zipContent.value = ''
  formData.value = undefined
  isTextFileUpload.value = false
  isZipFileUpload.value = false
}
</script>

<style scoped>
.Sample {
  overflow-x: scroll;
}

.UploadArea {
  min-height: 200px;
  max-height: 100%;
  width: 100%;
  margin-bottom: 8px;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #d3d3d3;
  border-radius: 10px;
}
.UploadArea .UploadAreaInner {
  width: 100%;
  height: auto;
  font-weight: bold;
  font-size: 12px;
  text-align: center;
  margin: auto 0;
}
.UploadArea .UploadAreaInner .File {
  position: absolute;
  opacity: 0;
  width: 10px;
}
.UploadArea .UploadAreaInner .FileUploadBtn {
  display: inline-block;
  padding: 15px 25px;
  margin-bottom: 10px;
  background: rgba(var(--r-color-primary));
  color: #fff;
  cursor: pointer;
}
.UploadArea .UploadAreaInner:hover, .UploadArea .UploadAreaInner:focus {
  filter: brightness(1.1);
}

.DisplayArea {
  min-height: 250px;
  max-height: 100%;
  width: 100%;
  margin-bottom: 8px;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #d3d3d3;
  border-radius: 10px;
}
.DisplayArea .DisplayAreaInner {
  width: 100%;
  height: auto;
  font-weight: bold;
  font-size: 12px;
  text-align: center;
  margin: auto 0;
}

.UploadFiles {
  display: flex;
  margin: 0;
  padding: 0;
  list-style-type: none;
}
.UploadFiles .UploadFile {
  width: 150px;
  margin: 0.5em;
  font-size: 10px;
}
.UploadFiles .FilesContainer {
  position: relative;
  text-align: center;
}

.ImgContainer {
  margin: 0 auto;
  width: 100%;
  height: auto;
}

.FileContainer {
  width: 150px;
  position: relative;
  text-align: center;
}

.Delete {
  position: absolute;
  right: 0px;
  font-size: 20px;
  cursor: pointer;
}

.Img {
  width: 100%;
  height: auto;
}

.Video {
  width: 100%;
  height: auto;
}

.Audio {
  width: 100%;
}

.TextContainer {
  width: 100%;
}
.TextContainer .Text {
  width: 100%;
}

.SmallUploadArea {
  min-height: 100px;
  max-height: 100%;
  display: flex;
  justify-content: center;
  background-color: #d3d3d3;
  border-radius: 5px;
}
.SmallUploadArea .SmallUploadAreaInner {
  width: 100%;
  font-weight: bold;
  font-size: 10px;
  text-align: center;
}
.SmallUploadArea .SmallUploadAreaInner .ImgContainer {
  width: 100%;
}
.SmallUploadArea .SmallUploadAreaInner .SmallFile {
  position: absolute;
  opacity: 0;
  width: 10px;
}
.SmallUploadArea .SmallUploadAreaInner .SmallFileUploadBtn {
  display: inline-block;
  padding: 10px 20px;
  margin: 5px 0;
  background: rgba(var(--r-color-primary));
  color: #fff;
  border-radius: 8px;
  cursor: pointer;
}
.SmallUploadArea .SmallUploadAreaInner:hover, .SmallUploadArea .SmallUploadAreaInner:focus {
  filter: brightness(1.1);
}

.SmallDisplayArea {
  min-height: 100px;
  max-height: 100%;
  display: flex;
  justify-content: center;
  background-color: #d3d3d3;
  border-radius: 5px;
}
.SmallDisplayArea .SmallDisplayAreaInner {
  width: 100%;
  font-weight: bold;
  font-size: 10px;
  text-align: center;
}

.Icon {
  position: relative;
}

.Enter {
  background-color: #d3d3d3;
  filter: brightness(1.1);
}

.InputContainer {
  height: auto;
}
</style>
