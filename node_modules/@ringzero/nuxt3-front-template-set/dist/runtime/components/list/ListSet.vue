<template>
  <div class="ListViewSet">
    <div v-if="!noHeader" class="HeaderArea pr-1">
      <div class="FlexStart">
        <div v-if="isSearch || isFilter" class="SearchArea">
          <ListSearch v-if="isSearch" class="mr-3" small></ListSearch>
          <ButtonFilter
            v-show="isFilter"
            class="pl-1"
            :size="28"
            :color="THEME_COLOR.primary"
            :icon="ICONS.FILTER_MENU"
            :opened="FilterSwitch.opened"
            fit
            @click="onOpenFilter()"
          />
        </div>
        <slot name="header" />
      </div>
      <div class="HeaderAction">
        <slot name="headerAction" />
        <NuxtLink v-if="!selectOnly && !notNew" class="LinkButton" @click="onNewRecord">新規作成</NuxtLink>
        <ButtonToggleSet
          :style="{ marginRight: noChoice ? '8px' : '' }"
          :value="density?.toString()"
          @update:value="onChangeDensity($event)"
          :items="densityItems"
          small
        />
        <ButtonIcon
          v-if="!noChoice"
          :icon="'mdi-order-bool-ascending-variant'"
          :size="28"
          :color="useColor(THEME_COLOR.primary)"
          @click="HeaderChoiceSwitch.opened = true"
        />
      </div>
    </div>
    <div class="FilterArea" :style="{ height: `${filterHeight}px` }">
      <slot name="filter">
        <ListFilter
          v-if="isFilter"
          :name="name"
          :switcher="FilterSwitch"
          :headers="headers"
          @update:change-filter="onChangeFilter"
          @update:height="onFilterHeight"
        />
      </slot>
    </div>
    <div
      class="ListTableContainer"
      :style="{
        height: `calc(100% - ${filterHeight}px - 42px)`,
      }"
    >
      <ListDataTable
        v-if="initialize"
        :data="records"
        :headers="headers"
        :name="name"
        :loading="loading"
        :density="density"
        :selectOnly="selectOnly"
        :selecteble="selecteble"
        :dataMax="dataMax"
        :page="page"
        :selectPagePare="selectPagePare"
        @update:page="onPageCount($event)"
        @update:edit="onEditRecord($event)"
        @update:delete="onDeleteRecord($event)"
        @update:sort="onSortRecord($event)"
        @update:custom="onCustomButton($event)"
        @update:reload="onReload()"
        @update:list-check="onListCheck($event)"
      />
    </div>
  </div>

  <ListHeaderChoice :name="name" :switcher="HeaderChoiceSwitch" :headers="headers" :fixedRect="choiceFixedRect" />

  <ListRecordEdit
    :title="title"
    :name="name"
    :switcher="RecordEditSwitch"
    :headers="headers"
    :data="input"
    :base="base"
    :variableRect="variableRect"
    :fixedRect="fixedRect"
    :viewOnly="viewOnly"
    :customCheck="customCheck"
    :error="error"
    :errorCheck="errorCheck"
    :edit="edit"
    :selectOnly="selectOnly"
    @update:edit="onEditMode($event)"
    @update:datas="onDatas($event)"
    @update:post="onPostSubmit($event)"
    @update:put="onPutSubmit($event)"
    @update:check="onCheck($event)"
    @update:reset="onReset($event)"
    @update:auto-input="onAutoInput($event)"
    @update:suggest-create="onSuggestCreate($event)"
  >
    <template #custom="slotProps">
      <slot name="editor" :formDatas="slotProps.formDatas" :edit="slotProps.edit" :onCheck="slotProps.onCheck" />
    </template>
  </ListRecordEdit>
  <PartsDialogWindow
    :switcher="dialogSwitch"
    :buttons="[]"
    :colors="[]"
    :fixedSize="dialogFixedRect"
    :reset="true"
    :title="dialogState.title"
    @update:close="dialogSwitch.opened = false"
    @update:value="onDialogResult($event)"
  >
    <div class="DialogContents">
      <h2 :class="{ errorTXT: dialogState.type === 'delete' }">{{ dialogState.headline }}</h2>
      <div class="row" v-for="item in dialogState.text">
        <div class="title">{{ item?.title }}</div>
        <div class="contents">{{ item?.text }}</div>
      </div>
      <slot name="deleteInfo">
        <p class="mt-4" :style="{ color: 'red', fontWeight: 'bold' }">削除すると復活させることは出来ません！</p>
      </slot>
      <ButtonToggle
        class="mt-1 mb-1 mr-1"
        value="ButtonB"
        :label="'上記の注意事項を確認した'"
        :icon="TOGGLE_TYPE.CHECK"
        :actived="isDeleteCheck"
        @update:value="isDeleteCheck = !isDeleteCheck"
      />
    </div>
    <template #action>
      <div v-show="dialogState.type === 'delete'" class="FormActions">
        <ButtonSimple text="キャンセル" :backcolor="THEME_COLOR.secondary" @click="dialogSwitch.opened = false" />
        <ButtonSimple
          text="削除を実行"
          :backcolor="THEME_COLOR.error"
          @click="isDeleteCheck ? onDialogResult(1) : undefined"
          :disabled="!isDeleteCheck"
        />
      </div>
    </template>
  </PartsDialogWindow>
</template>

<script setup lang="ts">
/**===================================================================================================================
   * 一覧表示セット
===================================================================================================================**/
import {
  type DataTableHeader,
  type baseProps,
  FORM_ITEM,
  TOGGLE_TYPE,
  type VariableSize,
  type FixedSize,
  type ToggleSetProps,
  type DataProps,
} from '../../components/common'
import type { DIALOG_BUTTON, DialogTextProps } from '../../composables/useDialog'
import { THEME_COLOR, ICONS } from '../../composables/constants'
import { useListFilterSetting } from '../../composables/list'
import { ref, watch, type Ref, onMounted } from 'vue'
import { useListDensitySetting } from '../../composables/list'
import { useColor } from '../../composables/colors'
import type { Density } from '../../types'
import type { ErrorCheckSwitch, ModalSwitch } from '../../types'
import ListListSearch from '../list/ListSearch.vue'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  name: string
  title: string
  data?: any
  headers: DataTableHeader[]
  base: baseProps
  loading?: boolean
  variableRect: VariableSize
  selectPagePare?: { text: string; value: number }[]
  fixedRect?: any
  dialogFixedRect?: any
  choiceFixedRect?: any
  selectOnly?: boolean
  selecteble?: boolean
  isSearch?: boolean
  isFilter?: boolean
  notNew?: boolean
  noChoice?: boolean
  noHeader?: boolean
  newCustom?: boolean
  viewOnly?: boolean
  customCheck?: Function
  error?: boolean
  dataMax?: number
  errorCheck?: ErrorCheckSwitch
  filterHeightBase?: number
  page?: number
}
const props = withDefaults(defineProps<Props>(), {
  title: '',
  selectOnly: false,
  isSearch: false,
  isFilter: false,
  dataMax: 0,
  dialogFixedRect: {
    justify: 'center',
    align: 'center',
    offsetX: '0px',
    offsetY: '-100px',
    width: '400px',
    height: '300px',
  },
})

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const filterSetting = useListFilterSetting()
const densitySetting = useListDensitySetting()
const HeaderChoiceSwitch: Ref<ModalSwitch> = ref({ opened: false })
const FilterSwitch: Ref<ModalSwitch> = ref({ opened: false })
const RecordEditSwitch: Ref<ModalSwitch> = ref({ opened: false })
const dialogSwitch: Ref<ModalSwitch> = ref({ opened: false })
const records: Ref<any[]> = ref(props.data)
const input: Ref<DataProps> = ref({ new: true })
const initialize = ref(false)
const filterHeight = ref(props.filterHeightBase || 0)
const filterHeightBase = ref(props.filterHeightBase || 0)
const edit = ref()

const headerObjects: Ref<{ [key: string]: DataTableHeader }> = ref({})
const dialogState: Ref<DialogTextProps> = ref({
  id: '',
  type: 'delete',
  title: '削除の確認',
  headline: '以下を削除します。よろしいですか？',
  text: [],
})

const densityItems: ToggleSetProps[] = [
  { text: '広', value: 'default' },
  { text: '並', value: 'comfortable' },
  { text: '狭', value: 'compact' },
]

const density: Ref<Density> = ref(densitySetting.value.density)
const isDeleteCheck = ref(false)
function onChangeDensity(item: any) {
  densitySetting.value.density = item.value
  density.value = item.value
}
//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onMounted(() => {
  props.headers?.forEach((head) => {
    headerObjects.value[head.key] = head
    // if (choiceCheck(head.key)) isFilter.value = true
  })

  initialize.value = true
  if (filterSetting.value[props.name]) {
    FilterSwitch.value.opened = filterSetting.value[props.name].opened
  }
  density.value = densitySetting.value.density
})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.data,
  (value) => {
    if (value) {
      records.value = value
    }
  },
  {
    deep: true,
  }
)

watch(
  () => densitySetting.value,
  (value) => {
    density.value = value.density
  },
  {
    deep: true,
  }
)

watch(
  () => props.errorCheck,
  (value) => {
    if (!value?.isError) {
      edit.value = 'submit'
      RecordEditSwitch.value.opened = false
    }
  },
  {
    deep: true,
  }
)

//------------------------------------------------------------------------------------------------------------
// computed
//------------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function onNewRecord() {
  //レコードの新規作成
  if (props.newCustom) {
    emits('update:custom', { key: 'new' })
  } else {
    RecordEditSwitch.value.opened = true
    input.value = { new: true }
    emits('update:new', {})
  }
}

async function onEditRecord(value: any) {
  const data = value
  input.value = { new: false, data: data }
  RecordEditSwitch.value.opened = true
  emits('update:edit', { data: value })
}

function onEditMode(value: any) {
  emits('update:editMode', value)
}

function onOpenFilter() {
  FilterSwitch.value.opened = !FilterSwitch.value.opened
  if (FilterSwitch.value.opened) {
    filterHeight.value = filterHeightBase.value
  } else {
    filterHeight.value = 0
  }
}

function onChangeFilter(value: { key: string; value: any[] }) {
  emits('update:filter', value)
}
function onFilterHeight(value: any) {
  filterHeightBase.value = value
  if (FilterSwitch.value.opened) {
    filterHeight.value = value
  }
}

function onDeleteRecord(value: any) {
  // 確認ダイアログを出す
  dialogState.value = {
    type: 'delete',
    id: value.id,
    title: '削除の確認',
    headline: '以下を削除します。よろしいですか？',
    text: [],
    data: value,
  }
  for (const i in props.headers) {
    if (props.headers[i].dialog) {
      const key = props.headers[i].key
      dialogState.value.text.push({ title: props.headers[i].title, text: value[key] })
    }
  }
  isDeleteCheck.value = false
  dialogSwitch.value.opened = true
}

function onDialogResult(value: any) {
  if (dialogState.value.type === 'delete' && value > 0) {
    emits('update:delete', dialogState.value.data)
    dialogSwitch.value.opened = false
  }
}

//CheckやRadioといった、Choice系の判断
function choiceCheck(key: string) {
  let result = false
  const item = headerObjects.value[key]
  if (item) {
    if (
      item.type === FORM_ITEM.CHECK_GROUP ||
      item.type === FORM_ITEM.RADIO_GROUP ||
      item.type === FORM_ITEM.SELECT_CHECK ||
      item.type === FORM_ITEM.SELECT_MENU ||
      item.type === FORM_ITEM.ASSOCIATE_SELECT_MENU ||
      item.type === FORM_ITEM.ASSOCIATE_SELECT_CHECK
    ) {
      result = true
    }
  }
  return result
}

function onHeaderChoiceOpen() {
  HeaderChoiceSwitch.value.opened = true
}

//コンポーネントのメソッドとして、外からアクセスできるようにする
defineExpose({ onNewRecord, onChangeDensity, onHeaderChoiceOpen })
//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------

const emits = defineEmits<{
  (e: 'update:page', item: number): void
  (e: 'update:isNew', item: boolean): void
  (e: 'update:datas', item: any): void
  (e: 'update:file', item: any): void
  (e: 'update:edit', item: any): void
  (e: 'update:editMode', item: any): void
  (e: 'update:new', item: any): void
  (e: 'update:delete', item: any): void
  (e: 'update:sort', item: any): void
  (e: 'update:check', item: any): void
  (e: 'update:post', item: { [key: string]: string }): void
  (e: 'update:put', item: { [key: string]: string }): void
  (e: 'update:custom', item: any): void
  (e: 'update:reload', item: boolean): void
  (e: 'update:reset', item: any): void
  (e: 'update:autoInput', value: { key: string; code: string }): void
  (e: 'update:filter', value: { key: string; value: any[] }): void
  (e: 'update:listCheck', item: { key: string; formValue: any }): void
  (e: 'update:suggestCreate', value: string): void
}>()

function onAutoInput(value: { key: string; code: string }) {
  emits('update:autoInput', value)
}

function onSortRecord(value: any) {
  emits('update:sort', value)
}

function onPostSubmit(value: any) {
  emits('update:post', value)
}

function onCheck(value: any) {
  emits('update:check', value)
}

function onPutSubmit(value: any) {
  emits('update:put', value)
}

function onCustomButton(value: any) {
  emits('update:custom', value)
}

function onReload() {
  emits('update:reload', true)
}

function onReset(value: any) {
  emits('update:reset', value)
}

function onListCheck(value: any) {
  emits('update:listCheck', value)
}

function onDatas(value: any) {
  emits('update:isNew', input.value.new)
  emits('update:datas', value)
}

function onPageCount(value: number) {
  emits('update:page', value)
}

function onSuggestCreate(value: any) {
  emits('update:suggestCreate', value)
}
</script>

<style scoped>
.ListViewSet {
  position: relative;
  padding: 16px;
  padding-right: 8px;
  height: calc(100% - 34px);
}
.ListViewSet .HeaderArea {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  height: 36px;
  z-index: 11;
}
.ListViewSet .SearchArea {
  position: relative;
  display: flex;
  justify-content: flex-start;
  align-items: center;
  height: 32px;
}
.ListViewSet .FilterArea {
  position: relative;
  width: 100%;
  padding-left: 40px;
  transition: height 0.2s ease-out;
  overflow: hidden;
  margin-bottom: 0px;
}
.ListViewSet .ListTableContainer {
  position: relative;
  width: 100%;
  height: calc(100% - 42px);
  transition: height 0.2s ease-out;
}
.ListViewSet .HeaderAction {
  position: relative;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  height: 32px;
}
.ListViewSet .LinkButton {
  color: rgba(var(--r-color-primary));
  padding-top: 2px;
  line-height: 14px;
  font-size: 14px;
  margin-right: 12px;
  text-decoration: underline;
}
.ListViewSet .LinkButton:active {
  color: rgb(var(--r-color-primary), 0.9);
}
.ListViewSet .LinkButton:hover {
  color: rgba(var(--r-color-primary), 0.8);
}

.FormActions {
  position: absolute;
  display: flex;
  width: 100%;
  height: 76px;
  bottom: -10px;
  justify-content: space-around;
  padding: 20px 40px 0px;
}
</style>
