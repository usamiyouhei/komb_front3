<template>
  <div class="FormProvider">
    <template v-for="(item, i) in headers" :key="i">
      <template
        v-if="
          item.key !== FORM_ITEM.ACTION &&
          item.key !== FORM_ITEM.DELETE &&
          item.key !== FORM_ITEM.BLANK &&
          !item.listOnly &&
          !(item.editOnly && isNew) &&
          !item.hidden &&
          !item.noform &&
          (!item.formShowFunction || item.formShowFunction())
        "
      >
        <FormName
          v-if="item.type === FORM_ITEM.NAME"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormName
          v-else-if="item.type === FORM_ITEM.KANA"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :kana="true"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormEmail
          v-else-if="item.type === FORM_ITEM.EMAIL"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormPhone
          v-else-if="item.type === FORM_ITEM.TEL"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormZipcode
          v-else-if="item.type === FORM_ITEM.ZIPCODE"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
          @update:auto-input="onAutoInput($event)"
        />

        <FormInvoice
          v-else-if="item.type === FORM_ITEM.INVOICE"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          :input-type="item.formParamFunction ? item.formParamFunction(formDatas[item.key].defaultValue) : 'invoice'"
          @update:value="onChange(item.key)"
        />

        <FormNumeric
          v-else-if="item.type === FORM_ITEM.NUMERIC"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :countMin="item.min"
          :countMax="item.max"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormDateTime
          v-else-if="item.type === FORM_ITEM.DATETIME"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormDate
          v-else-if="item.type === FORM_ITEM.DATE"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormTime
          v-else-if="item.type === FORM_ITEM.TIME"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormSelectTime
          v-else-if="item.type === FORM_ITEM.SELECTTIME"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :time="item.time"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormFilePicker
          v-else-if="item.type === FORM_ITEM.FILE"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :dataList="item.dataList"
          :extensions="item.extensions"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:file="updateFile($event)"
          @update:value="onChange(item.key)"
        />

        <FormMultiFileDragger
          v-else-if="item.type === FORM_ITEM.MULTI_FILE"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :extensions="item.extensions"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          :min="item.min"
          :max="item.max"
          @update:files="updateFile($event)"
          @update:value="onChange(item.key)"
        />

        <FormRadioGroup
          v-else-if="item.type === FORM_ITEM.RADIO_GROUP"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :items="item.contents"
          :inline="true"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormCheckBox
          v-else-if="item.type === FORM_ITEM.CHECK_BOX"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="formDatas[item.key].notitle ? FORM_MODE.SIMPLE : base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :items="item.contents"
          :text="item.contents ? item.contents[0].text : ''"
          :inline="true"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormCheckGroup
          v-else-if="item.type === FORM_ITEM.CHECK_GROUP"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :items="item.contents"
          :inline="true"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormSelectCheck
          v-else-if="item.type === FORM_ITEM.SELECT_CHECK"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :items="item.contents || []"
          :height="item.floatCard?.height"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          fit
          @update:value="onChange(item.key)"
        />

        <FormSelectMenu
          v-else-if="item.type === FORM_ITEM.SELECT_MENU"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :inputType="item.inputType"
          :selectType="item.selectType"
          :data="formDatas[item.key]"
          :label="item.title"
          :items="item.getContents ? item.getContents() : item.contents || []"
          :height="item.floatCard?.height"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          fit
          @update:value="onChange(item.key)"
        />

        <FormSuggestSelectMenu
          v-else-if="item.type === FORM_ITEM.SUGGEST_SELECT_MENU"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :items="item.getContents ? item.getContents() : item.contents || []"
          :height="item.floatCard?.height"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          :noNewLink="item.noNewLink"
          fit
          @update:value="onChange(item.key)"
          @update:suggest-create="onSuggestCreate(item.key)"
        />

        <FormAssociateSelectCheck
          v-else-if="item.type === FORM_ITEM.ASSOCIATE_SELECT_CHECK"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :items="item.contentObjects || {}"
          :associate="checkItemType(formDatas, item.associateKey)"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          fit
          @update:value="onChange(item.key)"
        />

        <FormAssociateSelectMenu
          v-else-if="item.type === FORM_ITEM.ASSOCIATE_SELECT_MENU"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :items="item.contentObjects || {}"
          :associate="checkItemType(formDatas, item.associateKey)"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          fit
          @update:value="onChange(item.key)"
        />

        <FormTextArea
          v-else-if="item.type === FORM_ITEM.TEXTAREA"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :row="item.row"
          :resize="item.resize"
          :maskColor="'rgb(var(--r-color-background))'"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormAccessoryTermsCheck
          v-else-if="item.type === FORM_ITEM.TERMS_CHECK && !formDatas[item.key].hidden"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :color="item.color"
          :margin="item.margin"
          :value="item.contents"
          :data="formDatas[item.key]"
          :base="base"
          :hint="item.hint"
          :hintchip="item.hintchip"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormAccessoryHeadLine
          v-else-if="item.type === FORM_ITEM.HEADLINE"
          :color="item.color"
          :margin="item.margin"
          :title="item.title"
          :subtitle="
            item.subtitlekey && formDatas[item.subtitlekey].value
              ? formDatas[item.subtitlekey].label + ':' + formDatas[item.subtitlekey].value
              : undefined
          "
        />

        <FormAccessoryBlankColumn v-else-if="item.type === FORM_ITEM.BLANK_COLUMN" :base="base" />

        <FormAccessoryLine v-else-if="item.type === FORM_ITEM.LINE" :color="item.color" :margin="item.margin" />

        <FormAccessoryAttention
          v-else-if="item.type === FORM_ITEM.ATTENTION"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :color="item.color"
          :margin="item.margin"
          :value="item.contents"
          :list="item.list"
        />

        <FormAccessoryComment
          v-else-if="item.type === FORM_ITEM.COMMENT"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :color="item.color"
          :margin="item.margin"
          :value="item.contents"
          :list="item.list"
        />

        <FormAccessoryWarning
          v-else-if="item.type === FORM_ITEM.WARNING"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :color="item.color"
          :margin="item.margin"
          :value="item.contents"
          :list="item.list"
        />

        <FormAccessoryNote
          v-else-if="item.type === FORM_ITEM.NOTE"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :color="item.color"
          :margin="item.margin"
          :value="item.contents"
          :list="item.list"
        />
        <FormAccessoryModalLink
          v-else-if="item.type === FORM_ITEM.MODAL_LINK"
          :color="item.color"
          :margin="item.margin"
          :value="item.contents"
        />

        <FormPassword
          v-else-if="item.type === FORM_ITEM.PASSWORD"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :hint="item.hint"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />

        <FormInput
          v-else-if="!formDatas[item.key].hidden"
          class="FormProviderItem"
          :edit="
            (!formDatas[item.key].readOnly || (item.readOnlyFunction && !item.readOnlyFunction())) && mode === 'edit'
          "
          :base="base"
          :mode="base.mode"
          :data="formDatas[item.key]"
          :label="item.title"
          :hint="item.hint"
          :col-width="item.colWidth"
          @update:value="onChange(item.key)"
        />
      </template>
    </template>
  </div>
</template>

<script setup lang="ts">
/**===================================================================================================================
   *
  <div v-if="isDebug" class="debugInfo">
    {{ formDatas[item.key] }}
  </div>
===================================================================================================================**/

import {
  type DataTableHeader,
  FORM_ITEM,
  type formItem,
  type baseProps,
  FORM_MODE,
  type VariableSize,
  type FixedSize,
  type DataProps,
} from '../../components/common'
import { ref, watch, type Ref } from 'vue'
import { isDark } from '../../composables/colors'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  headers: DataTableHeader[]
  base: baseProps
  edit: string
  isNew: boolean
  datas: { [key: string]: formItem }
  debug: boolean
}
const props = withDefaults(defineProps<Props>(), {})
const formDatas: Ref<{ [key: string]: formItem }> = ref(props.datas)
const isDebug = ref(props.debug)
//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const mode = ref(props.edit)
//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
/*
  onBeforeMount(() => {
    //記憶した位置、サイズでの復帰を可能にする
  })

  onMounted(() => {
    //window.addEventListener('resize', onGetPosition)
  })

  onBeforeUnmount(() => {
    //window.removeEventListener('resize', onGetPosition)
  })
  */
//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.debug,
  (value) => {
    isDebug.value = value
  }
)

watch(
  () => props.edit,
  (value) => {
    mode.value = value
  }
)

watch(
  () => props.datas,
  (value) => {
    formDatas.value = value
  }
)

//------------------------------------------------------------------------------------------------------------
//computed
//------------------------------------------------------------------------------------------------------------
/*
  const counter: Ref<number> = useState('counter', () => 500)

  // computedによりcounter変数の監視が行われる
  const doubleCount = computed(() => {
    return counter.value * 2
  })
  */
//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:file', item: any): void
  (e: 'update:change', item: any): void
  (e: 'update:autoInput', value: { key: string; code: string }): void
  (e: 'update:suggestCreate', value: any): void
}>()

function onChange(value: any) {
  emits('update:change', value)
}

function onSuggestCreate(value: any) {
  emits('update:suggestCreate', value)
}

function onAutoInput(value: { key: string; code: string }) {
  emits('update:autoInput', value)
}

function updateFile(value: any) {
  emits('update:file', value)
}

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function checkItemType(datas: any, key?: string) {
  if (!key) {
    return undefined
  }
  return datas[key].value
}
</script>

<style scoped>
.FormContent {
  position: relative;
}

.half {
  position: relative;
  width: 50%;
}

.debugInfo {
  position: relative;
  width: 50%;
  margin-left: 10px;
  height: 40px;
  margin-bottom: 12px;
  border: 1px solid rgba(var(--r-color-line));
  padding: 4px;
  font-size: 10px;
}

.FormProviderItem {
  margin-bottom: 16px;
}
</style>
