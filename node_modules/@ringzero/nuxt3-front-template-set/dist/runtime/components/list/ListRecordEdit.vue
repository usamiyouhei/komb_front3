<template>
  <ClientOnly>
    <template v-if="isWindow">
      <teleport to="#modal-area">
        <PartsModalWindow
          :name="'ListRecordEdit-' + name"
          :level="0"
          :title="data?.new ? title + 'の新規作成' : title + `のデータ編集`"
          :switcher="switcher"
          :modeless="true"
          :fixed="false"
          :variableSize="variable"
          :reset="isReset"
          :small="true"
          :scroll="false"
        >
          <template #header>
            <div v-if="false && NODE_ENV === 'development'" class="Debug" @click="changeDebug()">debug</div>
          </template>
          <template #title><slot name="title" /> </template>
          <div :id="`${name}-ListRecordInnerContents`" class="ListRecordWindowInner" />
        </PartsModalWindow>
      </teleport>
    </template>
    <template v-else>
      <div :id="`${name}-ListRecordInnerContents`" class="ListRecordViewInner" />
    </template>

    <teleport :to="`#${name}-ListRecordInnerContents`">
      <div class="FormItems">
        <div class="FormScroll">
          <ListFormProvider
            :headers="headers"
            :base="base"
            :edit="mode"
            :is-new="props.data.new"
            :datas="formDatas"
            :debug="isDebug"
            @update:file="updateFile($event)"
            @update:change="onChange($event)"
            @update:auto-input="onAutoInput($event)"
            @update:suggest-create="onSuggestCreate($event)"
          />
          <slot name="custom" :formDatas="formDatas" :edit="mode" :onCheck="onCheck" />
        </div>
        <div class="FormActions" v-if="selectOnly">
          <ButtonSimple
            class="mr-2"
            :backcolor="useColor(THEME_COLOR.error)"
            text="閉じる"
            @click="switcher.opened = false"
          />
        </div>
        <div class="FormActions" v-else-if="mode === 'view'">
          <ButtonSimple
            v-if="isWindow"
            class="mr-2"
            :backcolor="useColor(THEME_COLOR.error)"
            text="閉じる"
            @click="switcher.opened = false"
          />
          <div v-else />
          <ButtonSimple
            v-if="!viewOnly"
            :backcolor="useColor(THEME_COLOR.primary)"
            text="編集"
            :width="140"
            @click="mode = 'edit'"
          />
        </div>
        <div class="FormActions" v-else-if="mode === 'edit'">
          <ButtonSimple
            v-if="isWindow"
            class="mr-2"
            :backcolor="useColor(THEME_COLOR.error)"
            text="閉じる"
            @click="switcher.opened = false"
          />
          <div v-else />

          <div class="FlexStart">
            <ButtonSimple
              v-if="!isNew"
              class="mr-4"
              :backcolor="useColor(THEME_COLOR.secondary)"
              text=" 戻る "
              @click="
                () => {
                  onReset(true)
                  mode = 'view'
                }
              "
            />
            <ButtonSimple
              class="mr-4"
              :style="{ marginTop: '6px' }"
              :backcolor="useColor(THEME_COLOR.secondary)"
              text="リセット"
              small
              @click="onReset(true)"
            />
            <ButtonSimple
              :backcolor="useColor(THEME_COLOR.primary)"
              text="送信"
              :width="140"
              :disabled="isError"
              @click="!isError ? onSubmit() : undefined"
            />
          </div>
        </div>
        <div class="FormActions" v-else-if="mode === 'submit'">
          <ButtonSimple class="mr-2" :backcolor="useColor(THEME_COLOR.secondary)" text="戻る" @click="mode = 'edit'" />
          <ButtonSimple
            v-if="isWindow"
            class="mr-2"
            :backcolor="useColor(THEME_COLOR.error)"
            text="閉じる"
            @click="switcher.opened = false"
          />
        </div>
      </div>
    </teleport>
  </ClientOnly>
</template>

<script setup lang="ts">
/**===================================================================================================================
   *
  ===================================================================================================================**/
import {
  type DataTableHeader,
  TABLE_ITEM_KEY,
  FORM_ITEM,
  type formItem,
  type baseProps,
  type ToggleProps,
  TOGGLE_TYPE,
  type VariableSize,
  type FixedSize,
  type DataProps,
} from '../../components/common'
import { ref, watch, type Ref, onMounted } from 'vue'
import { RULE } from '../../composables/validation'
import { useCreateFormData } from '../../composables/formUtility'
import { THEME_COLOR } from '../../composables/constants'
import { useColor } from '../../composables/colors'
import type { ErrorCheckSwitch, ModalSwitch } from '../../types'

//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  name: string
  title: string
  switcher: ModalSwitch
  headers: DataTableHeader[]
  base: baseProps
  data: DataProps
  edit?: string
  error?: boolean
  errorCheck?: ErrorCheckSwitch
  variableRect: VariableSize
  fixedRect?: FixedSize
  viewOnly?: boolean
  customCheck?: Function
  selectOnly?: boolean
  isWindow?: boolean
}
const props = withDefaults(defineProps<Props>(), {
  edit: 'new',
  isWindow: true,
})
//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const isReset = ref(false)
// サイズ変更＆可動ダイアログ

const input: Ref<{ [key: string]: boolean }> = ref({})
const isCheck = ref(false)
const isError = ref(true)
const isDebug = ref(false)
const variable = ref(JSON.parse(JSON.stringify(props.variableRect)))
const isNew = ref(false)
const NODE_ENV = process.env.NODE_ENV
const mode = ref('edit')

//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onMounted(() => {
  createFormData(props.headers, props.data)
  emits('update:edit', mode.value)
})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.data,
  (value) => {
    createFormData(props.headers, value)
    switchDebug()
  },
  { deep: true }
)

watch(
  () => props.edit,
  (value) => {
    mode.value = value
  }
)

watch(
  () => mode,
  (value) => {
    emits('update:edit', mode.value)
  },
  { deep: true }
)

watch(
  () => props.error,
  (value) => {
    isError.value = value
  },
  { deep: true }
)

//------------------------------------------------------------------------------------------------------------
//computed
//------------------------------------------------------------------------------------------------------------
/*
  const counter: Ref<number> = useState('counter', () => 500)

  // computedによりcounter変数の監視が行われる
  const doubleCount = computed(() => {
    return counter.value * 2
  })
  */

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------

const formDatas: Ref<{ [key: string]: formItem }> = ref({})

function createFormData(headers: any, value: any) {
  // フォームデータを作成する
  isNew.value = value.new
  formDatas.value = {}
  const { error, view } = useCreateFormData(headers, value, formDatas)
  // formDatas.value = datas
  isError.value = error
  mode.value = view
  // console.log('Formデータの作成')
  emits('update:datas', formDatas)
}

function onChange(key: string) {
  onCheck(key)
}

function onCheck(key?: string) {
  const keys = JSON.parse(JSON.stringify(Object.values(TABLE_ITEM_KEY)))
  // console.log(formDatas.value)

  isError.value = false
  for (const key in formDatas.value) {
    if ((key === 'id' && !formDatas.value['id']?.readOnly) || !keys.includes(key)) {
      if (
        (formDatas.value[key].rule?.includes(RULE.required) && formDatas.value[key].isCheck === false) ||
        formDatas.value[key].error
      ) {
        // console.log('エラー', key, formDatas.value[key].isCheck, formDatas.value[key].error)
        isError.value = true
      }
      // new
      // 必須項目で未チェックはNG
      // エラーがあるのもNG

      // 既存データは、全てCheck済みなので、エラーの有無だけチェック
    }
  }
  if (props.customCheck && !props.customCheck()) {
    isError.value = true
  }
  // console.log('エラーは？', isError.value)
  emits('update:check', { datas: formDatas, error: isError, key })
}

function changeDebug() {
  isDebug.value = !isDebug.value
  switchDebug()
}
function switchDebug() {
  if (isDebug.value && props.variableRect.width) {
    variable.value.width = props.variableRect.width * 2
    variable.value.minWidth = variable.value.width * 0.8
    variable.value.maxWidth = variable.value.width * 1.5
  } else {
    variable.value.width = props.variableRect.width
  }
}

function onReset(check: boolean = false) {
  const value = props.data
  for (let i = 0; i < props.headers.length; i++) {
    // console.log('リセット', value.data)
    const key = props.headers[i].key
    if (!value.new && value.data) {
      if (value.data[key] !== undefined && formDatas.value[key] !== undefined) {
        formDatas.value[key].value = JSON.parse(JSON.stringify(value.data[key]))
        formDatas.value[key].values = Array.isArray(value.data[key])
          ? JSON.parse(JSON.stringify(value.data[key]))
          : undefined
        formDatas.value[key].error = ''
        formDatas.value[key].isCheck = true
      }
    } else {
      if (formDatas.value[key] !== undefined) {
        // console.log('リセット', key)
        formDatas.value[key].value = ''
        formDatas.value[key].values = undefined
        formDatas.value[key].error = ''
        formDatas.value[key].isCheck = false
        formDatas.value[key].onCheck = 'clear'
        formDatas.value[key].fileValue = undefined
        formDatas.value[key].fileValues = undefined
      }
    }
  }
  emits('update:reset', value)
  if (check) isError.value = true
}

function onSubmit() {
  // if (!props.errorCheck) {
  mode.value = 'submit'
  // }

  //アクセサリー系は除外し、送信に必要なデータだけにする
  const submitData: { [key: string]: string } = {}

  const keys = JSON.parse(JSON.stringify(Object.values(TABLE_ITEM_KEY)))
  keys.push(FORM_ITEM.TERMS_CHECK)
  for (const key in formDatas.value) {
    if (isNew.value) {
      if (
        (key === 'id' && !formDatas.value[key].readOnly) ||
        (!keys.includes(key) && (!formDatas.value[key].readOnly || formDatas.value[key].output))
      ) {
        submitData[key] = formDatas.value[key].values?.join(',') || formDatas.value[key].value || ''
      }
    } else {
      if (key === 'id' || (!keys.includes(key) && (!formDatas.value[key].readOnly || formDatas.value[key].output))) {
        submitData[key] = formDatas.value[key].values?.join(',') || formDatas.value[key].value || ''
      }
    }
  }
  if (isNew.value) {
    emits('update:post', submitData)
  } else {
    // もしIDが書き換え可能な場合
    if (!formDatas.value['id'].readOnly) {
      // console.log('旧ID', JSON.parse(JSON.stringify(props.data.data['id'])))
      submitData.oldId = JSON.parse(JSON.stringify(props.data.data['id']))
    }
    emits('update:put', submitData)
  }
  if (!props.errorCheck || isNew.value) {
    props.switcher.opened = false
  }
}
//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:file', item: any): void
  (e: 'update:post', item: { [key: string]: string }): void
  (e: 'update:put', item: { [key: string]: string }): void
  (e: 'update:autoInput', value: { key: string; code: string }): void
  (e: 'update:check', item: any): void
  (e: 'update:datas', item: any): void
  (e: 'update:edit', item: any): void
  (e: 'update:suggestCreate', status: any): void
  (e: 'update:reset', item: any): void
}>()

function onAutoInput(value: { key: string; code: string }) {
  emits('update:autoInput', value)
}
//コンポーネントのメソッドとして、外からアクセスできるようにする
defineExpose({ onCheck })

function updateFile(value: any) {
  emits('update:file', value)
}

function onSuggestCreate(value: any) {
  emits('update:suggestCreate', value)
}
</script>

<style scoped>
.FormItems {
  position: relative;
  width: 100%;
  height: 100%;
}
.FormItems .FormScroll {
  position: relative;
  width: 100%;
  height: calc(100% - 56px);
  position: relative;
  overflow-y: scroll;
  overflow-x: hidden;
  background-color: rgba(var(--r-color-background), 1);
  padding: 20px 20px;
}
.FormItems .FormActions {
  position: absolute;
  display: flex;
  width: 100%;
  height: 76px;
  bottom: -20px;
  justify-content: space-between;
  padding: 20px 40px 0px;
  background-color: rgba(var(--r-color-background), 1);
}

.Debug {
  text-decoration: underline;
  color: rgba(var(--r-color-reverse), 1);
  font-size: 12px;
  cursor: pointer;
  margin-top: 2px;
  margin-right: 10px;
  pointer-events: auto;
}

.ListRecordWindowInner {
  position: relative;
  width: 100%;
  height: 100%;
}

.ListRecordViewInner {
  position: relative;
  width: 100%;
  height: 100%;
}
</style>
