<template>
  <div v-if="initialize" class="ListTable">
    <v-data-table
      v-model:items-per-page="itemsPerPage"
      height="100%"
      :headers="headers"
      :items="input"
      item-value="name"
      :density="density || 'default'"
      :page="nowPage"
      :hide-no-data="loading"
      class="ListDataTabel"
      no-data-text="データが登録されていません"
      :class="{ SelectOnly: selectOnly, Selecteble: selecteble }"
    >
      <!-- header部分 -->
      <template #headers="{ columns, isSorted, getSortIcon, toggleSort }">
        <!--
          <tr>
            <th colspan="9">{{ columns }}</th>
          </tr>
          -->
        <tr>
          <template v-for="column in columns" :key="column.key">
            <th
              v-if="
                column &&
                column.key &&
                (columnSetting.value[name]?.columns[column.key] ||
                  !headers?.find((obj: any) => obj.key === column.key)?.choice) &&
                !headers?.find((obj: any) => obj.key === column.key)?.disabled &&
                !headers?.find((obj: any) => obj.key === column.key)?.hidden &&
                !headers?.find((obj: any) => obj.key === column.key)?.nolist &&
                column.key !== TABLE_ITEM_KEY.DELETE &&
                column.key !== TABLE_ITEM_KEY.COMMENT &&
                column.key !== TABLE_ITEM_KEY.NOTE &&
                column.key !== TABLE_ITEM_KEY.ATTENTION &&
                column.key !== TABLE_ITEM_KEY.WARNING &&
                column.key !== TABLE_ITEM_KEY.LINE &&
                column.key !== TABLE_ITEM_KEY.HEADLINE &&
                column.key !== TABLE_ITEM_KEY.BLANK_COLUMN &&
                column.key !== TABLE_ITEM_KEY.MODAL_LINK &&
                column.key !== TABLE_ITEM_KEY.ACTION &&
                column.key !== TABLE_ITEM_KEY.OSS_THUMBNAIL &&
                column.key !== FORM_ITEM.TERMS_CHECK
              "
              :class="{ blank: column.key === FORM_ITEM.BLANK }"
              :style="{
                width: headers?.find((obj: any) => obj.key === column.key)?.strWidth,
                minWidth: column.minWidth,
                maxWidth: column.maxWidth,
                cursor: column.sortable ? 'pointer' : 'auto',
              }"
            >
              <div
                class="headInner"
                :class="{
                  alignStart: column.align === 'start',
                  alignCenter: column.align === 'center',
                  alignEnd: column.align === 'end',
                  fixed: column.fixed,
                }"
                :style="{
                  paddingLeft: column.key === FORM_ITEM.BLANK ? '1px !important' : undefined,
                  paddingRight: column.key === FORM_ITEM.BLANK ? '0 !important' : undefined,
                }"
                @click="
                  async () => {
                    if (column.sortable) {
                      const tempPage = nowPage
                      nowPage = 1
                      toggleSort(column)
                      await $nextTick()
                      // await delay.wait(1000 * 0.2)
                      nowPage = tempPage
                    }
                  }
                "
              >
                <div
                  :style="{
                    marginLeft: column.align === 'center' && column.sortable ? '16px' : '0px',
                    whiteSpace: 'pre',
                    textAlign: column.align,
                  }"
                >
                  {{ column.title }}
                </div>
                <div v-if="column.sortable" class="Icon">
                  <v-icon
                    :size="14"
                    :icon="isSorted(column) ? getSortIcon(column) : 'mdi-minus'"
                    :color="isSorted(column) ? useColor(THEME_COLOR.color) : useColor(THEME_COLOR.color)"
                    :style="{ opacity: isSorted(column) ? 1 : 0.2 }"
                  ></v-icon>
                </div>
              </div>
            </th>
            <th
              v-else-if="column.key === TABLE_ITEM_KEY.OSS_THUMBNAIL"
              class="Thumbnail"
              :style="{
                width: headers?.find((obj: any) => obj.key === column.key)?.strWidth,
                minWidth: column.minWidth,
                maxWidth: column.maxWidth,
              }"
            >
              <div
                class="headInner"
                :class="{
                  alignStart: column.align === 'start',
                  alignCenter: column.align === 'center',
                  alignEnd: column.align === 'end',
                  fixed: column.fixed,
                }"
              >
                <v-icon icon="mdi-image-outline" size="24" :style="{ opacity: 0.5 }" />
              </div>
            </th>
            <th
              v-else-if="column.key === TABLE_ITEM_KEY.DELETE"
              class="Delete"
              :style="{
                width: headers?.find((obj: any) => obj.key === column.key)?.strWidth,
                minWidth: column.minWidth,
                maxWidth: column.maxWidth,
              }"
            ></th>
            <th
              v-else-if="column.key === TABLE_ITEM_KEY.ACTION"
              class="Action"
              :style="{
                width: headers?.find((obj: any) => obj.key === column.key)?.strWidth,
                minWidth: column.minWidth,
                maxWidth: column.maxWidth,
              }"
            ></th>
          </template>
        </tr>
      </template>
      <!-- Contents部分 -->
      <template #item="{ item, columns, isSelected, toggleSelect }">
        <tr
          :class="{
            selectDisabled: checkDisabled(
              item,
              headers?.find((obj: any) => !!obj.selectDisable)
            ),
          }"
          :style="{ background: isSelected(item) ? '#f00 ' : '' }"
          @click="selectOnly || selecteble ? onCustomButton($event, 'select', item) : undefined"
        >
          <template v-for="column in columns">
            <td
              v-if="
                column &&
                column.key &&
                (columnSetting.value[name]?.columns[column.key] ||
                  !headers?.find((obj: any) => obj.key === column.key)?.choice) &&
                !headers?.find((obj: any) => obj.key === column.key)?.disabled &&
                !headers?.find((obj: any) => obj.key === column.key)?.hidden &&
                !headers?.find((obj: any) => obj.key === column.key)?.nolist &&
                column.key !== TABLE_ITEM_KEY.DELETE &&
                column.key !== TABLE_ITEM_KEY.COMMENT &&
                column.key !== TABLE_ITEM_KEY.NOTE &&
                column.key !== TABLE_ITEM_KEY.ATTENTION &&
                column.key !== TABLE_ITEM_KEY.WARNING &&
                column.key !== TABLE_ITEM_KEY.LINE &&
                column.key !== TABLE_ITEM_KEY.HEADLINE &&
                column.key !== TABLE_ITEM_KEY.BLANK_COLUMN &&
                column.key !== TABLE_ITEM_KEY.MODAL_LINK &&
                column.key !== TABLE_ITEM_KEY.ACTION &&
                column.key !== TABLE_ITEM_KEY.OSS_THUMBNAIL &&
                column.key !== FORM_ITEM.TERMS_CHECK
              "
              :class="{
                alignStart: column.align === 'start',
                alignCenter: column.align === 'center',
                alignEnd: column.align === 'end',
                fixed: column.fixed,
                blank: column.key === 'blank',
              }"
              :style="{
                width: headers?.find((obj: any) => obj.key === column.key)?.strWidth,
                minWidth: column.minWidth,
                maxWidth: column.maxWidth,
                paddingLeft: column.key === 'blank' ? '1px !important' : undefined,
                paddingRight: column.key === 'blank' ? '0 !important' : undefined,
              }"
              @mouseover="onCellOver($event, headers?.find((obj: any) => obj.key === column.key)?.link)"
              @mouseout="onCellOut($event, headers?.find((obj: any) => obj.key === column.key)?.link)"
            >
              <span v-if="headerObjects[column.key].type === FORM_ITEM.ICON_OR_LINK">
                <PartsListTableIconOrLink
                  :value="callIconOrLink(headerObjects[column.key], item[column.key])"
                  @update:value="onLink(null, column.key, $event)"
                />
              </span>
              <span
                v-else
                :class="{
                  link: headers?.find((obj: any) => obj.key === column.key)?.link,
                  userSelect: headers?.find((obj: any) => obj.key === column.key)?.userSelect,
                  notEvent:
                    !headers?.find((obj: any) => obj.key === column.key)?.userSelect &&
                    !headers?.find((obj: any) => obj.key === column.key)?.link,
                }"
                :style="{
                  color: choiceColor(column.key, item[column.key]),
                }"
                @click="
                  headers?.find((obj: any) => obj.key === column.key)?.link
                    ? onLink($event, column.key, item)
                    : undefined
                "
                @mouseover="onCellOut($event, headers?.find((obj: any) => obj.key === column.key)?.link)"
              >
                <template v-if="headerObjects[column.key].selectFunction !== undefined">
                  {{ selectFunction(headerObjects[column.key], item[column.key], toggleSelect) }}
                </template>
                <template v-else-if="headerObjects[column.key].viewFunction !== undefined">
                  {{ callFunction(headerObjects[column.key], item[column.key]) }}
                </template>
                <template v-else-if="column.key === 'nameset'">
                  {{ `${item[column.key][0]} ${item[column.key][1]}` }}
                </template>
                <template v-else-if="column.key === 'kanaset'">
                  {{ `${item[column.key][0]} ${item[column.key][1]}` }}
                </template>
                <template v-else-if="choiceIconCheck(column.key, item[column.key])">
                  <v-icon
                    class="mr-0"
                    :icon="choiceIcon(column.key, item[column.key])?.icon"
                    :color="choiceIcon(column.key, item[column.key])?.color"
                  />
                  <span class="iconLabel">{{ choiceValue(column.key, item[column.key]) }}</span>
                </template>
                <template v-else-if="choiceCheck(column.key)">
                  {{ choiceValue(column.key, item[column.key]) }}
                </template>
                <template v-else-if="headerObjects[column.key].type === FORM_ITEM.CHECK_BOX">
                  <v-icon v-if="item[column.key] === true" :icon="ICONS.CHECK" />
                </template>
                <template v-else-if="headerObjects[column.key].type === FORM_ITEM.MONTH">
                  {{ formatDate(item[column.key], 'YYYY-MM') }}
                </template>
                <template v-else-if="headerObjects[column.key].type === FORM_ITEM.TIME">
                  {{ item[column.key] }}
                </template>
                <template v-else-if="headerObjects[column.key].type === FORM_ITEM.DATE">
                  {{ formatDate(item[column.key], 'YYYY-MM-DD') }}
                </template>
                <template v-else-if="headerObjects[column.key].type === FORM_ITEM.DATETIME">
                  {{ formatDate(item[column.key], 'YYYY-MM-DD HH:mm:ss') }}
                </template>
                <template v-else-if="headerObjects[column.key].type === FORM_ITEM.ZIPCODE">
                  〒{{ item[column.key] }}
                </template>
                <template v-else-if="headerObjects[column.key].type === FORM_ITEM.INVOICE">
                  <template v-if="isInvoice(item[column.key])">
                    <span :style="{ color: '#999' }">T</span>
                    <span :style="{ color: '#56F' }">{{ invoiceData(item[column.key]) }}</span>
                  </template>
                  <template v-else>
                    <span :style="{ color: '#F64' }">{{ item[column.key] }}</span>
                  </template>
                </template>
                <template v-else>
                  {{ item[column.key] }}
                </template>
              </span>
            </td>
            <td
              v-else-if="column.key === TABLE_ITEM_KEY.OSS_THUMBNAIL"
              :style="{
                width: headers?.find((obj: any) => obj.key === column.key)?.strWidth,
                minWidth: column.minWidth,
                maxWidth: column.maxWidth,
                paddingLeft: '0 !important',
                paddingRight: '0 !important',
              }"
              :class="{
                alignStart: column.align === 'start',
                alignCenter: column.align === 'center',
                alignEnd: column.align === 'end',
                fixed: column.fixed,
              }"
            ></td>
            <td
              v-else-if="column.key === TABLE_ITEM_KEY.DELETE"
              class="Delete"
              :style="{
                width: headers?.find((obj: any) => obj.key === column.key)?.strWidth,
                minWidth: column.minWidth,
                maxWidth: column.maxWidth,
              }"
            >
              <template v-if="headerObjects[column.key].viewFunction !== undefined">
                <div v-if="callFunction(headerObjects[column.key], item)" class="ActionIcons">
                  <ButtonIcon
                    :icon="ICONS.CLOSE"
                    :color="useColor(THEME_COLOR.secondary)"
                    @click="onDelete($event, item)"
                  />
                </div>
              </template>
              <template v-else>
                <div class="ActionIcons">
                  <ButtonIcon
                    :icon="ICONS.CLOSE"
                    :color="useColor(THEME_COLOR.secondary)"
                    @click="onDelete($event, item)"
                  />
                </div>
              </template>
            </td>
            <td
              v-else-if="column.key === TABLE_ITEM_KEY.ACTION"
              class="Action"
              :style="{
                width: headers?.find((obj: any) => obj.key === column.key)?.strWidth,
                minWidth: column.minWidth,
                maxWidth: column.maxWidth,
              }"
            >
              <div class="ActionIcons">
                <template v-for="icon in headerObjects[column.key]?.contents">
                  <template v-if="icon.key === 'edit'">
                    <ButtonIcon
                      v-if="
                        (headerObjects[column.key].viewFunction !== undefined &&
                          callFunction(headerObjects[column.key], item)) ||
                        headerObjects[column.key].viewFunction === undefined
                      "
                      :style="{ margin: icon.margin }"
                      :size="icon.size"
                      :icon="icon.icon ? icon.icon : ICONS.PENCIL"
                      :color="useColor(icon.color ? icon.color : THEME_COLOR.success)"
                      @click="onEdit($event, item)"
                    />
                  </template>

                  <ButtonIcon
                    v-else-if="icon.key === 'sort'"
                    :icon="icon.icon ? icon.icon : ICONS.MENU"
                    :color="useColor(icon.color ? icon.icon : THEME_COLOR.primary)"
                    @click="onSort($event, item)"
                  />

                  <ButtonToggle
                    v-else-if="icon.key === 'play'"
                    :value="''"
                    :actived="columns[icon.active] === icon.value"
                    :icon="TOGGLE_TYPE.OTHER"
                    :icons="[
                      { icon: 'mdi-play-circle', color: THEME_COLOR.primary },
                      { icon: 'mdi-stop-circle', color: THEME_COLOR.disabled },
                    ]"
                    @click="onCustomButton($event, icon.key, item)"
                  />

                  <ButtonToggle
                    v-else-if="icon.key === 'maintenance'"
                    :value="''"
                    :actived="columns[icon.active] === icon.value"
                    :icon="TOGGLE_TYPE.OTHER"
                    :icons="[
                      { icon: 'mdi-wrench', color: THEME_COLOR.primary },
                      { icon: 'mdi-wrench', color: THEME_COLOR.disabled },
                    ]"
                    @click="onCustomButton($event, icon.key, item)"
                  />

                  <div
                    v-else-if="icon.icon && icon.key === 'customEdit' && icon.callback !== undefined"
                    :style="{ minWidth: '32px' }"
                  >
                    <ButtonIcon
                      v-if="icon.callback(item)"
                      :style="{ margin: icon.margin }"
                      :icon="icon.icon"
                      :size="icon.size"
                      :color="useColor(icon.color ? icon.color : THEME_COLOR.primary)"
                      @click="onEdit($event, item)"
                    />
                    <ButtonIcon
                      v-else-if="icon.disabled"
                      :style="{ margin: icon.margin }"
                      :size="icon.size"
                      :icon="icon.icon ? icon.icon : ICONS.PENCIL"
                      :color="useColor(THEME_COLOR.disabled)"
                      :disabled="true"
                    />
                  </div>
                  <div v-else-if="icon.key === 'check'" :style="{ minWidth: '32px' }">
                    <ButtonToggle
                      class="CheckButton"
                      :style="{ margin: icon.margin ? icon.margin : '3.5px 0 0' }"
                      icon="check"
                      :value="icon.callback ? icon.callback(item) : false"
                      :color="useColor(icon.color ? icon.color : THEME_COLOR.primary)"
                      :actived="icon.callback ? icon.callback(item) : false"
                      @update:value="onListCheck($event, icon.key, item)"
                    />
                  </div>
                  <div v-else-if="icon.icon && icon.callback !== undefined" :style="{ minWidth: '32px' }">
                    <ButtonIcon
                      v-if="icon.callback(item)"
                      :style="{ margin: icon.margin }"
                      :size="icon.size"
                      :icon="icon.icon"
                      :color="useColor(icon.color ? icon.color : THEME_COLOR.primary)"
                      @click="onCustomButton($event, icon.key, item)"
                    />
                    <ButtonIcon
                      v-else-if="icon.switch"
                      :style="{ margin: icon.margin }"
                      :size="icon.size"
                      :icon="icon.switch.icon"
                      :color="useColor(icon.switch.color ? icon.switch.color : THEME_COLOR.primary)"
                      @click="onCustomButton($event, icon.key, item)"
                    />
                    <ButtonIcon
                      v-else-if="icon.disabled"
                      :style="{ margin: icon.margin }"
                      :size="icon.size"
                      :icon="icon.icon ? icon.icon : ICONS.PENCIL"
                      :color="useColor(THEME_COLOR.disabled)"
                      :disabled="true"
                    />
                  </div>

                  <ButtonIcon
                    v-else-if="icon.icon && icon.callback === undefined"
                    :style="{ margin: icon.margin }"
                    :icon="icon.icon"
                    :size="icon.size"
                    :color="useColor(icon.color ? icon.color : THEME_COLOR.primary)"
                    @click="onCustomButton($event, icon.key, item)"
                  />

                  <ButtonSimple
                    v-else
                    class="mr-2"
                    :icon="icon.ico ? icon.ico : ICONS.MENU"
                    :size="icon.size"
                    :backcolor="useColor(icon.color ? icon.color : THEME_COLOR.primary)"
                    :text="icon.text"
                    small
                    @click="onCustomButton($event, icon.key, item)"
                  />
                </template>
              </div>
            </td>
          </template>
        </tr>
      </template>
      <template #bottom>
        <div class="TableFooter">
          <div class="LeftArea">
            <FormSelectMenu
              v-if="selectPagePare"
              label="表示件数"
              :base="SelectPerPageBase"
              :items="selectPagePare"
              :value="itemsPerPage"
              :height="selectPagePare.length * 30 + 24"
              :layout="POSITION.TOP"
              @update:value="onChangeSelectPerPage"
            />
            <FormNumeric
              v-else
              label="表示件数"
              :countMin="5"
              :countMax="200"
              :base="PerPageBase"
              :value="itemsPerPage.toString()"
              @update:value="onChangePerPage(+$event)"
            />
          </div>
          <div class="CenterArea">
            <PartsPagination
              v-if="input.length"
              :page="nowPage"
              :pageMax="pageMax"
              :length="pageCount"
              @update:value="onChangePage($event)"
            />
          </div>
          <div class="RightArea">
            <div class="mt-0-5">{{ input.length }}件</div>
            <ButtonIcon :icon="ICONS.RELOAD" @click="onReload" />
          </div>
        </div>
      </template>
    </v-data-table>
    <PartsProgress v-if="loading" class="Progress" />
  </div>
</template>

<script setup lang="ts">
/**===================================================================================================================
   *
   * <template v-if="custom" v-slot:item="{ item }">
    <slot :item="item" />
  </template>
  <template v-slot:bottom>
    <div class="TableFooter">
      <div><FormNumeric label="表示件数" /></div>
      <div><PartsPagination :page="nowPage" :length="pageCount" @update:value="nowPage = $event" /></div>
      <div>
        <ButtonToggleSet
          :value="density?.toString()"
          @update:value="onChangeDensity($event)"
          :items="densityItems"
        />
      </div>
    </div>
  </template>
   *
   ===================================================================================================================**/
// vuetify v3.4.0以降、labsでの提供がなくなる。一旦コメントアウト
// import { VDataTable } from 'vuetify/labs/VDataTable'
import {
  type DataTableHeader,
  TABLE_ITEM_KEY,
  defaultBase,
  FORM_ITEM,
  type ToggleProps,
  TOGGLE_TYPE,
} from '../../components/common'
import dayjs from 'dayjs'
import { THEME_COLOR, ICONS, POSITION } from '../../composables/constants'
import { ref, watch, onMounted, type Ref } from 'vue'
import { useListColumnSetting } from '../../composables/list'
import { useColor } from '../../composables/colors'
import { useDelay } from '../../composables/utility'
import type { Density } from '../../types'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props {
  name: string
  data?: any
  headers?: any[]
  custom?: boolean
  loading?: boolean
  density?: Density
  selectOnly?: boolean
  selecteble?: boolean
  dataMax: number
  page?: number
  selectPagePare?: { text: string; value: number }[]
}

const props = withDefaults(defineProps<Props>(), { density: 'default', page: 1 })
//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const itemsPerPage = ref(50)
const initialize = ref(false)
const PerPageBase = ref(JSON.parse(JSON.stringify(defaultBase)))
const dataMaxNum = ref(props.dataMax)
PerPageBase.value.width = 100
PerPageBase.value.label.align = 'flex-end'
PerPageBase.value.label.width = 60

const SelectPerPageBase = ref(JSON.parse(JSON.stringify(defaultBase)))
SelectPerPageBase.value.width = 60
SelectPerPageBase.value.label.align = 'flex-end'
SelectPerPageBase.value.label.width = 60

const input: Ref<any[]> = ref(props.data)
const nowPage = ref(props.page)
const pageCount = ref(Math.ceil(props.data.length / itemsPerPage.value))
const pageMax = ref(Math.ceil(props.dataMax / itemsPerPage.value))
const headerObjects: Ref<{ [key: string]: DataTableHeader }> = ref({})
const columnSetting = useListColumnSetting()
const delay = useDelay()
//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------

onMounted(() => {
  props.headers?.forEach((head) => {
    headerObjects.value[head.key] = head
  })
  initialize.value = true
})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.data,
  (value) => {
    if (value) {
      input.value = value
      pageCount.value = Math.ceil(value.length / itemsPerPage.value)
    }
  },
  {
    deep: true,
  }
)
watch(
  () => props.dataMax,
  (value) => {
    if (value) {
      dataMaxNum.value = value
      pageMax.value = Math.ceil(value / itemsPerPage.value)
    }
  },
  {
    deep: true,
  }
)

watch(
  () => props.page,
  (value) => {
    console.log('Page変わった', value)

    nowPage.value = value
  }
)
//------------------------------------------------------------------------------------------------------------
//computed
//------------------------------------------------------------------------------------------------------------
/*
  const counter: Ref<number> = useState('counter', () => 500)

  // computedによりcounter変数の監視が行われる
  const doubleCount = computed(() => {
    return counter.value * 2
  })
  */
//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function onChangePerPage(value: number) {
  itemsPerPage.value = value
  pageCount.value = Math.ceil(input.value.length / itemsPerPage.value)
  pageMax.value = Math.ceil(dataMaxNum.value / itemsPerPage.value)
  nowPage.value = 1
  // console.log(dataMaxNum.value, '/', itemsPerPage.value, '=', pageMax.value)
}

function onChangeSelectPerPage(value: any) {
  itemsPerPage.value = Number(value)
  pageCount.value = Math.ceil(input.value.length / itemsPerPage.value)
  pageMax.value = Math.ceil(dataMaxNum.value / itemsPerPage.value)
  nowPage.value = 1
}

//CheckやRadioといった、Choice系の判断
function choiceCheck(key: string) {
  let result = false
  const item = headerObjects.value[key]
  if (item) {
    if (
      item.type === FORM_ITEM.CHECK_GROUP ||
      item.type === FORM_ITEM.RADIO_GROUP ||
      item.type === FORM_ITEM.SELECT_CHECK ||
      item.type === FORM_ITEM.SELECT_MENU ||
      item.type === FORM_ITEM.ASSOCIATE_SELECT_MENU ||
      item.type === FORM_ITEM.ASSOCIATE_SELECT_CHECK
    ) {
      result = true
    }
  }
  return result
}

//SELECT_MENUで、objectsにicon持ちがあるか？
function choiceIconCheck(key: string, value: string) {
  let result = false
  const item = headerObjects.value[key]
  if (item && item.type === FORM_ITEM.SELECT_MENU) {
    if (value !== null && value !== undefined) {
      const head = props.headers?.find((obj) => obj.key === key)
      const values = String(value).split(',')
      values.forEach((item) => {
        const textItem = head?.contents?.find((obj: any) => obj.value == item)
        const icon = textItem?.icon
        //もしアイコン表示があれば、
        if (icon) result = true
      })
    }
  }
  return result
}

function choiceColor(key: string, value: string) {
  let result = 'black'
  //const item = headerObjects.value[key]
  if (value) {
    const head = props.headers?.find((obj) => obj.key === key)
    const values = String(value).split(',')
    values.forEach((item) => {
      // valueが数値の場合も考慮して、==にしてます
      const color = head?.contents?.find((obj: any) => obj.value == item)?.color
      if (color) {
        result = color
      }
    })
  }
  return useColor(result)
}

function choiceIcon(key: string, value: string) {
  let result: any
  const item = headerObjects.value[key]
  if (value !== null && value !== undefined) {
    const head = props.headers?.find((obj) => obj.key === key)
    const values = String(value).split(',')
    values.forEach((item) => {
      // valueが数値の場合も考慮して、==にしてます
      const textItem = head?.contents?.find((obj: any) => obj.value == item)
      const icon = textItem?.icon
      //もしアイコン表示があれば、
      if (icon) result = icon
    })
  }
  return result
}

function choiceValue(key: string, value: string) {
  const result: string[] = []
  const item = headerObjects.value[key]
  if (item && (item.type === FORM_ITEM.ASSOCIATE_SELECT_MENU || item.type === FORM_ITEM.ASSOCIATE_SELECT_CHECK)) {
    const head = props.headers?.find((obj) => obj.key === key)
    const values = String(value).split(',')
    values.forEach((item) => {
      const itemTypes = head?.contentObjects
      for (const itemType in itemTypes) {
        const text = itemTypes[itemType].find((obj: any) => obj.value == item)?.text
        if (text) result.push(text)
      }
    })
  } else {
    if (value !== null && value !== undefined) {
      const head = props.headers?.find((obj) => obj.key === key)
      const values = String(value).split(',')
      values.forEach((item) => {
        // valueが数値の場合も考慮して、==にしてます
        const textItem = head?.contents?.find((obj: any) => obj.value == item)
        const text = textItem?.text
        //もしアイコン表示があれば、
        if (text) result.push(text)
      })
    }
  }
  return result.join(',')
}

function checkDisabled(row: any, selectDisableItem?: DataTableHeader) {
  if (selectDisableItem && row[selectDisableItem.key] === selectDisableItem.selectDisable) {
    // console.log('hidden', selectDisableItem.selectDisable)
    return true
  }
  return false
}

function onCellOver(e: MouseEvent, link?: string) {
  // if (link) return
  e.stopPropagation()
  if (props.selecteble) {
    let element = e.target as HTMLElement // タイプアサーション
    while (element) {
      // 特定のタグ名（例えば、"DIV"）を持つ親要素を探す
      // console.log(element.tagName)
      if (element.tagName === 'TR') {
        // 何らかの操作（例えば、背景色を変更）
        element.classList.add('hover')
        break
      }

      // 親要素を遡る
      element = element.parentNode as HTMLElement
    }
  }
}

function onCellOut(e: MouseEvent, link?: string) {
  e.stopPropagation()
  if (props.selecteble) {
    let element = e.target as HTMLElement // タイプアサーション
    while (element) {
      // 特定のタグ名（例えば、"DIV"）を持つ親要素を探す

      if (element.tagName === 'TR') {
        // 何らかの操作（例えば、背景色を変更）
        element.classList.remove('hover')
        break
      }
      // 親要素を遡る
      element = element.parentNode as HTMLElement
    }
  }
}

function formatDate(value: string, format: string) {
  if (value) {
    return dayjs(value).format(format)
  }
  return ''
}

function isInvoice(value: string) {
  return /^(T\d{13}|\d{13})$/.test(value)
}
function invoiceData(value: string) {
  if (/^T\d+/.test(value)) {
    // 文字列が "T" で始まり、数字が続く場合、最初の "T" を削除
    return value.replace(/^T(\d+)/, '$1')
  } else {
    // それ以外の文字列は空文字列に置換
    return value
  }
}

function selectFunction(headerItem: DataTableHeader, value: any, selectFunction: Function) {
  if (headerItem.selectFunction) {
    //{ value: any; selectable: boolean }
    return headerItem.selectFunction(value)
  }
  return ''
}

function callFunction(headerItem: DataTableHeader, value: any) {
  if (headerItem.viewFunction) {
    return headerItem.viewFunction(value)
  }
  return ''
}

function callIconOrLink(headerItem: DataTableHeader, value: any) {
  if (headerItem.viewFunction) {
    // 以下の形式で返す
    // {icon:{},link:{}}
    return headerItem.viewFunction(value)
  }
  return {}
}
//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:page', item: number): void
  (e: 'update:edit', item: any): void
  (e: 'update:delete', item: any): void
  (e: 'update:sort', item: any): void
  (e: 'update:custom', item: { key: string; value: any }): void
  (e: 'update:reload', item: boolean): void
  (e: 'update:listCheck', item: { key: string; formValue: any; checkValue: boolean }): void
}>()

function onEdit(e: MouseEvent, value: any) {
  e.stopPropagation()
  emits('update:edit', value)
}

function onDelete(e: MouseEvent, value: any) {
  e.stopPropagation()
  emits('update:delete', value)
}

function onSort(e: MouseEvent, value: any) {
  e.stopPropagation()
  emits('update:sort', value)
}
function onLink(e: MouseEvent | null, key: string | null, value: any) {
  if (key) {
    if (
      props.headers?.find((obj) => obj.key === key)?.link ||
      props.headers?.find((obj) => obj.key === key)?.type === FORM_ITEM.ICON_OR_LINK
    ) {
      if (e) e.stopPropagation()
      emits('update:custom', { key: key, value: value })
    }
  }
}

function onCustomButton(e: MouseEvent, key: string | undefined, value: any) {
  e.stopPropagation()
  if (key) {
    emits('update:custom', { key: key, value: value })
  }
}

function onChangePage(value: number) {
  nowPage.value = value
  emits('update:page', value)
}

function onReload() {
  onChangePage(1)
  emits('update:reload', true)
}
function onListCheck(event: any, key: string | undefined, formValue: any) {
  if (key) {
    emits('update:listCheck', { key: key, formValue: formValue, checkValue: !event })
  }
}
</script>

<style scoped>
@charset "UTF-8";
.ListTable {
  position: relative;
  /* thead の部分を固定する */
  height: 100%;
  min-height: 100px;
  /* セルの境界線を明確にする (任意) */
}
.ListTable .Progress {
  position: absolute;
  left: calc((100% - 45px) / 2);
  top: calc((100% - 45px) / 2 + 20px);
}
.ListTable .ListDataTabel {
  position: relative;
  height: 100%;
  background: rgb(var(--r-color-background));
  border-top-left-radius: 4px;
}
.ListTable .ListDataTabel::after {
  position: absolute;
  content: "";
  width: 4px;
  top: 0px;
  height: 4px;
  right: 11.9px;
  background-color: rgba(var(--r-color-listhead), 1) !important;
  z-index: 12;
  border-top-right-radius: 5px;
}
.ListTable .ListDataTabel::before {
  position: absolute;
  content: "";
  width: 4px;
  top: 0px;
  height: 4px;
  right: 11px;
  background: rgb(var(--r-color-background));
  z-index: 11;
}
.ListTable ::v-deep(.v-table__wrapper) {
  overflow-y: scroll !important;
  overflow-x: scroll !important;
  background: rgb(var(--r-color-background));
  padding-bottom: 0px;
  /*
    &::-webkit-scrollbar-track:horizontal {
      //border-right: thin solid rgba(var(--r-color-color), 0.2) !important;
    }
    */
}
.ListTable ::v-deep(.v-table__wrapper)::-webkit-scrollbar-track {
  background: rgb(var(--r-color-background));
  margin-top: 29px;
}
.ListTable ::v-deep(.v-table__wrapper)::-webkit-scrollbar-thumb {
  border-radius: 12px;
  background: rgb(var(--r-color-scroll));
  border: 3px solid rgb(var(--r-color-background));
}
.ListTable ::v-deep(.v-table__wrapper)::-webkit-scrollbar-thumb:horizontal {
  border-left: 3px solid rgb(var(--r-color-background));
  border-right: 3px solid rgb(var(--r-color-background));
}
.ListTable ::v-deep(.v-table__wrapper)::-webkit-scrollbar-thumb:vertical {
  border-top: 3px solid rgb(var(--r-color-background));
  border-bottom: 3px solid rgb(var(--r-color-background));
}
.ListTable ::v-deep(.v-table__wrapper)::-webkit-scrollbar-corner {
  background: rgb(var(--r-color-background));
  border-top: thin solid rgba(var(--r-color-background), 0.2) !important;
}
.ListTable ::v-deep(table) {
  border: none;
}
.ListTable ::v-deep(thead) {
  position: sticky;
  top: 0;
  z-index: 10;
  background-color: white; /* 背景を明示的に設定して tbody に隠れないようにする */
}
.ListTable ::v-deep(.v-data-table-rows-no-data) td {
  background: rgb(var(--r-color-background)) !important;
  font-size: 14px;
  color: rgba(var(--r-color-color), 1) !important;
}
.ListTable th {
  height: 30px !important;
  background-color: rgba(var(--r-color-listhead), 1) !important;
  color: rgba(var(--r-color-color), 1) !important;
  border-bottom: thin solid rgba(var(--r-color-primary), 0.2) !important;
  padding: 0 !important;
}
.ListTable th .headInner {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
}
.ListTable th .headInner.alignStart {
  justify-content: flex-start;
  padding: 0 0 0 10px !important;
}
.ListTable th .headInner.alignCenter {
  justify-content: center;
  padding: 0 4px 0 !important;
}
.ListTable th .headInner.alignEnd {
  justify-content: flex-end;
  padding: 0 10px 0 0 !important;
}
.ListTable th .headInner .Icon {
  width: 14px;
  padding-left: 2px;
}
.ListTable td {
  background-color: rgba(var(--r-color-listbody), 1) !important;
  color: rgba(var(--r-color-color), 1) !important;
  word-break: break-all;
}
.ListTable td.alignStart {
  text-align: start;
  padding: 0 0 0 10px !important;
}
.ListTable td.alignCenter {
  text-align: center;
  padding: 0 4px 0 !important;
}
.ListTable td.alignEnd {
  text-align: end;
  padding: 0 10px 0 0 !important;
}
.ListTable th,
.ListTable td {
  box-sizing: border-box;
  padding: 0px !important;
  font-size: 12px !important;
  line-height: 14px !important;
  user-select: none;
}
.ListTable th:not(:last-child),
.ListTable td:not(:last-child) {
  padding: 2px 0px 0px !important;
  border-right: thin solid rgba(var(--r-color-color), 0.2) !important;
}
.ListTable th:not(:last-child).blank,
.ListTable td:not(:last-child).blank {
  border-right: 0 solid transparent !important;
}
.ListTable td:not(:last-child) {
  padding: 2px 10px 0px !important;
}
.ListTable tr:not(:last-child) td {
  border-bottom: thin solid rgba(var(--r-color-color), 0.2) !important;
}
.ListTable td.Delete,
.ListTable th.Delete {
  position: sticky !important;
  left: 0px;
  padding: 0 !important;
  z-index: 9;
}
.ListTable th.Delete {
  z-index: 10;
}
.ListTable .Action {
  position: sticky !important;
  width: 116px;
  min-width: 116px;
  max-width: 116px;
  right: 0;
  padding: 0 10px;
  border-left: 0.5px solid rgba(var(--r-color-line), 0.2);
}
.ListTable .ActionIcons {
  position: relative;
  height: inherit;
  width: 100%;
  display: flex;
  padding: 0 10px;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  overflow-y: hidden;
}
.ListTable td.Delete .ActionIcons {
  justify-content: center;
  padding: 0 0px;
}
.ListTable ::v-deep(.v-table--density-default) td {
  height: 42px !important;
}
.ListTable ::v-deep(.v-table--density-comfortable) td {
  height: 34px !important;
}
.ListTable ::v-deep(.v-table--density-compact) td {
  height: 24px !important;
}
.ListTable ::v-deep(th.v-data-table__th--sortable.v-data-table-column--align-center) {
  padding: 0 !important;
}
.ListTable ::v-deep(th.v-data-table__th--sortable.v-data-table-column--align-center) span {
  margin-left: 16px;
}
.ListTable .fixed {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.ListTable .SelectOnly ::v-deep(tbody) {
  background-color: rgba(var(--r-color-listbody), 1) !important;
}
.ListTable .SelectOnly ::v-deep(tbody) tr:not(.selectDisabled) {
  background-color: rgba(var(--r-color-primary), 0) !important;
  cursor: pointer;
  /*
  td.Action {
    background-color: rgba(var(--r-color-listbody), 1) !important;
  }
  */
}
.ListTable .SelectOnly ::v-deep(tbody) tr:not(.selectDisabled) td:not(.Delete):not(.Action) {
  background-color: rgba(var(--r-color-listbody), 0) !important;
}
.ListTable .SelectOnly ::v-deep(tbody) tr:not(.selectDisabled):hover {
  background-color: rgba(var(--r-color-primary), 0.2) !important;
}
.ListTable .SelectOnly ::v-deep(tbody) tr:not(.selectDisabled):hover .Action {
  background-color: rgba(var(--r-color-listbody), 1) !important;
}
.ListTable .SelectOnly ::v-deep(tbody) tr:not(.selectDisabled):hover .Action .ActionIcons {
  background-color: rgba(var(--r-color-primary), 0.2) !important;
}
.ListTable .SelectOnly ::v-deep(tbody) tr:not(.selectDisabled):hover .Delete {
  background-color: rgba(var(--r-color-listbody), 1) !important;
}
.ListTable .SelectOnly ::v-deep(tbody) tr:not(.selectDisabled):hover .Delete .ActionIcons {
  background-color: rgba(var(--r-color-primary), 0.2) !important;
}
.ListTable .Selecteble ::v-deep(tbody) {
  background-color: rgba(var(--r-color-listbody), 1) !important;
}
.ListTable .Selecteble ::v-deep(tbody) tr:not(.selectDisabled) {
  background-color: rgba(var(--r-color-primary), 0) !important;
  /*
  td.Action {
    background-color: rgba(var(--r-color-listbody), 1) !important;
  }
  */
}
.ListTable .Selecteble ::v-deep(tbody) tr:not(.selectDisabled) td:not(.Delete):not(.Action) {
  background-color: rgba(var(--r-color-listbody), 0) !important;
}
.ListTable .Selecteble ::v-deep(tbody) tr:not(.selectDisabled).hover {
  background-color: rgba(var(--r-color-primary), 0.1) !important;
  /*
  .Delete {
    background-color: rgba(var(--r-color-listbody), 1) !important;
    .ActionIcons {
      background-color: rgba(var(--r-color-primary), 0.1) !important;
    }
  }
  */
}
.ListTable .Selecteble ::v-deep(tbody) tr:not(.selectDisabled).hover .Action,
.ListTable .Selecteble ::v-deep(tbody) tr:not(.selectDisabled).hover .Delete {
  background-color: rgba(var(--r-color-listbody), 1) !important;
}
.ListTable .Selecteble ::v-deep(tbody) tr:not(.selectDisabled).hover .Action .ActionIcons,
.ListTable .Selecteble ::v-deep(tbody) tr:not(.selectDisabled).hover .Delete .ActionIcons {
  background-color: rgba(var(--r-color-primary), 0.1) !important;
}
.ListTable tr.selectDisabled td {
  background-color: rgba(var(--r-color-listdisabled), 1) !important;
}
.ListTable tr.selectDisabled td span {
  opacity: 0.3;
}
.ListTable .link {
  color: rgba(var(--r-color-link));
  text-decoration: underline;
  cursor: pointer;
}
.ListTable .userSelect {
  user-select: text;
}
.ListTable .userSelect span {
  user-select: text;
}
.ListTable .notEvent {
  pointer-events: none;
}

.TableFooter {
  position: relative;
  width: 100%;
  padding: 8px 10px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.TableFooter .LeftArea {
  width: 180px;
  display: flex;
  justify-content: flex-start;
  align-items: center;
}
.TableFooter .CenterArea {
  display: flex;
  width: calc(100% - 380px);
  justify-content: center;
  align-items: center;
}
.TableFooter .RightArea {
  width: 170px;
  margin-left: 10px;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  border-left: 1px solid rgba(var(--r-color-line));
}
</style>
