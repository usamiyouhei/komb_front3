<template>
  <FormBase
    class="FormFilePicker"
    :base="base"
    :label="label"
    :rule="rule || data?.rule"
    :mode="mode"
    :edit="isEdit"
    :width="width || base?.width"
    :col-width="colWidth"
    :label-width="labelWidth"
    :hint="hint"
    :hintchip="hintchip"
    :error="inputError"
    :result="result"
    :focus="focus"
    :small="small"
    :medium="medium"
  >
    <div class="FormContainer">
      <div class="FormInputContainer" ref="InputArea">
        <div v-if="prefix" class="Prefix">{{ prefix }}</div>
        <div
          class="FormInputContent"
          :style="{
            width: width ? width + 'px' : base?.width ? base.width + 'px' : '100%',
          }"
        >
          <template v-if="edit">
            <input
              :id="props.data?.name"
              :name="props.data?.name"
              class="Input"
              :class="{ InputError: inputError }"
              :style="{ paddingRight: '30px' }"
              ref="inputItem"
              type="text"
              :value="input"
              :placeholder="placeholder"
              readonly
              @focus="onFocus"
              @blur="onBlur"
            />
          </template>
          <input v-else type="text" class="Preview" :value="input" :placeholder="placeholder" disabled />
          <ButtonInnerForm
            v-if="edit"
            class="Icon"
            :icon="FORM_ICONS.CLOSE"
            :size="16"
            :width="30"
            :align="ALIGN.RIGHT"
            @click="resetFile"
          />
        </div>
        <div v-if="suffix" class="Suffix">{{ suffix }}</div>
      </div>
    </div>
    <template #extra>
      <div class="FilePicker mt-2">
        <PartsImageDragger
          :style="{
            width: '100%',
          }"
          :selectType="DROP_TYPE.FORM"
          :reset="resetFlag"
          :extensions="extension"
          :edit="edit"
          :data="formData"
          :dataList="dataList"
          :small="small"
          @update:value="uploadFile"
        />
      </div>
    </template>
  </FormBase>
</template>
<script setup lang="ts">
/**===================================================================================================================
   *
  ===================================================================================================================**/
import { DROP_TYPE, FILE_TYPE, type formProps } from '../../components/common'
import { RULE, useValidation, useFileValidation } from '../../composables/validation'
import { THEME_COLOR, FORM_ICONS, ALIGN } from '../../composables/constants'
// import OSS from 'ali-oss'
import { useColor } from '../../composables/colors'
import { ref, watch, type Ref } from 'vue'

//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props extends formProps {
  rule?: any
  value?: string
  extensions?: string[]
  dataList?: string[]
  reset?: boolean
  small?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  edit: true,
})

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const input: Ref<string | undefined> = ref(props.data?.value || props.value)
const inputError: Ref<string | undefined> = ref(props.error)
const inputItem: Ref<HTMLInputElement | undefined> = ref()
const result: Ref<string | undefined> = ref()
const focus = ref(false)
const isEdit = ref(props.edit)
const InputArea: Ref<HTMLDivElement | null> = ref(null)
const resetFlag = ref(false)
const extension: Ref<string[] | undefined> = ref(props.extensions || undefined)
const dataList: Ref<string[] | undefined> = ref(props.dataList || undefined)
const uploadedFile = ref()
const uploadedFiles: Ref<File[]> = ref([])
const buttonColor = useColor(THEME_COLOR.primary)
// 2024.1.31 モジュール化に伴い、コメントアウト
// const { $projectOssMaster } = useNuxtApp() as unknown as { $projectOssMaster: InstanceType<typeof OSS> }
const formData = ref()
//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.value,
  (value) => {
    if (value) {
      input.value = value
    } else {
      resetFile()
    }
  }
)

watch(
  () => props.error,
  (value) => {
    inputError.value = value
  }
)

watch(
  () => props.dataList,
  (value) => {
    dataList.value = value
  },
  { deep: true }
)

// 追加されたファイルの中身をチェック
watch(
  () => props.data,
  (value) => {
    if (value?.fileValue) {
      if (value.fileValue.file) {
        input.value = value?.fileValue.file.name
        formData.value = value?.fileValue.file
      } else {
        input.value = value?.fileValue.name
        formData.value = value?.fileValue.path
      }
    } else {
      input.value = value?.value
      if (value) value.fileValue = undefined
      formData.value = undefined
    }

    if (props.data) {
      if (value?.onCheck === 'check') {
        fileValidation()
        props.data.onCheck = ''
      } else if (value?.onCheck === 'clear') {
        props.data.onCheck = ''
        props.data.error = ''
        inputError.value = ''
      }

      if (value?.error) {
        // input.value = ''
        inputError.value = value?.error
      } else {
        inputError.value = ''
      }
    }
  },
  {
    deep: true,
  }
)

watch(
  () => props.base,
  (value) => {
    if (value?.edit) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)
watch(
  () => props.edit,
  (value) => {
    if (value) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.reset,
  (value) => {
    if (value) {
      resetFile()
    }
  }
)

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:file', value: any): void
  (e: 'update:value', value: any): void
  (e: 'update:error', value: string): void
  (e: 'update:reset', value: boolean): void
}>()

// アップロードしたファイル名を受け取り
function uploadFile(file: any) {
  uploadedFile.value = file
  uploadedFiles.value.push(file)
  const checkValidation = fileValidation()
  if (checkValidation) {
    input.value = file.name
    if (props.data) {
      props.data.fileValue = file
      props.data.value = file.name
    }

    emits('update:file', file)
    emits('update:value', file.name)
  } else {
    input.value = ''
    emits('update:error', inputError.value || '')
  }
}
//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function onFocus() {
  focus.value = true
}

function onBlur() {
  focus.value = false
}

function onInputChange() {}

// アップロードされたファイルを削除
function resetFile() {
  resetFlag.value = !resetFlag.value
  input.value = ''
  uploadedFile.value = ''
  if (props.data) {
    props.data.fileValue = undefined
    props.data.value = ''
    props.data.error = ''
    if (props.data.rule?.includes(RULE.required)) {
      fileValidation()
    }
  }
  emits('update:value', input.value)
  emits('update:error', inputError.value || '')
  emits('update:reset', true)
}

// async function downloadFile() {
//   // getを一意な名前に変更しないと取得するファイルが被ってしまう恐れがある。
//   if ($projectOssMaster) {
//     try {
//       const result = await $projectOssMaster.get()
//       if (result.res.status === 200) {
//         // console.log('File downloaded successfully:', result)
//       } else {
//         console.error('Error downloading file:', result)
//       }
//     } catch (error) {
//       console.error('Error downloading file:', error)
//     }
//   }
// }
//-----------------------------------------------------------------------------------------------------------
// バリデーション
//------------------------------------------------------------------------------------------------------------
function fileValidation() {
  if (props.data) props.data.isCheck = true

  //RULEの確認
  const rules: Ref<RULE[]> = ref(props.rule || props.data?.rule || [])
  const fileTypesToAdd = [
    { type: FILE_TYPE.AUDIO_MP3, rule: RULE.mp3 },
    { type: FILE_TYPE.MOVIE_MP4, rule: RULE.mp4 },
    { type: FILE_TYPE.IMG_JPEG, rule: RULE.jpeg },
    { type: FILE_TYPE.IMG_JPG, rule: RULE.jpg },
    { type: FILE_TYPE.IMG_PNG, rule: RULE.png },
    { type: FILE_TYPE.IMG_GIF, rule: RULE.gif },
    { type: FILE_TYPE.TEXT_TXT, rule: RULE.text },
    { type: FILE_TYPE.TEXT_CSV, rule: RULE.csv },
    { type: FILE_TYPE.TEXT_XLS, rule: RULE.xls },
    { type: FILE_TYPE.TEXT_XLSX, rule: RULE.xlsx },
    { type: FILE_TYPE.MAC_ZIP, rule: RULE.maczip },
    { type: FILE_TYPE.WIN_ZIP, rule: RULE.winzip },
    { type: FILE_TYPE.APP_JSON, rule: RULE.json },
  ]

  if (extension.value) {
    fileTypesToAdd.forEach(({ type, rule }) => {
      if (extension.value?.includes(type) && !rules.value.includes(rule)) {
        rules.value.push(rule)
      }
    })
  }

  let isDuplicate = false
  if (dataList.value) {
    isDuplicate = dataList.value.some((item) => item === uploadedFile.value.name)

    if (isDuplicate) {
      rules.value.push(RULE.duplication)
    } else {
      rules.value = rules.value.filter((rule) => rule !== RULE.duplication)
    }
  }

  // ファイルサイズを制限
  // if (uploadedFile.value.size > 5242880) {
  //   rule.push(RULE.fileSize)
  // }

  const res = useFileValidation(
    uploadedFile.value.type || '',
    rules.value,
    result,
    props.data?.ruleParams,
    uploadedFile.value.size
  )

  const response = useValidation(uploadedFile.value.name || '', rules.value, result, props.data?.ruleParams)

  if (response === true) {
    if (res === true) {
      inputError.value = ''
      if (props.data) props.data.error = ''
      return true
    } else {
      inputError.value = res
      if (props.data) props.data.error = res
      return false
    }
  } else {
    inputError.value = response
    if (props.data) props.data.error = response
    return false
  }
}
</script>

<style scoped>
.Input {
  position: relative;
}

.Preview {
  position: relative;
}

.Icon {
  position: absolute;
}

.Button {
  width: 100%;
  height: 30px;
  border-radius: 5px;
}

.InputChange {
  position: absolute;
  top: 50px;
  right: 10px;
}

.FilePicker {
  display: flex;
  justify-content: flex-end;
}

.FormContainer {
  width: 100%;
}
</style>
