<template>
  <div class="FormInvoiceWrapper">
    <FormBase
      class="FormEInvoice"
      :base="base"
      :label="label"
      :rule="rule || data?.rule"
      :mode="mode"
      :edit="isEdit"
      :width="width || base?.width"
      :col-width="colWidth"
      :label-width="labelWidth"
      :hint="hint"
      :hintchip="hintchip"
      :error="inputError"
      :result="result"
      :focus="focus"
      :small="small"
      :medium="medium"
      :style="{ minWidth: '420px' }"
    >
      <div
        class="FormInputContainer"
        :style="{
          width: width ? width + 'px' : base?.width ? base.width + 'px' : '100%',
        }"
      >
        <div
          class="FormInputContent"
          :style="{
            width: '100%',
          }"
        >
          <template v-if="isEdit">
            <ButtonToggle
              class="RadioButton colorTXT"
              icon="radio"
              :value="'invoice'"
              :color="'primary'"
              :style="{
                width: '40px',
                minWidth: '40px',
                maxWidth: '40px',
              }"
              :actived="inputMode === 'invoice'"
              @update:value="onModeChange"
            />
            <template v-if="inputMode === 'invoice'">
              <input
                ref="inputItem"
                type="text"
                :id="props.data?.name"
                :name="props.data?.name"
                class="Input"
                :class="{ InputError: inputError }"
                :value="input"
                :placeholder="placeholder"
                :style="{
                  width: '160px',
                  minWidth: '160px',
                  maxWidth: '160px',
                }"
                @input="onChange"
                @focus="onFocus"
                @blur="onBlur"
              />
            </template>
            <input
              v-else
              type="text"
              class="InvoicePreview disable"
              :style="{
                width: '160px',
                minWidth: '160px',
                maxWidth: '160px',
              }"
              :placeholder="'事業者番号入力'"
              disabled
            />

            <ButtonToggle
              class="RadioButton ml-4 colorTXT"
              icon="radio"
              :value="'free'"
              :color="'primary'"
              :actived="inputMode === 'free'"
              :style="{
                width: '40px',
                minWidth: '40px',
                maxWidth: '40px',
              }"
              @update:value="onModeChange"
            />
            <template v-if="inputMode === 'free'">
              <input
                ref="inputItem"
                type="text"
                :id="props.data?.name"
                :name="props.data?.name"
                class="Input Free"
                :style="{ width: 'calc(100% - 250px)' }"
                :class="{ InputError: inputError }"
                :value="input"
                :placeholder="placeholder"
                @input="onChange"
                @focus="onFocus"
                @blur="onBlur"
              />
            </template>
            <input
              v-else
              type="text"
              class="InvoicePreview disable Free"
              :style="{ width: 'calc(100% - 250px)' }"
              :placeholder="'フリーワード入力'"
              disabled
            />
            <div
              class="Icon"
              :style="{
                color: useColor(isDark() ? THEME_COLOR.guide : THEME_COLOR.line),
              }"
            >
              T
            </div>
          </template>
          <template v-else>
            <template v-if="inputMode === 'invoice'">
              <input type="text" class="InvoicePreview disable" :value="input" disabled />
              <div
                class="Icon PreviewIcon"
                :style="{
                  color: useColor(isDark() ? THEME_COLOR.guide : THEME_COLOR.line),
                }"
              >
                T
              </div>
            </template>
            <template v-if="inputMode === 'free'">
              <input type="text" class="InvoicePreview disable Free" :value="input" disabled />
            </template>
          </template>
        </div>
      </div>
    </FormBase>
  </div>
</template>

<script setup lang="ts">
/**===================================================================================================================
   *
   ===================================================================================================================**/
import { FORM_MODE, type formProps } from '../../components/common'
import { RULE, useValidation } from '../../composables/validation'
import { THEME_COLOR } from '../../composables/constants'
import { isDark, useColor } from '../../composables/colors'
import { ref, watch, type Ref } from 'vue'
import Invoice from '~/pages/admin/corporation/invoice.vue'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props extends formProps {
  rule?: any
  value?: string
  inputType?: string
}

const props = withDefaults(defineProps<Props>(), {
  inputType: 'invoice',
})
//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const input: Ref<string | undefined> = ref(props.data?.value || props.value)
const inputError: Ref<string | undefined> = ref(props.error)
const inputItem: Ref<HTMLInputElement | undefined> = ref()
const result: Ref<string | undefined> = ref()
const focus = ref(false)
const isEdit = ref(props.edit || props.base?.edit)

const isAutoInputDisabled = ref(true)
const inputMode = ref(props.inputType)
const inputModeItems = ref([
  { text: 't', value: 'invoice' },
  { text: 'f', value: 'free' },
])
//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
function checkValue(value?: string) {
  //Tから始まる13桁の数字の場合、Tを取る
  if (value) {
    if (/^T\d+/.test(value)) {
      // 文字列が "T" で始まり、数字が続く場合、最初の "T" を削除
      input.value = value.replace(/^T(\d+)/, '$1')
      inputMode.value = 'invoice'
    } else if (/^\d+/.test(value)) {
      // 全て数値なら
      input.value = value
      inputMode.value = 'invoice'
    } else {
      // それ以外の文字列は空文字列に置換
      inputMode.value = 'free'
      input.value = value
    }
  }
}

async function onModeChange(value: any) {
  inputMode.value = value
  validation()
}

watch(
  () => props.value,
  (value) => {
    checkValue(value)
  }
)

watch(
  () => props.error,
  (value) => {
    inputError.value = value
  }
)

watch(
  () => props.inputType,
  (value) => {
    inputMode.value = value
  }
)

watch(
  () => props.data,
  (value) => {
    input.value = value?.value
    if (props.data) {
      if (value?.onCheck === 'check') {
        validation()
        props.data.onCheck = ''
      } else if (value?.onCheck === 'clear') {
        props.data.onCheck = ''
        props.data.error = ''
        inputError.value = ''
        isAutoInputDisabled.value = true
      }
      if (value?.error) {
        inputError.value = value?.error
      } else {
        inputError.value = ''
      }
    }
  },
  {
    deep: true,
  }
)

watch(
  () => props.edit,
  (value) => {
    if (value) {
      isEdit.value = true
      checkValue(props.data?.value)
      validation()
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.base,
  (value) => {
    if (value?.edit) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', value: string): void
  (e: 'update:error', value: string): void
}>()

function onChange(e: Event) {
  const target = e.target as HTMLInputElement

  if (target) {
    input.value = target.value
    if (props.data) {
      props.data.value = target.value
    }
    validation()
    if (inputMode.value === 'invoice') {
      emits('update:value', 'T' + target.value)
    } else {
      emits('update:value', target.value)
    }
    emits('update:error', inputError.value || '')
  }
}

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function onFocus() {
  focus.value = true
}
function onBlur() {
  focus.value = false
  validation()
}

//------------------------------------------------------------------------------------------------------------
// バリデーション
//------------------------------------------------------------------------------------------------------------

function validation() {
  if (props.data) props.data.isCheck = true

  // RULEの確認
  // ルールは、インプットモードで切り替える

  let rule: RULE[] = props.rule || props.data?.rule || []
  if (inputMode.value === 'free') {
    rule = rule.filter((item) => item !== RULE.invoice)
  } else {
    if (!rule.includes(RULE.invoice)) {
      rule.push(RULE.invoice)
    }
  }

  const res = useValidation(input.value || '', rule, result, props.data?.ruleParams)

  if (res === true) {
    inputError.value = ''
    if (props.data) props.data.error = ''
    isAutoInputDisabled.value = false
    return true
  } else {
    inputError.value = res
    if (props.data) props.data.error = res
    isAutoInputDisabled.value = true
    return false
  }
}
</script>

<style scoped>
.Input {
  position: relative;
  padding-left: 28px !important;
}

.Free {
  padding-left: 10px !important;
}

.InvoicePreview {
  position: relative;
  padding: 1px 4px 0 28px;
  padding-left: 28px;
  position: relative;
  border: 1px solid rgba(var(--r-color-line), 0.5);
  color: rgba(var(--r-color-color), 1);
  box-sizing: border-box;
  height: 36px;
  font-size: 14px;
  border-radius: 4px;
  width: 100%;
  min-width: 50px;
}

.disable {
  position: relative;
}

.Icon {
  position: absolute;
  top: 0px;
  left: 38px !important;
  width: 30px;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  color: rgba(var(--r-color-line));
  cursor: default !important;
  font-size: 16px;
  line-height: 16px;
  padding-top: 1px;
}

.PreviewIcon {
  left: 0px !important;
}

.FormInvoiceWrapper {
  display: flex;
  align-items: center;
}
.FormInvoiceWrapper .FormInputContent {
  display: flex;
  justify-content: flex-start;
  align-items: center;
}

.RadioButton {
  position: relative;
  width: 40px;
  height: 30px;
  margin-right: -4px;
  display: flex;
  align-items: center;
  overflow-y: hidden;
}
</style>
