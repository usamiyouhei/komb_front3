<template>
  <FormBase
    class="FormMultiFilePicker"
    :base="base"
    :label="label"
    :rule="rule || data?.rule"
    :mode="mode"
    :edit="isEdit"
    :width="width || base?.width"
    :col-width="colWidth"
    :label-width="labelWidth"
    :hint="hint"
    :hintchip="hintchip"
    :error="inputError"
    :result="result"
    :focus="focus"
    :small="small"
    :medium="medium"
  >
    <div class="MultiFileDragger">
      <div v-for="(item, index) in files" :key="index">
        <PartsFileDragger
          v-if="index < max"
          :extensions="extensions"
          :type="FILE_UPLOAD_TYPE.MULTI"
          :isEdit="edit"
          :data="item"
          @update:value="onUploadFile($event)"
          @update:delete="onDeleteFile($event, index)"
          @update:error="onUploadError($event)"
        />
      </div>

      <div v-if="files.length < max && edit" class="AddButton">
        <ButtonIcon :icon="ICONS.PLUS" :color="useColor(THEME_COLOR.primary)" :size="40" @click="onAddDragger" />
        <div class="Button">写真を追加</div>
      </div>
    </div>
  </FormBase>
</template>

<script setup lang="ts">
/**===================================================================================================================
    *
  ===================================================================================================================**/
import { type formProps, FILE_UPLOAD_TYPE } from '../../components/common'
import { RULE, useValidation } from '../../composables/validation'
import { THEME_COLOR, ICONS } from '../../composables/constants'
import { useColor } from '../../composables/colors'
import { ref, watch, type Ref } from 'vue'

//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props extends formProps {
  rule?: any
  value?: string
  extensions?: string[]
  max?: number
  min?: number
}

const props = withDefaults(defineProps<Props>(), {
  edit: true,
  min: 0,
  max: 100,
})

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const input: Ref<string | undefined> = ref(props.data?.value || props.value)
const inputError: Ref<string | undefined> = ref(props.error)
const focus = ref(false)
const isEdit = ref(props.edit)
const result: Ref<string | undefined> = ref()

const files: Ref<{ file?: File; name?: string; path?: string }[]> = ref([])

//------------------------------------------------------------------------------------------------------------
// Watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.value,
  (value) => {
    if (value) {
      input.value = value
    }
  }
)

watch(
  () => props.error,
  (value) => {
    inputError.value = value
  }
)

watch(
  () => props.data,
  (value) => {
    if (value) {
      if (value.fileValues) {
        files.value = value.fileValues
      }

      if (props.data) {
        if (value?.onCheck === 'check') {
          validation()
          props.data.onCheck = ''
        } else if (value?.onCheck === 'clear') {
          props.data.onCheck = ''
          props.data.error = ''
          inputError.value = ''
        }
      }

      if (value?.error) {
        inputError.value = value?.error
      } else {
        inputError.value = ''
      }
    }
  },
  {
    deep: true,
  }
)

watch(
  () => props.base,
  (value) => {
    if (value?.edit) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.edit,
  (value) => {
    if (value) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
    files.value = files.value.filter((item) => Object.keys(item).length !== 0)
  }
)

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:files', value: { file?: File; name?: string; path?: string }[]): void
  (e: 'update:value', value: { file?: File; name?: string; path?: string }[]): void
  (e: 'update:error', value: string): void
  (e: 'update:reset', value: boolean): void
}>()

function onUploadFile(file: File) {
  const emptyFileSlot = files.value.find((item) => !item.file && !item.path)
  if (emptyFileSlot) {
    emptyFileSlot.file = file
    emptyFileSlot.name = file.name
  } else {
    // 空のスロットがない場合、最後に追加
    files.value.push({ file, name: file.name, path: '' })
  }

  if (props.data) {
    props.data.fileValues = files.value
  }

  validation()
  emits('update:files', files.value)
  emits('update:value', files.value)
  emits('update:error', inputError.value || '')
}

function onDeleteFile(file: File, index: number) {
  files.value.splice(index, 1)
  if (props.data) {
    props.data.fileValues = files.value
  }

  validation()
  emits('update:files', files.value)
  emits('update:value', files.value)
  emits('update:error', inputError.value || '')
}

function onUploadError(error: any) {
  validation(error)
  emits('update:files', files.value)
  emits('update:value', files.value)
  emits('update:error', inputError.value || '')
}

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function onAddDragger() {
  files.value.push({})
}

//-----------------------------------------------------------------------------------------------------------
// バリデーション
//------------------------------------------------------------------------------------------------------------
function validation(error?: string) {
  if (props.data) props.data.isCheck = true

  if (error) {
    if (props.data) props.data.error = error
    return false
  } else {
    if (files.value.length >= props.min) {
      if (props.data) props.data.error = ''
      return true
    } else {
      if (props.data) props.data.error = `最低${props.min}の登録が必要です。`
      return false
    }
  }

  // const rule: RULE[] = props.rule || props.data?.rule || []

  // const res = useValidation(String(input.value) || '', rule, result, props.data?.ruleParams)
  // if (res === true) {
  //   inputError.value = ''
  //   if (props.data) props.data.error = ''
  //   return true
  // } else {
  //   inputError.value = res
  //   if (props.data) props.data.error = res
  //   return false
  // }
}
</script>

<style scoped>
.Input {
  position: relative;
}

.Preview {
  position: relative;
}

.Icon {
  position: absolute;
}

.InputChange {
  position: absolute;
  top: 50px;
  right: 10px;
}

.Area {
  margin-right: 20px;
}

.MultiFileDragger {
  display: flex;
  flex-wrap: wrap;
  width: 100%;
  gap: 10px;
}

.AddButton {
  width: 200px;
  height: 200px;
  background-color: lightgray;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.Button {
  color: rgba(var(--r-color-color), 0.8);
}
</style>
