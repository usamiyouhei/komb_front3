<template>
  <FormBase
    class="FormDateTime"
    :base="base"
    :label="label"
    :rule="rule || data?.rule"
    :mode="mode"
    :edit="isEdit"
    :width="width || base?.width"
    :col-width="colWidth"
    :label-width="labelWidth"
    :hint="hint"
    :hintchip="hintchip"
    :error="inputError"
    :result="result"
    :focus="focus"
    :small="small"
    :medium="medium"
  >
    <div class="FormInputContainer" ref="InputArea">
      <div v-if="prefix" class="Prefix">{{ prefix }}</div>
      <div
        class="FormInputContent"
        :style="{
          width: width ? width + 'px' : base?.width ? base.width + 'px' : '100%',
        }"
      >
        <template v-if="isEdit">
          <input
            :id="props.data?.name"
            :name="props.data?.name"
            class="Input"
            :class="{ InputError: inputError }"
            ref="inputItem"
            type="text"
            :value="input"
            :placeholder="placeholder"
            @input="onChange"
            @focus="onFocus"
            @blur="onBlur"
          />
        </template>
        <input v-else type="text" class="Preview" :value="input" disabled />
        <ButtonInnerForm
          v-if="isEdit"
          class="Icon"
          :icon="FORM_ICONS.DATETIME"
          :size="16"
          :width="30"
          :align="ALIGN.RIGHT"
          @click="onShowSelect"
        />
      </div>
      <div v-if="suffix" class="Suffix">{{ suffix }}</div>
    </div>
    <PartsFloatCard :inputArea="InputArea ? InputArea : null" :switcher="modalSwitch">
      <div class="Contents" :class="{ Grabbing: isDragging }">
        <div class="PickDateTime">
          <input
            class="DatePart Year"
            :class="{ SelectedDate: activeDate === 0, ErrorBorder: yearError }"
            v-model="currentYear"
            type="text"
            pattern="[0-9]{4}"
            maxlength="4"
            @click.stop="onClickDate(0)"
            @input="inputForm($event, 0)"
            @mousedown="onYearMouseDown"
          />
          <span>-</span>
          <input
            class="DatePart Month"
            :class="{ SelectedDate: activeDate === 1, ErrorBorder: monthError }"
            v-model="currentMonth"
            type="text"
            pattern="[0-9]{2}"
            maxlength="2"
            @click.stop="onClickDate(1)"
            @input="inputForm($event, 1)"
            @mousedown="onMonthMouseDown"
          />
          <span>-</span>
          <input
            class="DatePart Day"
            :class="{ SelectedDate: activeDate === 2, ErrorBorder: dayError }"
            v-model="currentDay"
            type="text"
            pattern="[0-9]{2}"
            maxlength="2"
            @click.stop="onClickDate(2)"
            @input="inputForm($event, 2)"
            @mousedown="onDayMouseDown"
          />
          <input
            class="TimePart"
            :class="{ SelectedTime: activeDate === 3, ErrorBorder: hourError }"
            v-model="currentHour"
            type="text"
            pattern="[0-9]{2}"
            maxlength="2"
            @click.stop="onClickDate(3)"
            @input="inputForm($event, 3)"
            @mousedown="onHourMouseDown"
          />
          <span>:</span>
          <input
            class="TimePart"
            :class="{ SelectedTime: activeDate === 4, ErrorBorder: minuteError }"
            v-model="currentMinute"
            type="text"
            pattern="[0-9]{2}"
            maxlength="2"
            @click.stop="onClickDate(4)"
            @input="inputForm($event, 4)"
            @mousedown="onMinuteMouseDown"
          />
          <span>:</span>
          <input
            class="TimePart"
            :class="{ SelectedTime: activeDate === 5, ErrorBorder: secondError }"
            v-model="currentSecond"
            type="text"
            pattern="[0-9]{2}"
            maxlength="2"
            @click.stop="onClickDate(5)"
            @input="inputForm($event, 5)"
            @mousedown="onSecondMouseDown"
          />
        </div>
        <div class="DateTime">
          <div class="Buttons" @click="formatDate">
            <button
              v-if="activeFrame !== -1 && !verticalSwitch.opened"
              class="Button mr-2"
              @click.stop="changeContent('down')"
            >
              &lt;
            </button>
            <button v-if="activeFrame === -1 && !verticalSwitch.opened" class="HiddenButton mr-2"></button>
          </div>
          <div class="VerticalMenu" v-if="verticalSwitch.opened && displayVerticalMenu" :style="themeStyles">
            <div v-if="activeDate === 0">
              <div
                class="Date"
                :class="['HoverVertivalMenu', { selected: year === selectVerticalYear }]"
                ref="divRef"
                v-for="year in yearRange"
                :key="year"
                @click.stop="verticalSetYear(year)"
              >
                {{ year.toString().padStart(4, '0') }}
              </div>
            </div>
            <div v-if="activeDate === 1">
              <div
                class="Date"
                :class="['HoverVertivalMenu', { selected: month === selectVerticalMonth }]"
                ref="divRef"
                v-for="month in monthRange"
                :key="month"
                @click.stop="verticalSetMonth(month)"
              >
                {{ month.toString().padStart(2, '0') }}
              </div>
            </div>
            <div v-if="activeDate === 2">
              <div
                class="Date"
                :class="['HoverVertivalMenu', { selected: day === selectVerticalDay }]"
                ref="divRef"
                v-for="day in dayRange"
                :key="day"
                @click.stop="verticalSetDay(day)"
              >
                {{ day.toString().padStart(2, '0') }}
              </div>
            </div>
            <div v-if="activeDate === 3">
              <div
                v-for="h in hourRange"
                :key="h"
                class="Time"
                :class="['HoverVertivalMenu', { selected: h - 1 === selectVerticalHour }]"
                ref="divRef"
                @click.stop="verticalSetHour(h - 1)"
              >
                {{ (h - 1).toString().padStart(2, '0') }}
              </div>
            </div>
            <div v-if="activeDate === 4">
              <div
                v-for="m in minuteRange"
                :key="m"
                class="Time"
                :class="['HoverVertivalMenu', { selected: m - 1 === selectVerticalMinute }]"
                ref="divRef"
                @click.stop="verticalSetMinute(m - 1)"
              >
                {{ (m - 1).toString().padStart(2, '0') }}
              </div>
            </div>
            <div v-if="activeDate === 5">
              <div
                v-for="s in secondRange"
                :key="s"
                class="Time"
                :class="['HoverVertivalMenu', { selected: s - 1 === selectVerticalSecond }]"
                ref="divRef"
                @click.stop="verticalSetSecond(s - 1)"
              >
                {{ (s - 1).toString().padStart(2, '0') }}
              </div>
            </div>
          </div>
          <div v-else>
            <div class="Calendar" v-if="activeFrame === -1">
              <PartsCalendar
                :selectType="CALENDAR_TYPE.DAY_CALENDAR"
                :date="currentDate"
                :clickReset="false"
                :periodStart="periodStart"
                :periodEnd="periodEnd"
                displayToday
                small
                isDisplay
                @update:date="selectDate"
                @update:month="updateMonth"
                @update:year="updateYear"
              />
            </div>
            <div class="Clock" v-else>
              <PartsClock
                :selectType="CLOCK_TYPE.DIAL"
                :hour="currentHour"
                :minute="currentMinute"
                :second="currentSecond"
                :activeFrame="activeFrame"
                :action="false"
                :reset="resetClockStatus"
                @update:time="selectTime"
                @update:input-state="updateEditState"
                @update:reset="resetClock"
              />
            </div>
          </div>

          <div class="Buttons" @click="formatDate">
            <button
              v-if="activeFrame !== 2 && !verticalSwitch.opened"
              class="Button ml-2"
              @click.stop="changeContent('up')"
            >
              >
            </button>
            <button v-if="activeFrame === 2 && !verticalSwitch.opened" class="HiddenButton ml-2"></button>
          </div>
        </div>
        <div class="ButtonArea">
          <div class="ButtonSet">
            <div class="Set1">
              <ButtonSimple
                v-for="(button, i) in buttons"
                class="DialogButton"
                color="#fff"
                :key="i"
                :width="button.width"
                :text="button.label"
                :small="button.small"
                :backcolor="button.getBackgroundColor ? button.getBackgroundColor() : button.type"
                @click="onClick(i)"
              />
            </div>
          </div>
        </div>
      </div>
    </PartsFloatCard>
  </FormBase>
</template>

<script setup lang="ts">
/**===================================================================================================================
   *
   ===================================================================================================================**/
import { CALENDAR_TYPE, CLOCK_TYPE, type formProps } from '../../components/common'
import { RULE, useValidation } from '../../composables/validation'
import dayjs from 'dayjs'
import { ref, watch, type Ref, computed } from 'vue'
import { THEME_COLOR, FORM_ICONS, ALIGN } from '../../composables/constants'
import { useColor } from '../../composables/colors'
import type { ModalSwitch } from '../../types'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props extends formProps {
  rule?: any
  value?: string
  period?: number
}

const props = withDefaults(defineProps<Props>(), {
  period: 100,
})
//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const input: Ref<string | undefined> = ref(props.data?.value || props.value)
const inputError: Ref<string | undefined> = ref(props.error)
const inputItem: Ref<HTMLInputElement | undefined> = ref()
const result: Ref<string | undefined> = ref()
const focus = ref(false)
const isEdit = ref(props.edit || props.base?.edit)

// モーダル系
const InputArea: Ref<HTMLDivElement | null> = ref(null)
const modalSwitch: Ref<ModalSwitch> = ref({ opened: false })
const verticalSwitch: Ref<ModalSwitch> = ref({ opened: false })
const buttons = ref([
  { label: 'キャンセル', width: 80, small: true, type: THEME_COLOR.secondary },
  { label: 'リセット', width: 80, small: true, type: THEME_COLOR.error },
  {
    label: 'OK',
    width: 80,
    small: false,
    type: THEME_COLOR.primary,
    getBackgroundColor: () => (checkField.value ? THEME_COLOR.guide : THEME_COLOR.primary),
  },
])

// カレンダー変数
// インプットをクリックしたときのメニューの変数
const selectVerticalYear = ref(parseInt(dayjs().format('YYYY')))
const selectVerticalMonth = ref(parseInt(dayjs().format('MM')))
const selectVerticalDay = ref(parseInt(dayjs().format('DD')))
// インプットに表示する変数
const currentYear = ref(dayjs().format('YYYY'))
const currentMonth = ref(dayjs().format('MM'))
const currentDay = ref(dayjs().format('DD'))
const currentDate = ref(dayjs().format('YYYY-MM-DD'))
const date = ref(dayjs().format('YYYY-MM-DD'))
// 現在、表示しているフレームの位置
const activeDate: Ref<number> = ref(2)
// 期間のレンジ
const periodStart = ref(0)
const periodEnd = ref(0)
const yearRange: Ref<number[]> = ref([])
const monthRange = 12

// 時計変数
// インプットをクリックしたときのメニューの変数
const selectVerticalHour = ref(dayjs().hour())
const selectVerticalMinute = ref(dayjs().minute())
const selectVerticalSecond = ref(dayjs().second())
// インプットに表示する変数
const hour = ref(formatTime(dayjs().hour().toString()))
const minute = ref(formatTime(dayjs().minute().toString()))
const second = ref(formatTime(dayjs().second().toString()))
const currentHour = ref(formatTime(dayjs().hour().toString()))
const currentMinute = ref(formatTime(dayjs().minute().toString()))
const currentSecond = ref(formatTime(dayjs().second().toString()))
const time = ref(`${hour.value}:${minute.value}:${second.value}`)
const currentTime = ref(`${currentHour.value}:${currentMinute.value}:${currentSecond.value}`)
// 時計リセット
const resetClockStatus = ref(false)
// 時間のレンジ
const hourRange = 24
const minuteRange = 60
const secondRange = 60
// 時計のフレームの位置
const activeFrame: Ref<number> = ref(-1)

// 日時をドラッグして数値を変化させる値
const lastX = ref()
const accumulatedXDiff = ref(0)
// ドラッグ中カーソルの表示を変えるフラグ
const isDragging = ref(false)
// インプットをクリックしたときの位置指定に使用する変数
const divRef: Ref<HTMLDivElement[] | undefined> = ref()
const selectedElement: Ref<HTMLDivElement | undefined> = ref()
// インプットが編集中であるか判定するフラグ
const isEditingInput = ref(false)
// インプットをクリックしてメニューを表示するかのフラグ
const displayVerticalMenu = ref(false)
//------------------------------------------------------------------------------------------------------------
//computed
//------------------------------------------------------------------------------------------------------------
// 月の最終日を計算
const lastDayOfMonth = computed(() => {
  const paddedYear = currentYear.value.padStart(4, '0')
  const monthValue = parseInt(currentMonth.value, 10)
  if (isNaN(monthValue) || monthValue === 0) {
    return
  }

  const date = dayjs(`${paddedYear}-${currentMonth.value.padStart(2, '0')}-01`)
  return date.endOf('month').date()
})
const dayRange = ref(lastDayOfMonth)

// 使用するカラーを動的に変更
const themeStyles = computed(() => {
  return {
    '--back-color': useColor(THEME_COLOR.background),
    '--primary-color': useColor(THEME_COLOR.primary),
  }
})

// すべての変数が入力されているかをチェック
const checkField = computed(
  () =>
    yearError.value || monthError.value || dayError.value || hourError.value || minuteError.value || secondError.value
)
const yearError = computed(() => {
  return (
    !/^\d{4}$/.test(currentYear.value) ||
    !(Number(currentYear.value) >= periodStart.value && Number(currentYear.value) <= periodEnd.value)
  )
})
const monthError = computed(() => {
  return (
    !/^\d{2}$/.test(currentMonth.value) ||
    !(Number(currentMonth.value) >= 1 && Number(currentMonth.value) <= Number(monthRange))
  )
})

const dayError = computed(() => {
  return (
    !/^\d{2}$/.test(currentDay.value) ||
    !(Number(currentDay.value) >= 1 && Number(currentDay.value) <= Number(dayRange.value))
  )
})

const hourError = computed(() => {
  return !/^\d{2}$/.test(currentHour.value) || !(Number(currentHour.value) >= 0 && Number(currentHour.value) < 24)
})

const minuteError = computed(() => {
  return !/^\d{2}$/.test(currentMinute.value) || !(Number(currentMinute.value) >= 0 && Number(currentMinute.value) < 60)
})

const secondError = computed(() => {
  return !/^\d{2}$/.test(currentSecond.value) || !(Number(currentSecond.value) >= 0 && Number(currentSecond.value) < 60)
})
//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
// 年の期間を動的に変更
watch(
  () => props.period,
  (value) => {
    periodStart.value = parseInt(currentYear.value) - value
    periodEnd.value = parseInt(currentYear.value) + value
    yearRange.value = Array.from(
      { length: periodEnd.value - periodStart.value + 1 },
      (_, index) => periodStart.value + index
    )
  },
  { immediate: true }
)

watch(
  () => props.value,
  (value) => {
    input.value = value
    if (!value) {
      inputError.value = undefined
      value = dayjs().format('YYYY-MM-DD HH:mm:ss')
    }
    const dateTime = dayjs(value).format('YYYY-MM-DD HH:mm:ss')
    const [datePart, timePart] = dateTime.split(' ')

    if (datePart) {
      const [yearPart, monthPart, dayPart] = datePart.split('-')
      currentYear.value = yearPart
      currentMonth.value = monthPart
      currentDay.value = dayPart
      date.value = datePart
    }

    if (timePart) {
      const [hourPart, minutePart, secondPart] = timePart.split(':')
      if (hourPart) hour.value = hourPart
      if (minutePart) minute.value = minutePart
      if (secondPart) second.value = secondPart
    }
  }
)

watch(
  () => props.error,
  (value) => {
    inputError.value = value
  }
)

watch(
  () => props.data,
  (value) => {
    input.value = value?.value
    if (props.data) {
      if (value?.onCheck === 'check') {
        validation()
        props.data.onCheck = ''
      } else if (value?.onCheck === 'clear') {
        props.data.onCheck = ''
        props.data.error = ''
        inputError.value = ''
      }
    }
    if (value?.error) {
      inputError.value = value?.error
    }
  },
  {
    deep: true,
  }
)

watch(
  () => props.edit,
  (value) => {
    if (value) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.base,
  (value) => {
    if (value?.edit) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

// インプットをクリックしたときにdivに色を付けるための変数を動的に変更
watch(
  () => [currentYear.value, currentMonth.value, currentDay.value],
  ([yearValue, monthValue, dayValue]) => {
    selectVerticalYear.value = parseInt(yearValue)
    selectVerticalMonth.value = parseInt(monthValue)
    selectVerticalDay.value = parseInt(dayValue)
  }
)

// インプットをクリックしたときにdivに色を付けるための変数を動的に変更
watch(
  () => [currentHour.value, currentMinute.value, currentSecond.value],
  ([hourValue, minuteValue, secondValue]) => {
    selectVerticalHour.value = parseInt(hourValue)
    selectVerticalMinute.value = parseInt(minuteValue)
    selectVerticalSecond.value = parseInt(secondValue)
  }
)

// インプットが空の状態でインプットを再度クリックすると、NaNが表示される問題を解消するため
// 個別にwatchしてNaNを回避するようにしている
watch(currentYear, (value) => {
  if (!/^\d+$/.test(value)) {
    currentYear.value = ''
  }
})

watch(currentMonth, (value) => {
  if (!/^\d+$/.test(value)) {
    currentMonth.value = ''
  }
})

watch(currentDay, (value) => {
  if (!/^\d+$/.test(value)) {
    currentDay.value = ''
  }
})

watch(currentHour, (value) => {
  if (!/^\d+(\.\d+)?$/.test(value)) {
    currentHour.value = ''
  }
})

watch(currentMinute, (value) => {
  if (!/^\d+(\.\d+)?$/.test(value)) {
    currentMinute.value = ''
  }
})

watch(currentSecond, (value) => {
  if (!/^\d+(\.\d+)?$/.test(value)) {
    currentSecond.value = ''
  }
})
//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', value: string): void
  (e: 'update:error', value: string): void
}>()

function onChange(e: Event) {
  const target = e.target as HTMLInputElement
  if (target) {
    input.value = target.value
    if (props.data) {
      props.data.value = target.value
    }
    validation()
    emits('update:value', target.value)
    emits('update:error', inputError.value || '')
  }
}

// カレンダーの月が変更されたのを感知して変更
function updateMonth(month: number) {
  activeDate.value = 1
  let monthString = month.toString()
  // 文字列が1桁の場合、先頭に '0' を追加
  if (monthString.length === 1) {
    monthString = '0' + monthString
  }
  currentMonth.value = (parseInt(monthString) + 1).toString().padStart(2, '0')
}

// カレンダーの年が変更されたのを感知して変更
function updateYear(year: number) {
  activeDate.value = 0
  currentYear.value = year.toString()
}

// カレンダーで選択された変数をエミットで変数に格納
function selectDate(date: string) {
  const parts = date.split('-')
  if (currentDay.value !== parts[2]) {
    activeDate.value = 2
  }
  currentYear.value = parts[0]
  currentMonth.value = parts[1]
  currentDay.value = parts[2]
  currentDate.value = date
}

// 時計で選択された変数をエミットで変数に格納
function selectTime(hour: number, minute: number, second: number) {
  if (!isEditingInput.value) {
    if (activeFrame.value === 0) {
      currentHour.value = hour.toString().padStart(2, '0')
    } else if (activeFrame.value === 1) {
      currentMinute.value = minute.toString().padStart(2, '0')
    } else if (activeFrame.value === 2) {
      currentSecond.value = second.toString().padStart(2, '0')
    }
  } else {
    if (activeFrame.value === 0) {
      currentHour.value = hour.toString()
    } else if (activeFrame.value === 1) {
      currentMinute.value = minute.toString()
    } else if (activeFrame.value === 2) {
      currentSecond.value = second.toString()
    }
  }

  currentTime.value = formatDateStr('1970-01-01', currentHour.value, currentMinute.value, currentSecond.value)
}

// ボタンをクリックしたときの動作（0：キャンセル、1：リセット、2：OK）
function onClick(num: number) {
  let dateTime
  if (num === 2) {
    if (
      yearError.value ||
      monthError.value ||
      dayError.value ||
      hourError.value ||
      minuteError.value ||
      secondError.value
    )
      return
    hour.value = currentHour.value
    minute.value = currentMinute.value
    second.value = currentSecond.value

    if (currentYear.value === '1970' && currentMonth.value === '01' && currentDay.value === '01') {
      date.value = ''
    } else if (currentDate.value === '') {
      date.value = ''
    } else {
      date.value = dayjs(`${currentYear.value}-${currentMonth.value}-${currentDay.value}`).format('YYYY-MM-DD')
    }

    if (hour.value === '00' && minute.value === '00' && second.value === '00') {
      time.value = `${hour.value}:${minute.value}:${second.value}`
    } else {
      time.value = `${hour.value}:${minute.value}:${second.value}`
    }

    if (date.value === '' || time.value === '') {
      dateTime = ''
    } else {
      dateTime = dayjs(date.value + ' ' + time.value).format('YYYY-MM-DD HH:mm:ss')
    }

    // console.log('出ていく値', dateTime)
    input.value = dateTime
    if (props.data) {
      props.data.value = dateTime
    }
    validation()
    inputError.value = undefined
    verticalSwitch.value.opened = false
    modalSwitch.value.opened = false
    emits('update:value', dateTime)
    emits('update:error', inputError.value || '')
  } else if (num === 1) {
    if (activeFrame.value === -1) {
      date.value = ''
      resetCalendar()
    } else {
      time.value = ''
      resetClockStatus.value = true
    }
  } else if (num === 0) {
    verticalSwitch.value.opened = false
    modalSwitch.value.opened = false
  }
}

function updateEditState(value: boolean) {
  isEditingInput.value = value
}
//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function onFocus() {
  focus.value = true
}
function onBlur() {
  focus.value = false
}

// インプットをクリックして表示されるメニューの年を設定

function verticalSetYear(year: number) {
  const yearStr = year.toString().padStart(4, '0')
  const monthStr = currentMonth.value ? currentMonth.value.toString().padStart(2, '0') : ''
  const dayStr = currentDay.value ? currentDay.value.toString().padStart(2, '0') : ''
  selectVerticalYear.value = year
  currentDate.value = `${yearStr}-${monthStr}-${dayStr}`
  currentYear.value = dayjs(currentDate.value).format('YYYY')
}

// インプットをクリックして表示されるメニューの月を設定
function verticalSetMonth(month: number) {
  const yearStr = currentYear.value ? currentYear.value.padStart(4, '0') : ''
  const monthStr = month.toString().padStart(2, '0')
  const dayStr = currentDay.value ? currentDay.value.toString().padStart(2, '0') : ''
  selectVerticalMonth.value = month
  currentDate.value = `${yearStr}-${monthStr}-${dayStr}`
  currentMonth.value = dayjs(currentDate.value).format('MM')
}

// インプットをクリックして表示されるメニューの日を設定
function verticalSetDay(day: number) {
  const yearStr = currentYear.value ? currentYear.value.padStart(4, '0') : ''
  const monthStr = currentMonth.value ? currentMonth.value.toString().padStart(2, '0') : ''
  const dayStr = day.toString().padStart(2, '0')
  selectVerticalDay.value = day
  currentDate.value = `${yearStr}-${monthStr}-${dayStr}`
  currentDay.value = dayjs(currentDate.value).format('DD')
}

// インプットをクリックして表示されるメニューの時を設定
function verticalSetHour(hour: number) {
  const hourStr = hour.toString().padStart(2, '0')
  const minuteStr = currentMinute.value.padStart(2, '0')
  const secondStr = currentSecond.value.padStart(2, '0')
  selectVerticalHour.value = hour
  currentTime.value = formatDateStr('1970-01-01', hourStr, minuteStr, secondStr)
  const fullTime = `1970-01-01 ${currentTime.value}`
  currentHour.value = dayjs(fullTime).hour().toString().padStart(2, '0')
}

// インプットをクリックして表示されるメニューの分を設定
function verticalSetMinute(minute: number) {
  const hourStr = currentMinute.value.toString().padStart(2, '0')
  const minuteStr = minute.toString().padStart(2, '0')
  const secondStr = currentSecond.value.padStart(2, '0')
  selectVerticalMinute.value = minute
  currentTime.value = formatDateStr('1970-01-01', hourStr, minuteStr, secondStr)
  const fullTime = `1970-01-01 ${currentTime.value}`
  currentMinute.value = dayjs(fullTime).minute().toString().padStart(2, '0')
}

// インプットをクリックして表示されるメニューの秒を設定
function verticalSetSecond(second: number) {
  const hourStr = currentHour.value.toString().padStart(2, '0')
  const minuteStr = currentMinute.value.padStart(2, '0')
  const secondStr = second.toString().padStart(2, '0')
  selectVerticalSecond.value = second
  currentTime.value = formatDateStr('1970-01-01', hourStr, minuteStr, secondStr)
  const fullTime = `1970-01-01 ${currentTime.value}`
  currentSecond.value = dayjs(fullTime).second().toString().padStart(2, '0')
}

// インプットをクリックして表示するメニュー
function onClickDate(frameNum: number) {
  activeDate.value = frameNum
  displayVerticalMenu.value = frameNum === 0 || frameNum === 1
  if (activeDate.value === 2 || activeDate.value === 3 || activeDate.value === 4 || activeDate.value === 5) {
    verticalSwitch.value.opened = false
  } else {
    verticalSwitch.value.opened = true
  }

  setTimeout(() => {
    const elements = divRef.value
    if (!elements) return
    selectedElement.value = Array.from(elements).find((el) => el.classList.contains('selected'))
    if (!selectedElement.value) return
    adjustScrollPosition(selectedElement.value)
  }, 5)

  isEditingInput.value = true
}

// 1桁の数値の前に０を足す
function formatTime(value: string) {
  return value.toString().padStart(2, '0')
}

// 日時のフォーマットを合わせる
function formatDateStr(baseDate: string, h: string, m: string, s: string) {
  return dayjs(`${baseDate} ${h}:${m}:${s}`).format('HH:mm:ss')
}

// FlortCardが開かれるときに数値を最新の数値を格納する
function onShowSelect() {
  activeFrame.value = -1
  const selectedDate = input.value || dayjs().format('YYYY-MM-DD HH:mm:ss')
  const [datePart, timePart] = selectedDate.split(' ')

  if (datePart) {
    const [yearPart, monthPart, dayPart] = datePart.split('-')
    currentYear.value = yearPart
    currentMonth.value = monthPart
    currentDay.value = dayPart
    currentDate.value = dayjs(selectedDate).format('YYYY-MM-DD')
  }

  if (timePart) {
    const [hourPart, minutePart, secondPart] = timePart.split(':')
    if (hourPart) currentHour.value = hourPart
    if (minutePart) currentMinute.value = minutePart
    if (secondPart) currentSecond.value = secondPart
  }
  modalSwitch.value.opened = true
}

// もともとクロックでactiveFrame=0をしようしているため、それに合わせてcalendarは-1から始めている
function changeContent(value: string) {
  if (value === 'down') {
    if (activeFrame.value === -1) return
    activeFrame.value -= 1
  } else if (value === 'up') {
    if (activeFrame.value === 2) return
    activeFrame.value += 1
  }
}

// カレンダー
// ドラッグしたときに発火
function handleMouseDown(event: MouseEvent, mouseMoveHandler: any, mouseUpHandler: any, frameNum: number) {
  isDragging.value = true
  activeFrame.value = frameNum
  lastX.value = event.clientX

  if (activeDate.value === 2 || activeDate.value === 3 || activeDate.value === 4 || activeDate.value === 5) {
    verticalSwitch.value.opened = false
  } else {
    verticalSwitch.value.opened = true
  }
  window.addEventListener('mousemove', mouseMoveHandler)
  window.addEventListener('mouseup', mouseUpHandler)
}

// ドラッグして動いたときに発火
function handleMouseMove(event: MouseEvent, currentValue: string, min: number, max: number, type: string) {
  isEditingInput.value = false
  let variation = 5
  if (type === 'month') {
    variation = 10
  } else if (type === 'minute' || type === 'second') {
    variation = 1
  }

  const diffX = event.clientX - lastX.value
  accumulatedXDiff.value += diffX

  let int = parseInt(currentValue, 10)

  if (Math.abs(accumulatedXDiff.value) >= variation) {
    if (type === 'year' || type === 'month' || type === 'day') {
      if (accumulatedXDiff.value > 0 && int < max) {
        int++
      } else if (accumulatedXDiff.value < 0 && int > min) {
        int--
      }
    } else {
      if (accumulatedXDiff.value > 0) {
        int = int === max ? min : int + 1
      } else if (accumulatedXDiff.value < 0) {
        int = int === min ? max : int - 1
      }
    }
    accumulatedXDiff.value = 0
  }

  currentValue = int < 10 ? '0' + int : int.toString()
  if (type === 'year') {
    currentDate.value = `${currentValue}-${currentMonth.value}-${currentDay.value}`
  } else if (type === 'month') {
    currentDate.value = `${currentYear.value}-${currentValue}-${currentDay.value}`
  } else if (type === 'day') {
    currentDate.value = `${currentYear.value}-${currentMonth.value}-${currentValue}`
  } else if (type === 'hour') {
    currentHour.value = int < 10 ? '0' + int.toString() : int.toString()
  } else if (type === 'minute') {
    currentMinute.value = int < 10 ? '0' + int.toString() : int.toString()
  } else if (type === 'second') {
    currentSecond.value = int < 10 ? '0' + int.toString() : int.toString()
  }

  lastX.value = event.clientX
}
// ドラッグが終わったときに発火
function handleMouseUp(mouseMoveHandler: any) {
  isDragging.value = false
  window.removeEventListener('mousemove', mouseMoveHandler)
}

function onYearMouseDown(event: MouseEvent) {
  activeDate.value = 0
  handleMouseDown(event, onYearMouseMove, onYearMouseUp, -1)
}

function onYearMouseMove(event: MouseEvent) {
  handleMouseMove(event, currentYear.value, periodStart.value, periodEnd.value, 'year')
}

function onYearMouseUp() {
  handleMouseUp(onYearMouseMove)
}

function onMonthMouseDown(event: MouseEvent) {
  activeDate.value = 1
  handleMouseDown(event, onMonthMouseMove, onMonthMouseUp, -1)
}

function onMonthMouseMove(event: MouseEvent) {
  handleMouseMove(event, currentMonth.value, 1, 12, 'month')
}

function onMonthMouseUp() {
  handleMouseUp(onMonthMouseMove)
}

function onDayMouseDown(event: MouseEvent) {
  activeDate.value = 2
  handleMouseDown(event, onDayMouseMove, onDayMouseUp, -1)
}

function onDayMouseMove(event: MouseEvent) {
  const lastDay = dayjs(`${currentYear.value}-${currentMonth.value}-01`).daysInMonth()
  handleMouseMove(event, currentDay.value, 1, lastDay, 'day')
}

function onDayMouseUp() {
  handleMouseUp(onDayMouseMove)
}

// 時計
function onHourMouseDown(event: MouseEvent) {
  activeDate.value = 3
  handleMouseDown(event, onHourMouseMove, onHourMouseUp, 0)
}

function onHourMouseMove(event: MouseEvent) {
  handleMouseMove(event, currentHour.value, 0, 23, 'hour')
}

function onHourMouseUp() {
  handleMouseUp(onHourMouseMove)
}

function onMinuteMouseDown(event: MouseEvent) {
  activeDate.value = 4
  handleMouseDown(event, onMinuteMouseMove, onMinuteMouseUp, 1)
}

function onMinuteMouseMove(event: MouseEvent) {
  handleMouseMove(event, currentMinute.value, 0, 59, 'minute')
}

function onMinuteMouseUp() {
  handleMouseUp(onMinuteMouseMove)
}

function onSecondMouseDown(event: MouseEvent) {
  activeDate.value = 5
  handleMouseDown(event, onSecondMouseMove, onSecondMouseUp, 2)
}

function onSecondMouseMove(event: MouseEvent) {
  handleMouseMove(event, currentSecond.value, 0, 59, 'second')
}

function onSecondMouseUp() {
  handleMouseUp(onSecondMouseMove)
}

// インプットをクリックして表示したメニューの中央に現在選択している日付を設定する
function adjustScrollPosition(element: HTMLDivElement) {
  const rect = element.getBoundingClientRect()
  const container = document.querySelector('.VerticalMenu')
  if (!container) return
  const containerRect = container.getBoundingClientRect()
  const containerCenter = containerRect.top + containerRect.height / 2
  const offset = rect.top + rect.height / 2 - containerCenter
  container.scrollTop += offset
}

// インプットをクリックしたして表示したメニューの範囲外をクリックしたときに、空や半端に入力された数字に一番近しい数字を当てる
function formatDate() {
  verticalSwitch.value.opened = false
  isEditingInput.value = false
  // 年の入力値をチェックし、範囲外であれば修正する
  const yearValue = parseInt(currentYear.value, 10)
  const monthValue = parseInt(currentMonth.value, 10)
  const dayValue = parseInt(currentDay.value, 10)
  const hourValue = parseInt(currentHour.value, 10)
  const minuteValue = parseInt(currentMinute.value, 10)
  const secondValue = parseInt(currentSecond.value, 10)

  if (yearValue < periodStart.value) {
    currentYear.value = periodStart.value.toString()
  } else if (yearValue > periodEnd.value) {
    currentYear.value = periodEnd.value.toString()
  } else if (Number.isNaN(yearValue)) {
    currentYear.value = dayjs().format('YYYY')
  }

  if (monthValue < 1) {
    currentMonth.value = '01'
  } else if (monthValue > 12) {
    currentMonth.value = '12'
  } else if (Number.isNaN(monthValue)) {
    currentMonth.value = '01'
  }

  if (lastDayOfMonth.value) {
    if (dayValue < 1) {
      currentDay.value = '01'
    } else if (dayValue > lastDayOfMonth.value) {
      currentDay.value = lastDayOfMonth.value.toString()
    } else if (Number.isNaN(dayValue)) {
      currentDay.value = '01'
    }
  }

  if (hourValue < 0) {
    currentHour.value = '00'
  } else if (hourValue > 23) {
    currentHour.value = '23'
  } else if (Number.isNaN(hourValue)) {
    currentHour.value = '00'
  }

  if (minuteValue < 0) {
    currentMinute.value = '00'
  } else if (minuteValue > 59) {
    currentMinute.value = '59'
  } else if (Number.isNaN(minuteValue)) {
    currentMinute.value = '00'
  }

  if (secondValue < 0) {
    currentSecond.value = '00'
  } else if (secondValue > 59) {
    currentSecond.value = '59'
  } else if (Number.isNaN(secondValue)) {
    currentSecond.value = '00'
  }

  currentDate.value = `${currentYear.value}-${currentMonth.value}-${currentDay.value}`
  currentTime.value = formatDateStr('1970-01-01', currentHour.value, currentMinute.value, currentSecond.value)
}

// インプットに入力された数字を代入
function inputForm(event: any, activeDate: number) {
  // console.log(event)
  isEditingInput.value = true
  const dateTime = event.target.value
  let yearStr = currentYear.value
  let monthStr = currentMonth.value
  let dayStr = currentDay.value

  if (activeDate === 0) {
    yearStr = dateTime

    if (yearStr.length === 4) {
      if (parseInt(yearStr) < periodStart.value) {
        currentYear.value = periodStart.value.toString()
      } else if (parseInt(yearStr) > periodEnd.value) {
        currentYear.value = periodEnd.value.toString()
      } else {
        currentYear.value = yearStr
      }
    } else if (yearStr.length === 0) {
      currentYear.value = ''
    }
  } else if (activeDate === 1) {
    monthStr = dateTime

    if (monthStr.length === 2) {
      if (parseInt(monthStr) > 12) {
        currentMonth.value = '12'
      } else if (monthStr === '00') {
        currentMonth.value = '01'
      } else {
        currentMonth.value = monthStr
      }
    } else if (monthStr.length === 0) {
      currentMonth.value = ''
    }
  } else if (activeDate === 2) {
    dayStr = dateTime

    if (dayStr.length === 2) {
      if (!lastDayOfMonth.value) return
      if (parseInt(dayStr) > lastDayOfMonth.value) {
        currentDay.value = lastDayOfMonth.value.toString()
      } else if (dayStr === '00') {
        currentDay.value = '01'
      } else {
        currentDay.value = dayStr
      }
    } else if (dayStr.length === 0) {
      currentDay.value = ''
    }
  } else if (activeDate === 3) {
    if (event.inputType === 'deleteContentBackward') {
      isEditingInput.value = true
    } else if (event.inputType === 'insertText') {
      if (dateTime.length === 2) {
        isEditingInput.value = true
      } else {
        isEditingInput.value = false
      }
    }
    currentHour.value = dateTime
  } else if (activeDate === 4) {
    if (event.inputType === 'deleteContentBackward') {
      isEditingInput.value = true
    } else if (event.inputType === 'insertText') {
      if (dateTime.length === 2) {
        isEditingInput.value = true
      } else {
        isEditingInput.value = false
      }
    }
    currentMinute.value = dateTime
  } else if (activeDate === 5) {
    if (event.inputType === 'deleteContentBackward') {
      isEditingInput.value = true
    } else if (event.inputType === 'insertText') {
      if (dateTime.length === 2) {
        isEditingInput.value = true
      } else {
        isEditingInput.value = false
      }
    }
    currentSecond.value = dateTime
  }

  currentDate.value = `${currentYear.value}-${currentMonth.value}-${currentDay.value}`
  currentTime.value = formatDateStr('1970-01-01', currentHour.value, currentMinute.value, currentSecond.value)
}

// リセット系
function resetClock(value: boolean) {
  currentHour.value = '00'
  currentMinute.value = '00'
  currentSecond.value = '00'
  currentTime.value = dayjs(
    '1970-01-01' + ' ' + `${currentHour.value}:${currentMinute.value}:${currentSecond.value}`
  ).format('HH:mm:ss')
  hour.value = '00'
  minute.value = '00'
  second.value = '00'
  time.value = dayjs('1970-01-01' + ' ' + `${hour.value}:${minute.value}:${second.value}`).format('HH:mm:ss')
  selectVerticalHour.value = 0
  selectVerticalMinute.value = 0
  selectVerticalSecond.value = 0
  isEditingInput.value = false
  resetClockStatus.value = value
  if (activeDate.value > 2) {
    activeDate.value = 3
  }
}

function resetCalendar() {
  isEditingInput.value = false
  currentYear.value = '1970'
  currentMonth.value = '01'
  currentDay.value = '01'
  currentDate.value = dayjs('1970-01-01').format('YYYY-MM-DD')
  date.value = dayjs('1970-01-01').format('YYYY-MM-DD')
  selectVerticalYear.value = 1970
  selectVerticalMonth.value = 1
  selectVerticalDay.value = 1
  if (activeDate.value < 3) {
    activeDate.value = 0
  }
}
//------------------------------------------------------------------------------------------------------------
// バリデーション
//------------------------------------------------------------------------------------------------------------

function validation() {
  if (props.data) props.data.isCheck = true

  //RULEの確認
  const rule: RULE[] = props.rule || props.data?.rule || []
  if (!rule.includes(RULE.datetime)) {
    rule.push(RULE.datetime)
  }

  const res = useValidation(input.value || '', rule, result, props.data?.ruleParams)
  if (res === true) {
    inputError.value = ''
    if (props.data) props.data.error = ''
    return true
  } else {
    inputError.value = res
    if (props.data) props.data.error = res
    return false
  }
}
</script>

<style scoped>
.Input {
  position: relative;
}

.Preview {
  position: relative;
}

.Icon {
  position: absolute;
}

.Contents {
  height: 20px;
  line-height: 20px;
  margin-bottom: 5px;
  cursor: pointer;
}

.DateTime {
  display: flex;
  justify-content: center;
}

.Buttons {
  display: flex;
}

.Button,
.HiddenButton {
  margin: auto 0px;
  width: 25px;
  height: 25px;
  font-size: 15px;
  font-weight: bold;
  border-radius: 50%;
  color: rgb(61, 146, 174);
  box-shadow: 1px 1px 3px rgba(148, 148, 148, 0.24);
}

.HiddenButton {
  visibility: hidden;
}

Button:hover {
  opacity: 0.8;
}

Button:active {
  -webkit-transform: translate(0, 1px);
  -moz-transform: translate(0, 1px);
  transform: translate(0, 1px);
}

.PickDateTime {
  width: 250px;
  margin: 10px auto 0 auto;
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  height: 22px;
}

.DatePart {
  border: 1px solid #000;
  border-radius: 3px;
  text-align: center;
}
.DatePart.Year {
  width: 50px;
}
.DatePart.Month, .DatePart.Day {
  width: 32px;
}

.DatePart.Day {
  margin-right: 5px;
}

span {
  line-height: 22px;
}

.TimePart {
  color: var(--fontColor);
  border: 1px solid #000;
  border-radius: 5px;
  width: 32px;
  text-align: center;
}

.Selected,
.SelectedTime,
.SelectedDate {
  font-weight: bold;
  font-size: 15px;
  color: #000;
  height: 22px;
}

.Clock {
  margin-top: 35px;
}

.ButtonSet {
  position: absolute;
  width: 100%;
  bottom: 14px;
  display: flex;
  justify-content: center;
}
.ButtonSet .Set1 {
  display: flex;
  justify-content: center;
  align-items: center;
}
.ButtonSet .Set1 .DialogButton:not(:last-child) {
  margin-right: 5px;
}

.Grabbing * {
  cursor: ew-resize !important;
}

.VerticalMenu {
  width: 250px;
  height: 280px;
  text-align: center;
  margin: 10px auto 0 auto;
  overflow-y: scroll;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.HoverVertivalMenu:hover {
  background-color: var(--back-color);
}

.HoverVertivalMenu.selected,
.HoverVertivalMenu:hover.selected {
  background-color: var(--primary-color);
}

.ErrorBorder {
  border: 2px solid red;
}

.Time {
  width: 200px;
  margin: 0 auto;
}

.Date {
  width: 200px;
  margin: 0 auto;
}
</style>
