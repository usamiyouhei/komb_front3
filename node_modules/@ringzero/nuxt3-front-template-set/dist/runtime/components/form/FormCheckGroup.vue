<template>
  <FormBase
    class="FormCheckGroup"
    :base="base"
    :label="label"
    :rule="rule || data?.rule"
    :mode="mode"
    :edit="isEdit"
    :width="width"
    :col-width="colWidth"
    :label-width="labelWidth"
    :hint="hint"
    :hintchip="hintchip"
    :error="inputError"
    :result="result"
    :focus="focus"
    :line="false"
    :small="small"
    :medium="medium"
  >
    <ButtonCheckSet
      class="mt-1"
      :items="input"
      :inline="inline"
      :color="color"
      :disabled="!isEdit"
      @update:value="onChange($event)"
    />
  </FormBase>
</template>

<script setup lang="ts">
/**===================================================================================================================
   * チェックグループ
   ===================================================================================================================**/
import { type formProps } from '../../components/common'
import { type CheckBoxSetProps } from '../../components/common'
import { RULE } from '../../composables/validation'
import { ref, watch, onMounted, type Ref } from 'vue'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props extends formProps {
  rule?: RULE[]
  items?: CheckBoxSetProps[]
  color?: string
  inline?: boolean
}

const props = withDefaults(defineProps<Props>(), {})
//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const inputError: Ref<string | undefined> = ref(props.error)
const result: Ref<string | undefined> = ref()
const focus = ref(false)
const isEdit = ref(props.edit || props.base?.edit)
const input: Ref<CheckBoxSetProps[] | undefined> = ref(JSON.parse(JSON.stringify(props.items)))
//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onMounted(() => {})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.error,
  (value) => {
    inputError.value = value
  }
)

watch(
  () => props.data,
  (value) => {
    if (props.data) {
      // valuesからのchecked設定
      props.items?.forEach((item) => {
        item.checked = false
      })

      if (value?.values) {
        value.values.forEach((value) => {
          const data = props.items?.find((item) => item.value === value)
          if (data) {
            data.checked = true
          }
        })
      }

      input.value = JSON.parse(JSON.stringify(props.items))

      if (value?.onCheck === 'check') {
        validation()
        props.data.onCheck = ''
      } else if (value?.onCheck === 'clear') {
        props.data.onCheck = ''
        props.data.error = ''
        inputError.value = ''
      }
      if (value?.error) {
        inputError.value = value?.error
      } else {
        inputError.value = ''
      }
    }
  },
  {
    deep: true,
  }
)

watch(
  () => props.edit,
  (value) => {
    if (value) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.base,
  (value) => {
    if (value?.edit) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', value: CheckBoxSetProps[]): void
}>()

function onChange(items: CheckBoxSetProps[]) {
  //Valueは加工しないとイケない
  input.value = items
  if (props.data) {
    // props.data.value = target.value
    const values: string[] = []
    items.forEach((item) => {
      if (item.checked) {
        values.push(item.value)
      }
    })
    props.data.values = values
    props.data.value = values.join(',')
  }
  validation()
  // console.log(items)
  emits('update:value', items)
}

function validation() {
  if (props.data) props.data.isCheck = true
  //チェックグループのバリデーションは、必須の場合のみ
  const rule: RULE[] = props.rule || props.data?.rule || []

  if (rule.includes(RULE.required)) {
    let res
    props.items?.forEach((item) => {
      if (item.checked) res = true
    })
    if (res === true) {
      inputError.value = ''
      if (props.data) props.data.error = ''
      return true
    } else {
      inputError.value = '必須項目です。'
      if (props.data) props.data.error = res
      return false
    }
  }
}

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function onFocus() {
  focus.value = true
}
function onBlur() {
  focus.value = false
}

//------------------------------------------------------------------------------------------------------------
// バリデーション
//------------------------------------------------------------------------------------------------------------
</script>

<style scoped>
.form {
  border: 1px solid #666;
}

.preview {
  border: 1px solid #eee;
}

.Test .ButtonRadioSet {
  color: rgb(var(--v-theme-test));
}
.Test .ButtonRadioSet ::v-deep(.back) .Back {
  box-shadow: 0px 0px 3px 4px rgb(var(--v-theme-test)) !important;
}
.Test .ButtonRadioSet ::v-deep(.back):hover ::v-deep(.Back) {
  box-shadow: 0px 0px 3px 4px rgb(var(--v-theme-test)) !important;
}
.Test .ButtonRadioSet ::v-deep(.back):active ::v-deep(.Back) {
  box-shadow: 0px 0px 3px 4px rgb(var(--v-theme-test)) !important;
}

.Admin .ButtonRadioSet {
  color: rgb(var(--v-theme-admin));
}
.Admin .ButtonRadioSet ::v-deep(.back) ::v-deep(.Back) {
  box-shadow: 0px 0px 3px 4px rgb(var(--v-theme-admin)) !important;
}
.Admin .ButtonRadioSet ::v-deep(.back):hover ::v-deep(.Back) {
  box-shadow: 0px 0px 3px 4px rgb(var(--v-theme-admin)) !important;
}
.Admin .ButtonRadioSet ::v-deep(.back):active ::v-deep(.Back) {
  box-shadow: 0px 0px 3px 4px rgb(var(--v-theme-admin)) !important;
}

.Tenant .ButtonRadioSet {
  color: rgb(var(--v-theme-tenant));
}
.Tenant .ButtonRadioSet ::v-deep(.back) .Back {
  box-shadow: 0px 0px 3px 4px rgb(var(--v-theme-tenant)) !important;
}
.Tenant .ButtonRadioSet ::v-deep(.back):hover ::v-deep(.Back) {
  box-shadow: 0px 0px 3px 4px rgb(var(--v-theme-tenant)) !important;
}
.Tenant .ButtonRadioSet ::v-deep(.back):active ::v-deep(.Back) {
  box-shadow: 0px 0px 3px 4px rgb(var(--v-theme-tenant)) !important;
}
</style>
