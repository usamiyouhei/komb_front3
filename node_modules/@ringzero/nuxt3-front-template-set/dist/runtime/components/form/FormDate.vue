<template>
  <FormBase
    class="FormDate"
    :base="base"
    :label="label"
    :rule="rule || data?.rule"
    :mode="mode"
    :edit="isEdit"
    :width="width || base?.width"
    :col-width="colWidth"
    :label-width="labelWidth"
    :hint="hint"
    :hintchip="hintchip"
    :error="inputError"
    :result="result"
    :focus="focus"
    :small="small"
    :medium="medium"
  >
    <div class="FormInputContainer" ref="InputArea">
      <div v-if="prefix" class="Prefix">{{ prefix }}</div>
      <div
        class="FormInputContent"
        :style="{
          width: width ? width + 'px' : base?.width ? base.width + 'px' : '100%',
        }"
      >
        <template v-if="isEdit">
          <input
            :id="props.data?.name"
            :name="props.data?.name"
            class="Input"
            :class="{ InputError: inputError, Small: base?.small || small, Medium: base?.medium || medium }"
            ref="inputItem"
            type="text"
            :value="input"
            :placeholder="placeholder"
            @input="onChange"
            @focus="onFocus"
            @blur="onBlur"
          />
        </template>
        <input v-else type="text" class="Preview" :value="input" disabled />
        <ButtonInnerForm
          v-if="isEdit"
          class="Icon"
          :icon="FORM_ICONS.DATE"
          :size="16"
          :width="medium ? 24 : small ? 20 : 30"
          :height="medium ? 24 : small ? 20 : undefined"
          :align="ALIGN.RIGHT"
          @click="onShowSelect"
        />
      </div>
      <div v-if="suffix" class="Suffix">{{ suffix }}</div>
    </div>
    <PartsFloatCard :inputArea="InputArea ? InputArea : null" :switcher="modalSwitch">
      <div :class="{ Grabbing: isDragging }">
        <div class="PickDate">
          <input
            class="DatePart Year"
            :class="{ SelectedDate: activeDate === 0, ErrorBorder: yearError }"
            v-model="currentYear"
            type="text"
            pattern="[0-9]{4}"
            maxlength="4"
            @click.stop="onClickDate(0)"
            @input="inputForm($event, 0)"
            @mousedown="onYearMouseDown"
          />
          <span>-</span>
          <input
            class="DatePart Month"
            :class="{ SelectedDate: activeDate === 1, ErrorBorder: monthError }"
            v-model="currentMonth"
            type="text"
            pattern="[0-9]{2}"
            maxlength="2"
            @click.stop="onClickDate(1)"
            @input="inputForm($event, 1)"
            @mousedown="onMonthMouseDown"
          />
          <span v-if="!listCalendar">-</span>
          <input
            v-if="!listCalendar"
            class="DatePart Day"
            :class="{ SelectedDate: activeDate === 2, ErrorBorder: dayError }"
            v-model="currentDay"
            type="text"
            pattern="[0-9]{2}"
            maxlength="2"
            @click.stop="onClickDate(2)"
            @input="inputForm($event, 2)"
            @mousedown="onDayMouseDown"
          />
        </div>
        <div class="Contents">
          <div class="Buttons" @click="formatDate">
            <button
              v-if="activeDate !== 0 && verticalSwitch.opened"
              class="Button mr-2"
              @click.stop="changeContent('down')"
            >
              &lt;
            </button>
            <button v-else class="HiddenButton mr-2"></button>
          </div>
          <div class="VerticalMenu" v-if="verticalSwitch.opened && displayVerticalMenu" :style="themeStyles">
            <div v-if="activeDate === 0">
              <div
                class="Date"
                :class="['HoverVertivalMenu', { selected: year === selectVerticalYear }]"
                ref="divRef"
                v-for="year in yearRange"
                :key="year"
                @click.stop="verticalSetYear(year)"
              >
                {{ year.toString().padStart(4, '0') }}
              </div>
            </div>
            <div v-if="activeDate === 1">
              <div
                class="Date"
                :class="['HoverVertivalMenu', { selected: month === selectVerticalMonth }]"
                ref="divRef"
                v-for="month in monthRange"
                :key="month"
                @click.stop="verticalSetMonth(month)"
              >
                {{ month.toString().padStart(2, '0') }}
              </div>
            </div>
            <div v-if="activeDate === 2">
              <div
                class="Date"
                :class="['HoverVertivalMenu', { selected: day === selectVerticalDay }]"
                ref="divRef"
                v-for="day in dayRange"
                :key="day"
                @click.stop="verticalSetDay(day)"
              >
                {{ day.toString().padStart(2, '0') }}
              </div>
            </div>
          </div>
          <div class="Calendar" v-else ref="calendarRef">
            <PartsCalendar
              v-if="!listCalendar"
              :selectType="CALENDAR_TYPE.DAY_CALENDAR"
              :date="currentDate"
              :clickReset="false"
              :periodStart="periodStart"
              :periodEnd="periodEnd"
              displayToday
              small
              isDisplay
              @update:date="selectDate"
              @update:month="updateMonth"
              @update:year="updateYear"
            />
          </div>
          <div class="Buttons" @click="formatDate">
            <button
              v-if="activeDate !== 1 && verticalSwitch.opened"
              class="Button ml-2"
              @click.stop="changeContent('up')"
            >
              >
            </button>
            <button v-else class="HiddenButton ml-2"></button>
          </div>
        </div>
        <div class="ButtonArea">
          <div class="ButtonSet Set1">
            <ButtonSimple
              v-for="(button, i) in buttons"
              class="DialogButton"
              color="#fff"
              :key="i"
              :width="button.width"
              :text="button.label"
              :small="button.small"
              :backcolor="button.getBackgroundColor ? button.getBackgroundColor() : button.type"
              @click="onClick(i)"
            />
          </div>
        </div>
      </div>
    </PartsFloatCard>
  </FormBase>
</template>

<script setup lang="ts">
/**===================================================================================================================
   *
   ===================================================================================================================**/
import { CALENDAR_TYPE, type formProps } from '../../components/common'
import { RULE, useValidation } from '../../composables/validation'
import dayjs from 'dayjs'
import { THEME_COLOR, FORM_ICONS, ALIGN } from '../../composables/constants'
import { ref, watch, type Ref, computed } from 'vue'
import { useColor } from '../../composables/colors'
import type { ModalSwitch } from '../../types'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props extends formProps {
  rule?: any
  value?: string
  period?: number
  modeList?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  period: 100,
  modeList: false,
})
//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const input: Ref<string | undefined> = ref(props.data?.value || props.value)
const inputError: Ref<string | undefined> = ref(props.error)
const inputItem: Ref<HTMLInputElement | undefined> = ref()
const result: Ref<string | undefined> = ref()
const focus = ref(false)
const isEdit = ref(props.edit || props.base?.edit)

//モーダル系
const InputArea: Ref<HTMLDivElement | null> = ref(null)
const modalSwitch: Ref<ModalSwitch> = ref({ opened: false })
const verticalSwitch: Ref<ModalSwitch> = ref({ opened: false })
const buttons = ref([
  { label: 'キャンセル', width: 80, small: true, type: THEME_COLOR.secondary },
  { label: 'リセット', width: 80, small: true, type: THEME_COLOR.error },
  {
    label: 'OK',
    width: 80,
    small: false,
    type: THEME_COLOR.primary,
    getBackgroundColor: () => (checkField.value ? THEME_COLOR.guide : THEME_COLOR.primary),
  },
])
// カレンダー系
// インプットをクリックしたときのメニューの変数
const selectVerticalYear = ref(parseInt(dayjs().format('YYYY')))
const selectVerticalMonth = ref(parseInt(dayjs().format('MM')))
const selectVerticalDay = ref(parseInt(dayjs().format('DD')))

// インプットに表示する変数
const currentYear = ref(dayjs().format('YYYY'))
const currentMonth = ref(dayjs().format('MM'))
const currentDay = ref(dayjs().format('DD'))
const currentDate = ref(dayjs().format('YYYY-MM-DD'))
const date = ref(dayjs().format('YYYY-MM-DD'))
const activeDate = ref(0)

// 期間のレンジ
const periodStart = ref(0)
const periodEnd = ref(0)
const yearRange: Ref<number[]> = ref([])
const monthRange = 12
// 日付をドラッグして数値を変化させる値
const lastX = ref()
const accumulatedXDiff = ref(0)
// ドラッグ中カーソルの表示を変えるフラグ
const isDragging = ref(false)
// インプットをクリックしたときの位置指定に使用する変数
const divRef: Ref<HTMLDivElement[] | undefined> = ref()
const selectedElement: Ref<HTMLDivElement | undefined> = ref()
// インプットをクリックしてメニューを表示するかのフラグ
const displayVerticalMenu = ref(false)
// 年と月のリストで表示するフラグ
const listCalendar = ref(props.modeList)
//------------------------------------------------------------------------------------------------------------
//computed
//------------------------------------------------------------------------------------------------------------
// 月の最終日を計算
const lastDayOfMonth = computed(() => {
  const paddedYear = currentYear.value.padStart(4, '0')
  const monthValue = parseInt(currentMonth.value, 10)
  if (isNaN(monthValue) || monthValue === 0) {
    return
  }

  const date = dayjs(`${paddedYear}-${currentMonth.value.padStart(2, '0')}-01`)
  return date.endOf('month').date()
})
const dayRange = ref(lastDayOfMonth)

// 使用するカラーを動的に変更
const themeStyles = computed(() => {
  return {
    '--back-color': useColor(THEME_COLOR.background),
    '--primary-color': useColor(THEME_COLOR.primary),
  }
})

// すべての変数が入力されているかをチェック
const checkField = computed(() => {
  if (listCalendar.value) {
    return yearError.value || monthError.value
  } else {
    return yearError.value || monthError.value || dayError.value
  }
})

const yearError = computed(() => {
  return (
    !/^\d{4}$/.test(currentYear.value) ||
    !(Number(currentYear.value) >= periodStart.value && Number(currentYear.value) <= periodEnd.value)
  )
})

const monthError = computed(() => {
  return (
    !/^\d{2}$/.test(currentMonth.value) ||
    !(Number(currentMonth.value) >= 1 && Number(currentMonth.value) <= Number(monthRange))
  )
})

const dayError = computed(() => {
  return (
    !/^\d{2}$/.test(currentDay.value) ||
    !(Number(currentDay.value) >= 1 && Number(currentDay.value) <= Number(dayRange.value))
  )
})
//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
// 年の期間を動的に変更
watch(
  () => props.period,
  (value) => {
    periodStart.value = parseInt(currentYear.value) - value
    periodEnd.value = parseInt(currentYear.value) + value
    yearRange.value = Array.from(
      { length: periodEnd.value - periodStart.value + 1 },
      (_, index) => periodStart.value + index
    )
  },
  { immediate: true }
)

watch(
  () => props.value,
  (value) => {
    // console.log('入ってきた値', value)
    input.value = value
    if (!value) {
      inputError.value = undefined
      value = dayjs().format('YYYY-MM-DD')
    }
    date.value = dayjs(value).format('YYYY-MM-DD')
    const [yearPart, monthPart, dayPart] = date.value.split('-')
    currentYear.value = yearPart
    currentMonth.value = monthPart
    currentDay.value = dayPart
  }
)

watch(
  () => props.error,
  (value) => {
    inputError.value = value
  }
)

watch(
  () => props.data,
  (value) => {
    input.value = value?.value
    if (props.data) {
      if (value?.onCheck === 'check') {
        validation()
        props.data.onCheck = ''
      } else if (value?.onCheck === 'clear') {
        props.data.onCheck = ''
        props.data.error = ''
        inputError.value = ''
      }
    }
    if (value?.error) {
      inputError.value = value?.error
    }
  },
  {
    deep: true,
  }
)

watch(
  () => props.edit,
  (value) => {
    if (value) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.base,
  (value) => {
    if (value?.edit) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

// インプットをクリックしたときにdivに色を付けるための変数を動的に変更
watch(
  () => [currentYear.value, currentMonth.value, currentDay.value],
  ([yearValue, monthValue, dayValue]) => {
    selectVerticalYear.value = parseInt(yearValue)
    selectVerticalMonth.value = parseInt(monthValue)
    selectVerticalDay.value = parseInt(dayValue)
  }
)

watch(currentYear, (value) => {
  if (!/^\d+$/.test(value)) {
    currentYear.value = ''
  }
})

watch(currentMonth, (value) => {
  if (!/^\d+$/.test(value)) {
    currentMonth.value = ''
  }
})

watch(currentDay, (value) => {
  if (!/^\d+$/.test(value)) {
    currentDay.value = ''
  }
})

watch(
  () => props.modeList,
  (value) => {
    listCalendar.value = value
    displayVerticalMenu.value = value
    verticalSwitch.value.opened = value
  },
  { immediate: true }
)

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', value: string): void
  (e: 'update:error', value: string): void
}>()

// カレンダーの月が変更されたのを感知して変更
function updateMonth(month: number) {
  activeDate.value = 1
  let monthString = month.toString()
  // 文字列が1桁の場合、先頭に '0' を追加
  if (monthString.length === 1) {
    monthString = '0' + monthString
  }
  currentMonth.value = (parseInt(monthString) + 1).toString().padStart(2, '0')
}

// カレンダーの年が変更されたのを感知して変更
function updateYear(year: number) {
  activeDate.value = 0
  currentYear.value = year.toString()
}

function onChange(e: Event) {
  const target = e.target as HTMLInputElement
  if (target) {
    input.value = target.value
    if (props.data) {
      props.data.value = target.value
    }
    validation()
    emits('update:value', target.value)
    emits('update:error', inputError.value || '')
  }
}

// 1日のみ選択のカレンダーのみ対応
function selectDate(date: string) {
  const parts = date.split('-')
  if (currentDay.value !== parts[2]) {
    activeDate.value = 2
  }
  currentYear.value = parts[0]
  currentMonth.value = parts[1]
  currentDay.value = parts[2]
  currentDate.value = date
}

// ボタンをクリックしたときの動作（0：キャンセル、1：リセット、2：OK）
function onClick(num: number) {
  if (num === 2) {
    if (listCalendar.value) {
      if (yearError.value || monthError.value) return
    } else {
      if (yearError.value || monthError.value || dayError.value) return
    }
    if (currentYear.value === '1970' && currentMonth.value === '01' && currentDay.value === '01') {
      date.value = ''
    } else if (currentDate.value === '') {
      date.value = ''
    } else {
      if (listCalendar.value) {
        date.value = dayjs(`${currentYear.value}-${currentMonth.value}-${currentDay.value}`).format('YYYY-MM')
      } else {
        date.value = dayjs(`${currentYear.value}-${currentMonth.value}-${currentDay.value}`).format('YYYY-MM-DD')
      }
    }

    // console.log('出ていく値', date.value)
    input.value = date.value
    if (props.data) {
      props.data.value = date.value
    }
    validation()
    emits('update:value', date.value)
    emits('update:error', inputError.value || '')
    if (!listCalendar.value) {
      verticalSwitch.value.opened = false
    }
    modalSwitch.value.opened = false
    inputError.value = undefined
  } else if (num === 1) {
    resetCalendar()
  } else if (num === 0) {
    if (!listCalendar.value) {
      verticalSwitch.value.opened = false
    }
    modalSwitch.value.opened = false
  }
}

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function onFocus() {
  focus.value = true
}

function onBlur() {
  focus.value = false
}

function verticalSetYear(year: number) {
  const yearStr = year.toString().padStart(4, '0')
  const monthStr = currentMonth.value ? currentMonth.value.toString().padStart(2, '0') : ''
  const dayStr = currentDay.value ? currentDay.value.toString().padStart(2, '0') : ''
  selectVerticalYear.value = year
  currentDate.value = `${yearStr}-${monthStr}-${dayStr}`
  currentYear.value = dayjs(currentDate.value).format('YYYY')
}

// インプットをクリックして表示されるメニューの月を設定
function verticalSetMonth(month: number) {
  const yearStr = currentYear.value ? currentYear.value.padStart(4, '0') : ''
  const monthStr = month.toString().padStart(2, '0')
  const dayStr = currentDay.value ? currentDay.value.toString().padStart(2, '0') : ''
  selectVerticalMonth.value = month
  currentDate.value = `${yearStr}-${monthStr}-${dayStr}`
  currentMonth.value = dayjs(currentDate.value).format('MM')
}

// インプットをクリックして表示されるメニューの日を設定
function verticalSetDay(day: number) {
  const yearStr = currentYear.value ? currentYear.value.padStart(4, '0') : ''
  const monthStr = currentMonth.value ? currentMonth.value.toString().padStart(2, '0') : ''
  const dayStr = day.toString().padStart(2, '0')
  selectVerticalDay.value = day
  currentDate.value = `${yearStr}-${monthStr}-${dayStr}`
  currentDay.value = dayjs(currentDate.value).format('DD')
}

// インプットをクリックして表示するメニュー
function onClickDate(frameNum: number) {
  activeDate.value = frameNum
  displayVerticalMenu.value = frameNum === 0 || frameNum === 1
  if (activeDate.value === 2) {
    verticalSwitch.value.opened = false
  } else {
    verticalSwitch.value.opened = true
  }

  setTimeout(() => {
    const elements = divRef.value
    if (!elements) return
    selectedElement.value = Array.from(elements).find((el) => el.classList.contains('selected'))
    if (!selectedElement.value) return
    adjustScrollPosition(selectedElement.value)
  }, 1)
}

// FlortCardが開かれるときに数値を最新の数値を格納する
function onShowSelect() {
  const selectedDate = input.value || dayjs().format('YYYY-MM-DD')
  const parts = selectedDate.split('-')

  currentYear.value = parts[0]
  currentMonth.value = parts[1]
  currentDay.value = parts[2]
  currentDate.value = selectedDate

  if (listCalendar.value) {
    activeDate.value = 0

    setTimeout(() => {
      let elements
      if (activeDate.value === 0) {
        elements = divRef.value
      } else if (activeDate.value === 1) {
        elements = divRef.value
      }
      if (!elements) return
      selectedElement.value = Array.from(elements).find((el) => el.classList.contains('selected'))
      if (!selectedElement.value) return
      adjustScrollPosition(selectedElement.value)
    }, 1)
  }
  modalSwitch.value.opened = true
}

// ドラッグしたときに発火
function handleMouseDown(event: MouseEvent, mouseMoveHandler: any, mouseUpHandler: any) {
  if (activeDate.value === 2) {
    verticalSwitch.value.opened = false
  } else {
    verticalSwitch.value.opened = true
  }
  isDragging.value = true
  lastX.value = event.clientX
  window.addEventListener('mousemove', mouseMoveHandler)
  window.addEventListener('mouseup', mouseUpHandler)
}

// ドラッグして動いたときに発火
function handleMouseMove(event: MouseEvent, currentValue: string, min: number, max: number, type: string) {
  let variation = 5
  if (type === 'month') {
    variation = 10
  }

  const diffX = event.clientX - lastX.value
  accumulatedXDiff.value += diffX

  let int = parseInt(currentValue, 10)

  if (Math.abs(accumulatedXDiff.value) >= variation) {
    if (accumulatedXDiff.value > 0 && int < max) {
      int++
    } else if (accumulatedXDiff.value < 0 && int > min) {
      int--
    }
    accumulatedXDiff.value = 0
  }

  currentValue = int < 10 ? '0' + int : int.toString()
  if (type === 'year') {
    currentYear.value = currentValue
    currentDate.value = `${currentValue}-${currentMonth.value}-${currentDay.value}`
  } else if (type === 'month') {
    currentMonth.value = currentValue
    currentDate.value = `${currentYear.value}-${currentValue}-${currentDay.value}`
  } else if (type === 'day') {
    currentDay.value = currentValue
    currentDate.value = `${currentYear.value}-${currentMonth.value}-${currentValue}`
  }

  lastX.value = event.clientX
}

// ドラッグが終わったときに発火
function handleMouseUp(mouseMoveHandler: any) {
  isDragging.value = false
  window.removeEventListener('mousemove', mouseMoveHandler)
}

function onYearMouseDown(event: MouseEvent) {
  activeDate.value = 0
  handleMouseDown(event, onYearMouseMove, onYearMouseUp)
}

function onYearMouseMove(event: MouseEvent) {
  handleMouseMove(event, currentYear.value, periodStart.value, periodEnd.value, 'year')
}

function onYearMouseUp() {
  handleMouseUp(onYearMouseMove)
}

function onMonthMouseDown(event: MouseEvent) {
  activeDate.value = 1
  handleMouseDown(event, onMonthMouseMove, onMonthMouseUp)
}

function onMonthMouseMove(event: MouseEvent) {
  handleMouseMove(event, currentMonth.value, 1, 12, 'month')
}

function onMonthMouseUp() {
  handleMouseUp(onMonthMouseMove)
}

function onDayMouseDown(event: MouseEvent) {
  activeDate.value = 2
  handleMouseDown(event, onDayMouseMove, onDayMouseUp)
}

function onDayMouseMove(event: MouseEvent) {
  const lastDay = dayjs(`${currentYear.value}-${currentMonth.value}-01`).daysInMonth()
  handleMouseMove(event, currentDay.value, 1, lastDay, 'day')
}

function onDayMouseUp() {
  handleMouseUp(onDayMouseMove)
}

// インプットをクリックして表示したメニューの中央に現在選択している日付を設定する
function adjustScrollPosition(element: HTMLDivElement) {
  const rect = element.getBoundingClientRect()
  const container = document.querySelector('.VerticalMenu')
  if (!container) return
  const containerRect = container.getBoundingClientRect()
  const containerCenter = containerRect.top + containerRect.height / 2
  const offset = rect.top + rect.height / 2 - containerCenter
  container.scrollTop += offset
}

// インプットをクリックしたして表示したメニューの範囲外をクリックしたときに、空や半端に入力された数字に一番近しい数字を当てる
function formatDate() {
  if (!listCalendar.value) {
    verticalSwitch.value.opened = false
    // 年の入力値をチェックし、範囲外であれば修正する
    const yearValue = parseInt(currentYear.value, 10)
    const monthValue = parseInt(currentMonth.value, 10)
    const dayValue = parseInt(currentDay.value, 10)

    if (yearValue < periodStart.value) {
      currentYear.value = periodStart.value.toString()
    } else if (yearValue > periodEnd.value) {
      currentYear.value = periodEnd.value.toString()
    } else if (Number.isNaN(yearValue)) {
      currentYear.value = dayjs().format('YYYY')
    }

    if (monthValue < 1) {
      currentMonth.value = '01'
    } else if (monthValue > 12) {
      currentMonth.value = '12'
    } else if (Number.isNaN(monthValue)) {
      currentMonth.value = '01'
    }

    if (lastDayOfMonth.value) {
      if (dayValue < 1) {
        currentDay.value = '01'
      } else if (dayValue > lastDayOfMonth.value) {
        currentDay.value = lastDayOfMonth.value.toString()
      } else if (Number.isNaN(dayValue)) {
        currentDay.value = '01'
      }
    }
    currentDate.value = `${currentYear.value}-${currentMonth.value}-${currentDay.value}`
  }
}

// インプットに入力された数字を代入
function inputForm(event: any, activeDate: number) {
  const date = event.target.value
  let yearStr = currentYear.value
  let monthStr = currentMonth.value
  let dayStr = currentDay.value
  if (activeDate === 0) {
    yearStr = date

    if (yearStr.length === 4) {
      if (parseInt(yearStr) < periodStart.value) {
        currentYear.value = periodStart.value.toString()
      } else if (parseInt(yearStr) > periodEnd.value) {
        currentYear.value = periodEnd.value.toString()
      } else {
        currentYear.value = yearStr
      }
    } else if (yearStr.length === 0) {
      currentYear.value = ''
    }
  } else if (activeDate === 1) {
    monthStr = date

    if (monthStr.length === 2) {
      if (parseInt(monthStr) > 12) {
        currentMonth.value = '12'
      } else if (monthStr === '00') {
        currentMonth.value = '01'
      } else {
        currentMonth.value = monthStr
      }
    } else if (monthStr.length === 0) {
      currentMonth.value = ''
    }
  } else if (activeDate === 2) {
    dayStr = date

    if (dayStr.length === 2) {
      if (!lastDayOfMonth.value) return
      if (parseInt(dayStr) > lastDayOfMonth.value) {
        currentDay.value = lastDayOfMonth.value.toString()
      } else if (dayStr === '00') {
        currentDay.value = '01'
      } else {
        currentDay.value = dayStr
      }
    } else if (dayStr.length === 0) {
      currentDay.value = ''
    }
  }
  currentDate.value = `${currentYear.value}-${currentMonth.value}-${currentDay.value}`
}

function changeContent(value: string) {
  if (value === 'down') {
    if (activeDate.value === 0) return
    activeDate.value -= 1
  } else if (value === 'up') {
    if (activeDate.value === 1) return
    activeDate.value += 1
  }

  setTimeout(() => {
    let elements
    if (activeDate.value === 0) {
      elements = divRef.value
    } else if (activeDate.value === 1) {
      elements = divRef.value
    }
    if (!elements) return
    selectedElement.value = Array.from(elements).find((el) => el.classList.contains('selected'))
    if (!selectedElement.value) return
    adjustScrollPosition(selectedElement.value)
  }, 1)
}

// 日付をリセット
function resetCalendar() {
  currentYear.value = '1970'
  currentMonth.value = '01'
  currentDay.value = '01'
  currentDate.value = dayjs('1970-01-01').format('YYYY-MM-DD')
  date.value = dayjs('1970-01-01').format('YYYY-MM-DD')
  selectVerticalYear.value = 1970
  selectVerticalMonth.value = 1
  selectVerticalDay.value = 1
  activeDate.value = 0
}
//------------------------------------------------------------------------------------------------------------
// バリデーション
//------------------------------------------------------------------------------------------------------------
function validation() {
  if (props.data) props.data.isCheck = true

  //RULEの確認
  const rule: RULE[] = props.rule || props.data?.rule || []
  if (listCalendar.value) {
    // リストの場合は、年と月だけを選択できる
    if (!rule.includes(RULE.dateList)) {
      rule.push(RULE.dateList)
    }
  } else {
    if (!rule.includes(RULE.date)) {
      rule.push(RULE.date)
    }
  }

  const res = useValidation(input.value || '', rule, result, props.data?.ruleParams)
  if (res === true) {
    inputError.value = ''
    if (props.data) props.data.error = ''
    return true
  } else {
    inputError.value = res
    if (props.data) props.data.error = res
    return false
  }
}
</script>

<style scoped>
.Input {
  position: relative;
}

.Preview {
  position: relative;
}

.Icon {
  position: absolute;
}

.Contents {
  display: flex;
  justify-content: center;
}

.ClickErea {
  width: 50px;
}

.Calendar,
.PickDate {
  display: flex;
  justify-content: center;
}

.PickDate {
  display: flex;
  align-items: center;
  font-size: 14px;
  height: 22px;
  margin: 5px 0;
}

.DatePart {
  height: 22px;
  text-align: center;
  line-height: 22px;
  border: 1px solid #000;
  border-radius: 3px;
}

.SelectedDate {
  font-size: 15px;
  font-weight: bold;
  color: #000;
}

.Year {
  width: 50px;
}

.Month,
.Day {
  width: 32px;
}

.Date {
  margin: 0 auto;
  width: 200px;
}

span {
  height: 22px;
  line-height: 22px;
}

.ButtonSet {
  position: absolute;
  width: 100%;
  bottom: 14px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.Set1 {
  align-items: center;
}

.Set1 .DialogButton:not(:last-child) {
  margin-right: 5px;
}

.Grabbing * {
  cursor: ew-resize !important;
}

.VerticalMenu {
  width: 250px;
  height: 280px;
  text-align: center;
  margin-top: 10px;
  overflow-y: scroll;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.HoverVertivalMenu:hover {
  background-color: var(--back-color);
}

.HoverVertivalMenu.selected,
.HoverVertivalMenu:hover.selected {
  background-color: var(--primary-color);
}

.ErrorBorder {
  border: 2px solid red;
}

.Buttons {
  display: flex;
}

.Button,
.HiddenButton {
  margin: auto 0px;
  width: 25px;
  height: 25px;
  font-size: 15px;
  font-weight: bold;
  border-radius: 50%;
  color: rgb(61, 146, 174);
  box-shadow: 1px 1px 3px rgba(148, 148, 148, 0.24);
}

.HiddenButton {
  visibility: hidden;
}

Button:hover {
  opacity: 0.8;
}

Button:active {
  -webkit-transform: translate(0, 1px);
  -moz-transform: translate(0, 1px);
  transform: translate(0, 1px);
}
</style>
