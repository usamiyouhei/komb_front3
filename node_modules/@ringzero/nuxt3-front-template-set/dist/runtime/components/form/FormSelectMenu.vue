<template>
  <FormBase
    class="FormSelectMenu"
    :base="base"
    :label="label"
    :rule="rule || data?.rule"
    :mode="mode"
    :edit="isEdit"
    :width="width"
    :col-width="colWidth"
    :label-width="labelWidth"
    :hint="hint"
    :hintchip="hintchip"
    :error="inputError"
    :result="result"
    :focus="focus"
    :line="false"
    :small="small"
    :medium="medium"
  >
    <PartsSelectMenu
      :value="input"
      :inputType="inputType"
      :selectType="selectType"
      :items="items"
      :height="height"
      :disabled="!isEdit"
      :layout="layout"
      fit
      @update:value="onChange($event)"
    />
  </FormBase>
</template>

<script setup lang="ts">
/**===================================================================================================================
* 
===================================================================================================================**/
import { FORM_MODE, type formProps, type formItem } from '../../components/common'
import { SELECT_INPUT_TYPE, SELECT_LIST_TYPE } from '../../components/common'
import { POSITION } from '../../composables/constants'
import { RULE, useValidation } from '../../composables/validation'
import { ref, watch, type Ref, onMounted } from 'vue'

//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props extends formProps {
  items: any[]
  value?: string | number
  inputType?: SELECT_INPUT_TYPE
  selectType?: SELECT_LIST_TYPE
  layout?: POSITION

  height?: number
  color?: string
  rule?: any
}

const props = withDefaults(defineProps<Props>(), {
  inputType: SELECT_INPUT_TYPE.FRAME,
  selectType: SELECT_LIST_TYPE.DEFAULT,
})

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const inputError: Ref<string | undefined> = ref(props.error)
const result: Ref<string | undefined> = ref()
const focus = ref(false)
const isEdit = ref(props.edit || props.base?.edit)
const input = ref(props.value || props.data?.value)

//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onMounted(() => {
  setDefault()
})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.value,
  (value) => {
    input.value = value
  }
)

watch(
  () => props.error,
  (value) => {
    inputError.value = value
  }
)

watch(
  () => props.data,
  (value) => {
    input.value = value?.value
    setDefault()
    if (props.data) {
      if (value?.onCheck === 'check') {
        validation()
        if (value.value) {
          emits('update:value', String(input.value))
          emits('update:error', inputError.value || '')
        }
        props.data.onCheck = ''
      } else if (value?.onCheck === 'clear') {
        props.data.onCheck = ''
        props.data.error = ''
        inputError.value = ''
      }
    }
    if (value?.error) {
      inputError.value = value?.error
    }
  },
  {
    deep: true,
  }
)

watch(
  () => props.edit,
  (value) => {
    if (value) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.base,
  (value) => {
    if (value?.edit) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', value: string): void
  (e: 'update:error', value: string): void
}>()

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function setDefault() {
  if (!input.value && props.items) {
    for (let i = 0; i < props.items.length; i++) {
      const item = props.items[i]
      if (item.default) {
        input.value = item.value
        if (props.data) {
          props.data.value = item.value
        }
        break
      }
    }
    if (props.data) {
      props.data.isCheck = true
    }
  }
}

function onChange(value: any) {
  input.value = value
  if (props.data) {
    props.data.value = value
  }
  validation()
  emits('update:value', value)
  emits('update:error', inputError.value || '')
}

function validation() {
  if (props.data) props.data.isCheck = true
  const rule: RULE[] = props.rule || props.data?.rule || []

  if (rule.includes(RULE.required)) {
    //選択項目に値が無ければerror
    const item = props.items.find((item) => item.value === input.value)
    if (!item) {
      inputError.value = '必須項目です。'
      if (props.data) props.data.error = '必須項目です。'
      return false
    }
  }

  const res = useValidation(String(input.value), rule, result, props.data?.ruleParams)

  if (res === true) {
    inputError.value = ''
    if (props.data) props.data.error = ''
    return true
  } else {
    inputError.value = res
    if (props.data) props.data.error = res
    return false
  }
}
</script>

<style lang="scss" scoped></style>
