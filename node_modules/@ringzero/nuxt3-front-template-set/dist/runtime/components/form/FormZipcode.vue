<template>
  <div class="FormEMailWrapper" :class="{ Column2: base?.column === 2, Column3: base?.column === 3 }">
    <FormBase
      class="FormEMail"
      :base="base"
      :label="label"
      :rule="rule || data?.rule"
      :mode="mode"
      :edit="isEdit"
      :width="width || base?.width"
      :col-width="colWidth"
      :label-width="labelWidth"
      :hint="hint"
      :hintchip="hintchip"
      :error="inputError"
      :result="result"
      :focus="focus"
      :small="small"
      :medium="medium"
      :style="{
        width: '170px',
      }"
    >
      <div
        class="FormInputContainer"
        :style="{
          width: '120px',
        }"
      >
        <div v-if="prefix" class="Prefix">{{ prefix }}</div>
        <div
          class="FormInputContent"
          :style="{
            width: width ? width + 'px' : base?.width ? base.width + 'px' : '100%',
          }"
        >
          <template v-if="isEdit">
            <input
              ref="inputItem"
              type="text"
              :id="props.data?.name"
              :name="props.data?.name"
              class="Input"
              :class="{ InputError: inputError }"
              :value="input"
              :placeholder="placeholder"
              @input="onChange"
              @focus="onFocus"
              @blur="onBlur"
            />
          </template>
          <input v-else type="text" class="Preview" :value="input" disabled />
          <div
            class="Icon"
            :style="{
              color: useColor(isDark() ? THEME_COLOR.guide : THEME_COLOR.line),
            }"
          >
            〒
          </div>
        </div>
        <div v-if="suffix" class="Suffix">{{ suffix }}</div>
      </div>
    </FormBase>
    <ButtonSimple
      v-if="isAutoInput && isEdit"
      text="住所自動入力"
      small
      class="AutoButton"
      :style="{
        top: view === FORM_MODE.DEFAULT ? '24px' : '6px',
        left:
          view === FORM_MODE.DEFAULT || view === FORM_MODE.SIMPLE
            ? '136px'
            : labelWidthInput
              ? labelWidthInput + 146 + 'px'
              : 120 + 136 + 'px',
      }"
      :disabled="isAutoInputDisabled"
      @click="onAutoInput"
    />
  </div>
</template>

<script setup lang="ts">
/**===================================================================================================================
   *
   ===================================================================================================================**/
import { FORM_MODE, type formProps, type formItem } from '../../components/common'
import { RULE, useValidation } from '../../composables/validation'
import { THEME_COLOR } from '../../composables/constants'
import { isDark, useColor } from '../../composables/colors'
import { ref, watch, type Ref, onBeforeMount } from 'vue'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props extends formProps {
  rule?: any
  value?: string
  isAutoInput?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  isAutoInput: true,
})
//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const input: Ref<string | undefined> = ref(props.data?.value || props.value)
const inputError: Ref<string | undefined> = ref(props.error)
const inputItem: Ref<HTMLInputElement | undefined> = ref()
const result: Ref<string | undefined> = ref()
const focus = ref(false)
const isEdit = ref(props.edit || props.base?.edit)

const isAutoInputDisabled = ref(true)

//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
const view = ref('')
const labelWidthInput: Ref<number | undefined> = ref(0)

onBeforeMount(() => {
  view.value = props.mode || props.base?.mode || FORM_MODE.DEFAULT
  labelWidthInput.value = props.labelWidth || props.base?.label?.width || 58
})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.value,
  (value) => {
    input.value = value
  }
)

watch(
  () => props.error,
  (value) => {
    inputError.value = value
  }
)

watch(
  () => props.data,
  (value) => {
    input.value = value?.value

    if (props.data) {
      if (value?.onCheck === 'check') {
        validation()
        props.data.onCheck = ''
      } else if (value?.onCheck === 'clear') {
        props.data.onCheck = ''
        props.data.error = ''
        inputError.value = ''
        isAutoInputDisabled.value = true
      }
      if (value?.error) {
        inputError.value = value?.error
      } else {
        inputError.value = ''
      }
    }
  },
  {
    deep: true,
  }
)

watch(
  () => props.edit,
  (value) => {
    if (value) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.base,
  (value) => {
    view.value = props.mode || props.base?.mode || FORM_MODE.DEFAULT
    labelWidthInput.value = props.labelWidth || props.base?.label?.width || 58
    if (value?.edit) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', item: string): void
  (e: 'update:error', item: string): void
  (e: 'update:autoInput', item: { key: string; code: string }): void
}>()

function onChange(e: Event) {
  const target = e.target as HTMLInputElement
  // console.log('zip', target)

  if (target) {
    input.value = target.value
    if (props.data) {
      props.data.value = target.value
    }
    validation()
    emits('update:value', target.value)
    emits('update:error', inputError.value || '')
  }
}

function onAutoInput() {
  if (input.value && props.data) {
    emits('update:autoInput', { key: props.data.name, code: input.value })
  }
}

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function onFocus() {
  focus.value = true
}
function onBlur() {
  focus.value = false
  validation()
}

//------------------------------------------------------------------------------------------------------------
// バリデーション
//------------------------------------------------------------------------------------------------------------
function includesNone(array: RULE[], elements: RULE[]) {
  // elements 配列の全ての要素が array に含まれていないか確認
  return elements.every((element) => !array.includes(element))
}

function validation() {
  if (props.data) props.data.isCheck = true

  //RULEの確認
  const rule: RULE[] = props.rule || props.data?.rule || []
  if (includesNone(rule, [RULE.zipcode, RULE.zipcode2, RULE.zipcodeBoth])) {
    rule.push(RULE.zipcodeBoth)
  }

  const res = useValidation(input.value || '', rule, result, props.data?.ruleParams)

  if (res === true) {
    inputError.value = ''
    if (props.data) props.data.error = ''
    isAutoInputDisabled.value = false
    return true
  } else {
    inputError.value = res
    if (props.data) props.data.error = res
    isAutoInputDisabled.value = true
    return false
  }
}
</script>

<style scoped>
.Input {
  position: relative;
  padding-left: 28px !important;
}

.Preview {
  position: relative;
  padding-left: 28px !important;
}

.Icon {
  position: absolute;
  top: 0px;
  left: 0px !important;
  width: 30px;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  color: rgba(var(--r-color-line));
  cursor: default !important;
  font-size: 16px;
  line-height: 16px;
  padding-top: 1px;
}

.FormEMailWrapper {
  position: relative;
  display: flex;
  justify-content: flex-start;
  align-items: flex-start;
}

.AutoButton {
  position: absolute;
  left: 140px;
}
</style>
