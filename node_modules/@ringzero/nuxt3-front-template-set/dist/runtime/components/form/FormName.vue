<template>
  <FormBase
    class="FormName"
    :base="base"
    :label="label"
    :rule="rule || data?.rule"
    :mode="mode"
    :edit="isEdit"
    :width="width || base?.width"
    :col-width="colWidth"
    :label-width="labelWidth"
    :hint="hint"
    :hintchip="hintchip"
    :result="result"
    :focus="focus"
    :small="small"
    :medium="medium"
  >
    <div class="FormInputContainer">
      <div v-if="prefix" class="Prefix">{{ prefix }}</div>
      <div
        class="FormInputContent"
        :style="{
          width: width ? width + 'px' : base?.width ? base.width + 'px' : '100%',
        }"
      >
        <div class="Flex">
          <div class="Wrap mr-3">
            <FormInput
              :edit="isEdit"
              :base="base"
              :mode="FORM_MODE.SIMPLE"
              :data="inputData[0]"
              :label="label"
              :value="input ? input[0] : ''"
              :inner-margin="'0 0 0 28px'"
              @update:value="onChangeFirst($event)"
            />
            <div
              class="Icon"
              :style="{
                color: useColor(isDark() ? THEME_COLOR.guide : THEME_COLOR.line),
              }"
            >
              {{ kana ? 'ｾｲ' : '姓' }}
            </div>
          </div>
          <div class="Wrap">
            <FormInput
              :edit="isEdit"
              :base="base"
              :mode="FORM_MODE.SIMPLE"
              :data="inputData[1]"
              :label="label"
              :value="input ? input[1] : ''"
              :inner-margin="'0 0 0 28px'"
              @update:value="onChangeLast($event)"
            />

            <div
              class="Icon"
              :style="{
                color: useColor(isDark() ? THEME_COLOR.guide : THEME_COLOR.line),
              }"
            >
              {{ kana ? 'ﾒｲ' : '名' }}
            </div>
          </div>
        </div>
      </div>
      <div v-if="suffix" class="Suffix">{{ suffix }}</div>
    </div>
  </FormBase>
</template>

<script setup lang="ts">
/**===================================================================================================================
   * InputText(文字列一行入力)
   ===================================================================================================================**/
import { FORM_MODE, type formProps, type formItem } from '../../components/common'
import { RULE } from '../../composables/validation'
import { THEME_COLOR } from '../../composables/constants'
import { isDark, useColor } from '../../composables/colors'
import { ref, watch, type Ref, onMounted } from 'vue'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props extends formProps {
  rule?: any
  value?: string[]
  kana?: boolean
}

const props = withDefaults(defineProps<Props>(), {})
//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const input: Ref<string[] | undefined> = ref(props.data?.values || props.value || [])
const inputError: Ref<string | undefined> = ref(props.error)
const inputData: Ref<formItem[]> = ref([])
const result: Ref<string | undefined> = ref()
const focus = ref(false)
const isEdit = ref(props.edit || props.base?.edit)
//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
onMounted(() => {
  if (props.data) {
    inputData.value[0] = JSON.parse(JSON.stringify(props.data))
    inputData.value[1] = JSON.parse(JSON.stringify(props.data))
    inputData.value[0].name = props.data.name + '_last_name'
    inputData.value[1].name = props.data.name + '_first_name'
    if (props.data.values) {
      inputData.value[0].value = props.data.values[0]
      inputData.value[1].value = props.data.values[1]
      if (input.value) {
        input.value[0] = props.data.values[0]
        input.value[1] = props.data.values[1]
      }
    }
  } else {
    inputData.value[0] = { name: 'last_name', label: '', type: FORM_ITEM.INPUT, hint: '' }
    inputData.value[1] = { name: 'first_name', label: '', type: FORM_ITEM.INPUT, hint: '' }
    if (props.value) {
      inputData.value[0].value = props.value[0]
      inputData.value[1].value = props.value[1]
      if (input.value) {
        input.value[0] = props.value[0]
        input.value[1] = props.value[1]
      }
    }
  }

  inputData.value[0].onCheck = ''
  inputData.value[0].error = ''
  inputData.value[1].onCheck = ''
  inputData.value[1].error = ''
  if (props.kana) {
    const rule: RULE[] = props.rule || props.data?.rule || []
    if (!rule.includes(RULE.katakana)) {
      rule.push(RULE.katakana)
    }
    inputData.value[0].rule = rule
    inputData.value[1].rule = rule
  }
  console.log(input.value)
  console.log(inputData.value)
})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.value,
  (value) => {
    if (value && input.value) {
      input.value[0] = inputData.value[0].value = value[0]
      input.value[1] = inputData.value[1].value = value[1]
    }
  }
)

watch(
  () => props.error,
  (value) => {
    inputError.value = value
  }
)

watch(
  () => props.data,
  (value) => {
    if (value && value.values && input.value) {
      input.value[0] = inputData.value[0].value = value.values[0]
      input.value[1] = inputData.value[1].value = value.values[1]
    }
    if (props.data) {
      if (value?.onCheck === 'check') {
        inputData.value[0].onCheck = 'check'
        inputData.value[1].onCheck = 'check'
        props.data.onCheck = ''
      } else if (value?.onCheck === 'clear') {
        inputData.value[0].onCheck = 'clear'
        inputData.value[1].onCheck = 'clear'
        props.data.onCheck = ''
        props.data.error = ''
        inputError.value = ''
      }
      if (value?.error) {
        inputError.value = value?.error
      } else {
        inputError.value = ''
      }
    }
  },
  {
    deep: true,
  }
)

watch(
  () => props.edit,
  (value) => {
    if (value) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.base,
  (value) => {
    if (value?.edit) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', value: string[]): void
  (e: 'update:error', value: string): void
}>()

function onChangeFirst(value: any) {
  console.log(input.value, props.data)
  if (input.value) {
    input.value[0] = value
  } else {
    input.value = []
    input.value[0] = value
  }
  if (props.data) {
    if (props.data.values) {
      props.data.values[0] = value
    } else {
      props.data.values = []
      props.data.values[0] = value
    }
    validation()
    emits('update:value', props.data.values)
    emits('update:error', inputError.value || '')
  }
}

function onChangeLast(value: any) {
  console.log(input.value, props.data)
  if (input.value) {
    input.value[1] = value
  } else {
    input.value = []
    input.value[1] = value
  }
  if (props.data) {
    if (props.data.values) {
      props.data.values[1] = value
    } else {
      props.data.values = []
      props.data.values[1] = value
    }
    validation()
    props.data.values[1] = value
    emits('update:value', props.data.values)
    emits('update:error', inputError.value || '')
  }
}

//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------

//------------------------------------------------------------------------------------------------------------
// バリデーション
//------------------------------------------------------------------------------------------------------------

function validation() {
  if (props.data && props.data.values && inputData.value) {
    props.data.error = inputData.value[0].error || inputData.value[1].error
    // console.log(inputData.value[0].error, inputData.value[1].error)
    props.data.isCheck = inputData.value[0].isCheck && inputData.value[1].isCheck
  }
}
</script>

<style scoped>
.Input {
  position: relative;
  padding-left: 28px !important;
}

.Preview {
  position: relative;
  padding-left: 28px !important;
}

.Wrap {
  position: relative;
  width: calc((100% - 12px) / 2);
}

.Icon {
  position: absolute;
  top: 0px;
  left: 0px !important;
  width: 30px;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  color: rgba(var(--r-color-line));
  cursor: default !important;
  font-size: 12px;
  padding-top: 1px;
}

.Flex {
  position: relative;
  display: flex;
  align-items: center;
}
</style>
