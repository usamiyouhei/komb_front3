<template>
  <div
    class="FormBase"
    :class="{
      ColWidth: (base?.column === 2 || base?.column === 3) && props.colWidth,
      ColAll:
        (base?.column !== 2 && base?.column !== 3 && props.colWidth === '100%') ||
        (base?.column !== 2 && base?.column !== 3 && !props.colWidth),
      Column2: base?.column === 2,
      Column3: base?.column === 3,
    }"
    :style="{ width: BaseWidth }"
  >
    <div :class="BaseClass">
      <FormLabel
        v-if="(base || label) && view !== FORM_MODE.SIMPLE"
        :label="label || base?.label?.text"
        :required="rule?.includes(RULE.required)"
        :align="base?.label?.align"
        :margin="base?.label?.margin"
        :size="base?.label?.size"
        :width="labelWidth || base?.label?.width"
        :innerWidth="base?.label?.innerWidth"
        :weight="base?.label?.weight"
        :hint="hint"
        :hintchip="hintchip"
        :error="inputError"
        :mode="view"
        :edit="isEdit"
        :small="base?.small || small"
        :medium="base?.medium || medium"
        :color="base?.label?.color"
      />
      <slot />
      <div
        v-if="isEdit && (view === FORM_MODE.INLINE || view === FORM_MODE.SIMPLE) && (result || hint || inputError)"
        class="hint inlineHint"
        :class="{ focus: focus, line: line }"
      >
        <div v-if="inputError" class="text error">{{ inputError }}</div>
        <div v-else-if="result" class="text">{{ result }}</div>
        <div v-else-if="hint" class="text">{{ hint }}</div>
      </div>
    </div>
    <div
      v-if="view === FORM_MODE.BOTH || view === FORM_MODE.DEFAULT"
      class="bothHint"
      :style="{
        //marginLeft: base?.label?.width + 'px'
      }"
    >
      <div v-if="isEdit && (result || hint || inputError)" class="hint">
        <div v-if="inputError" class="text error">{{ inputError }}</div>
        <div v-else-if="result" class="text">{{ result }}</div>
        <div v-else-if="hint" class="text">{{ hint }}</div>
      </div>
    </div>
    <div
      :style="{
        marginLeft:
          view === FORM_MODE.SIMPLE || view === FORM_MODE.DEFAULT
            ? undefined
            : base?.label?.width
              ? base?.label?.width + 10 + 'px'
              : undefined,
      }"
    >
      <slot name="extra" />
    </div>
  </div>
</template>

<script setup lang="ts">
import { type formProps, type baseProps, FORM_MODE } from '../../components/common'
import { ref, watch, onBeforeMount, type Ref } from 'vue'
import { RULE } from '../../composables/validation'

/** フォームラベル */

interface props extends formProps {
  result?: string //入力値の数を数えたり、電話番号、郵便番号をハイフン付に加工したり、別フォーマットに置き換えた結果の表示等に使用
  focus?: boolean
}

const props = withDefaults(defineProps<props>(), {
  line: true,
})

//------------------------------------------------------------------------------------------------------------
// ライフサイクル
//------------------------------------------------------------------------------------------------------------
const status: Ref<baseProps | undefined> = ref(props.base)
const view = ref('')
const isEdit = ref(props.edit || props.base?.edit)
const BaseClass = ref('')
const BaseWidth: Ref<string | undefined> = ref()
const inputError = ref(props.error)
onBeforeMount(() => {
  BaseClass.value = props.mode || props.base?.mode || FORM_MODE.DEFAULT
  view.value = props.mode || props.base?.mode || FORM_MODE.DEFAULT
  const labelW = props.base?.label.width || 100
  if (props.colWidth && (props.base?.column === 2 || props.base?.column === 3)) {
    if (props.colWidth === '100%') {
      document.documentElement.style.setProperty('--ColWidth', props.colWidth)
      document.documentElement.style.setProperty('--paddingWidth', '0px')
    } else {
      document.documentElement.style.setProperty('--ColWidth', props.colWidth)
      document.documentElement.style.setProperty('--paddingWidth', '20px')
    }
  } else if (props.width) {
    if (view.value === FORM_MODE.INLINE || view.value === FORM_MODE.BOTH) {
      BaseWidth.value = props.width + labelW + 10 + 'px'
    } else {
      BaseWidth.value = props.width + 'px'
    }
  }

  if (props.base?.edit) {
    isEdit.value = props.base?.edit
  } else if (props.edit) {
    isEdit.value = props.edit
  }
})

//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.edit,
  (value) => {
    if (value) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.base,
  (value) => {
    if (value?.edit) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.error,
  (value) => {
    inputError.value = value
  }
)
</script>

<style scoped>
.FormBase {
  position: relative;
}

.simple {
  display: flex;
  align-items: flex-start;
}

.inline {
  position: relative;
  display: flex;
  align-items: flex-start;
}

.both {
  display: flex;
  align-items: flex-start;
}

.inlineHint {
  display: flex;
  align-items: flex-start;
}

.bothHint {
  position: relative;
  top: 2px;
  right: 10px;
  height: 18px;
  display: flex;
  justify-content: flex-end;
}
.bothHint .hint {
  position: absolute;
  bottom: initial;
  top: 0;
  right: 6px;
  width: initial;
  background-color: transparent;
}

.default {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: flex-start;
}
</style>
