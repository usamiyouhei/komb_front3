<template>
  <FormBase
    class="FormSelectMenu"
    :base="base"
    :label="label"
    :rule="rule || data?.rule"
    :mode="mode"
    :edit="isEdit"
    :width="width"
    :col-width="colWidth"
    :label-width="labelWidth"
    :hint="hint"
    :hintchip="hintchip"
    :error="inputError"
    :result="result"
    :focus="focus"
    :line="false"
    :small="small"
    :medium="medium"
  >
    <div class="Time">
      <PartsSelectMenu
        :value="hour"
        :inputType="inputType"
        :selectType="selectType"
        :items="hourTime"
        :height="150"
        :disabled="!isEdit"
        fit
        @update:value="onHourChange($event)"
      />
      <div v-if="minuteTime" class="Colon">:</div>
      <PartsSelectMenu
        v-if="minuteTime"
        :value="minute"
        :inputType="inputType"
        :selectType="selectType"
        :items="minuteTime"
        :height="150"
        :disabled="!isEdit"
        fit
        @update:value="onMinuteChange($event)"
      />
      <div v-if="secondTime" class="Colon">:</div>
      <PartsSelectMenu
        v-if="secondTime"
        :value="second"
        :inputType="inputType"
        :selectType="selectType"
        :items="secondTime"
        :height="150"
        :disabled="!isEdit"
        fit
        @update:value="onSecondChange($event)"
      />
    </div>
  </FormBase>
</template>

<script setup lang="ts">
/**===================================================================================================================
   *
  ===================================================================================================================**/
import { SELECT_INPUT_TYPE, SELECT_LIST_TYPE, type formProps } from '../../components/common'
import { RULE, useValidation } from '../../composables/validation'
import { ref, watch, type Ref } from 'vue'
//------------------------------------------------------------------------------------------------------------
// 引数
//------------------------------------------------------------------------------------------------------------
interface Props extends formProps {
  time?: any[] | undefined
  value?: string | number
  inputType?: SELECT_INPUT_TYPE
  selectType?: SELECT_LIST_TYPE
  height?: number
  color?: string
  rule?: any
}

const props = withDefaults(defineProps<Props>(), {
  inputType: SELECT_INPUT_TYPE.FRAME,
  selectType: SELECT_LIST_TYPE.DEFAULT,
})

//------------------------------------------------------------------------------------------------------------
// 定数・変数（state）
//------------------------------------------------------------------------------------------------------------
const hourTime = ref(props.time ? props.time[0] : undefined)
const minuteTime: Ref<any[] | undefined> = ref(props.time ? props.time[1] : undefined)
const secondTime: Ref<any[] | undefined> = ref(props.time ? props.time[2] : undefined)
const hour: Ref<string | undefined> = ref('00')
const minute: Ref<string | undefined> = ref('00')
const second: Ref<string | undefined> = ref('00')
const input: Ref<string> = ref(`${hour.value}:${minute.value}:${second.value}`)
const inputError: Ref<string | undefined> = ref(props.error)
const result: Ref<string | undefined> = ref()
const focus = ref(false)
const isEdit = ref(props.edit || props.base?.edit)
//------------------------------------------------------------------------------------------------------------
//watch
//------------------------------------------------------------------------------------------------------------
watch(
  () => props.value,
  (value) => {
    // 初期化
    hour.value = '00'
    minute.value = '00'
    second.value = '00'

    if (value) {
      const timeParts = value.toString().split(':')
      hour.value = timeParts[0]
      minute.value = timeParts[1]
      second.value = timeParts[2]
      input.value = `${hour.value}:${minute.value}:${second.value}`
    }
  }
)

watch(
  () => props.error,
  (value) => {
    inputError.value = value
  }
)

watch(
  () => props.data,
  (value) => {
    // 初期化
    hour.value = '00'
    minute.value = '00'
    second.value = '00'

    if (value?.value) {
      const timeParts = value.value.toString().split(':')
      hour.value = timeParts[0]
      minute.value = timeParts[1]
      second.value = timeParts[2]
      input.value = `${hour.value}:${minute.value}:${second.value}`
    }
    if (props.data) {
      if (value?.onCheck === 'check') {
        validation()
        props.data.onCheck = ''
      } else if (value?.onCheck === 'clear') {
        props.data.onCheck = ''
        props.data.error = ''
        inputError.value = ''
      }
      if (value?.error) {
        inputError.value = value?.error
      } else {
        inputError.value = ''
      }
    }
  },
  {
    deep: true,
  }
)

watch(
  () => props.edit,
  (value) => {
    if (value) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)

watch(
  () => props.base,
  (value) => {
    if (value?.edit) {
      isEdit.value = true
    } else {
      isEdit.value = false
    }
  }
)
//------------------------------------------------------------------------------------------------------------
// エミット
//------------------------------------------------------------------------------------------------------------
const emits = defineEmits<{
  (e: 'update:value', value: string): void
  (e: 'update:error', value: string): void
}>()

function onHourChange(value: string) {
  if (value) {
    hour.value = value
    input.value = `${hour.value}:${minute.value}:${second.value}`
    if (props.data) {
      props.data.value = input.value
    }
    validation()
    emits('update:value', input.value)
    emits('update:error', inputError.value || '')
  }
}

function onMinuteChange(value: string) {
  if (value) {
    minute.value = value
    input.value = `${hour.value}:${minute.value}:${second.value}`
    if (props.data) {
      props.data.value = input.value
    }
    validation()
    emits('update:value', input.value)
    emits('update:error', inputError.value || '')
  }
}

function onSecondChange(value: string) {
  if (value) {
    second.value = value
    input.value = `${hour.value}:${minute.value}:${second.value}`
    if (props.data) {
      props.data.value = input.value
    }
    validation()
    emits('update:value', input.value)
    emits('update:error', inputError.value || '')
  }
}
//------------------------------------------------------------------------------------------------------------
// メソッド
//------------------------------------------------------------------------------------------------------------
function onFocus() {
  focus.value = true
}

function onBlur() {
  focus.value = false
}
//------------------------------------------------------------------------------------------------------------
// バリデーション
//------------------------------------------------------------------------------------------------------------
function validation() {
  if (props.data) props.data.isCheck = true
  const rule: RULE[] = props.rule || props.data?.rule || []
  if (!rule.includes(RULE.selecttime)) {
    rule.push(RULE.selecttime)
  }

  const res = useValidation(String(input.value), rule, result, props.data?.ruleParams)
  if (res === true) {
    inputError.value = ''
    if (props.data) props.data.error = ''
    return true
  } else {
    if (!rule.includes(RULE.required)) {
      const timeParts = input.value.toString().split(':')
      if (hourTime.value !== undefined && minuteTime.value !== undefined && secondTime.value !== undefined) {
        if (timeParts[0].length === 2 && timeParts[1].length === 2 && timeParts[2].length === 2) {
          inputError.value = ''
          if (props.data) props.data.error = ''
          return true
        } else if (timeParts[0].length === 1 && timeParts[1].length === 1 && timeParts[2].length === 1) {
          inputError.value = ''
          if (props.data) props.data.error = ''
          return true
        } else {
          inputError.value = res
          if (props.data) props.data.error = res
          return false
        }
      } else if (hourTime.value !== undefined && minuteTime.value !== undefined) {
        if (timeParts[0].length === 2 && timeParts[1].length === 2) {
          const hour = parseInt(timeParts[0], 10)
          const minute = parseInt(timeParts[1], 10)
          if (!isNaN(hour) && !isNaN(minute)) {
            inputError.value = ''
            if (props.data) props.data.error = ''
            return true
          } else {
            inputError.value = res
            if (props.data) props.data.error = res
            return false
          }
        } else if (timeParts[0].length === 1 && timeParts[1].length === 1) {
          inputError.value = ''
          if (props.data) props.data.error = ''
          return true
        } else {
          inputError.value = res
          if (props.data) props.data.error = res
          return false
        }
      } else if (hourTime.value !== undefined) {
        if (timeParts[0].length === 2) {
          inputError.value = ''
          if (props.data) props.data.error = ''
          return true
        } else if (timeParts[0].length === 1) {
          inputError.value = ''
          if (props.data) props.data.error = ''
          return true
        } else {
          inputError.value = res
          if (props.data) props.data.error = res
          return false
        }
      }
    } else {
      inputError.value = res
      if (props.data) props.data.error = res
      return false
    }
  }
}
</script>

<style scoped>
.Time {
  display: flex;
}

.Colon {
  margin: 2px 3px;
  font-size: 20px;
}
</style>
